

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØªÙˆÙƒÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª (Ù†Ø³Ø®Ø© Ù…Ø·ÙˆØ±Ø©)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; scroll-behavior: smooth; }
        #app-container {
            position: relative;
            z-index: 1;
            background-color: rgba(248, 250, 252, 0.9);
        }
        #app-container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://j.top4top.io/p_34699hezn1.jpeg');
            background-size: cover;
            background-position: center;
            opacity: 0.1;
            z-index: -1;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center;}
        .modal-content { position: relative; background-color: #fefefe; margin: auto; padding: 2rem; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 0.5rem; animation: fadeIn 0.3s; }
        
        #invoiceModal .modal-content, #statementModal .modal-content {
             width: 95%;
             max-width: 95%;
             height: 95%;
             display: flex;
             flex-direction: column;
        }
        #invoiceContent, #statementContent {
            flex-grow: 1;
            overflow-y: auto; 
            padding: 1.5rem;
            background-color: #fff;
        }
        
        @keyframes fadeIn { from {opacity: 0; transform: scale(0.95);} to {opacity: 1; transform: scale(1);} }
        .close-button { color: #aaa; float: left; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #2d3748; color: white; padding: 15px; border-radius: 5px; z-index: 100; opacity: 0; transition: all 0.5s; visibility: hidden; }
        .toast.show { opacity: 1; visibility: visible; }
        
        .toast.success{background:#16a34a;}
        .toast.error{background:#dc2626;}
        .toast.warning{background:#d97706;}
        .toast.info{background:#2563eb;}
.search-container { position: relative; }
        .search-icon { position: absolute; top: 50%; right: 1rem; transform: translateY(-50%); color: #9ca3af; }
        .overdue { background-color: #fee2e2 !important; }
        .aging-warning { background-color: #fef9c3 !important; }
        .aging-danger { background-color: #fee2e2 !important; }
        .maintenance-expense { background-color: #fff7ed !important; } /* Orange-50 */
        .tab-link { transition: all 0.2s ease-in-out; border-bottom: 4px solid transparent; padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .tab-link:hover { background-color: #f1f5f9; color: #1d4ed8; }
        .tab-link.active { border-bottom-color: #2563eb; color: #1d4ed8; background-color: #eff6ff; }
        .export-btn-excel { background-color: #166534; } .export-btn-excel:hover { background-color: #14532d; }
        .print-area { background-color: white; color: black; }
        
        #password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://b.top4top.io/p_3468gmodo1.jpeg');
            background-size: cover;
            background-position: center;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #password-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(17, 24, 39, 0.7);
            z-index: -1;
        }

        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                border: none;
            }
        }
        
        @media screen and (max-width: 1023px) {
            .tab-link {
                width: 100%;
                text-align: right;
                padding-right: 1.5rem;
                padding-left: 1.5rem;
                border-right: 4px solid transparent;
                border-bottom: 1px solid #e5e7eb;
            }
            .tab-link.active {
                border-right-color: #2563eb;
                border-bottom-color: transparent;
            }
            #nav-links-container {
                align-items: stretch;
            }
        }

        @media screen and (max-width: 768px) {
            table {
                border: 0;
            }
            table thead {
                display: none;
            }
            table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #ddd;
                border-radius: 0.5rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                overflow: hidden;
            }
            table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 1rem;
                text-align: right;
                border-bottom: 1px solid #eee;
            }
            table td:last-child {
                border-bottom: 0;
            }
            table td::before {
                content: attr(data-label);
                font-weight: bold;
                text-align: left;
                padding-left: 1rem;
            }
        }
    
        :root{
            --bg1:#0b1220;
            --bg2:#0f172a;
            --card:#ffffff;
            --card2: rgba(255,255,255,.72);
            --border: rgba(15,23,42,.08);
            --text:#0f172a;
            --muted:#64748b;
            --brand1:#2563eb;
            --brand2:#7c3aed;
            --ring: rgba(37,99,235,.25);
        }
        body{
            background: radial-gradient(1200px 700px at 90% -10%, rgba(124,58,237,.18), transparent 55%),
                        radial-gradient(1000px 600px at 10% 0%, rgba(37,99,235,.18), transparent 55%),
                        linear-gradient(180deg, #f8fafc 0%, #eef2ff 45%, #f8fafc 100%);
            color: var(--text);
        }
        /* App shell feel like the firebase demo */
        #main-nav{
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255,255,255,.82) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border) !important;
        }
        .tab-link{
            margin: .25rem .15rem;
            padding: .65rem 1rem !important;
            border-radius: 999px;
            transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease, color .12s ease;
            border: 1px solid transparent;
        }
        .tab-link:hover{
            transform: translateY(-1px);
            background: rgba(37,99,235,.08);
            border-color: rgba(37,99,235,.18);
            color: #1d4ed8 !important;
        }
        .tab-link.active{
            background: linear-gradient(90deg, var(--brand1), var(--brand2));
            color: #fff !important;
            box-shadow: 0 10px 25px rgba(37,99,235,.22);
            border-color: rgba(255,255,255,.25);
        }
        /* Cards / panels */
        .stat-card, .card, .panel, .modal-content, .bg-white.rounded-lg, .bg-white.rounded-xl{
            border-radius: 18px !important;
        }
        .stat-card, .bg-white, .modal-content{
            box-shadow: 0 10px 30px rgba(2,6,23,.06);
            border: 1px solid var(--border);
        }
        /* Inputs */
        input, select, textarea{
            border-radius: 12px !important;
            border-color: rgba(15,23,42,.12) !important;
            transition: box-shadow .12s ease, border-color .12s ease, transform .12s ease;
        }
        input:focus, select:focus, textarea:focus{
            outline: none !important;
            border-color: rgba(37,99,235,.45) !important;
            box-shadow: 0 0 0 4px var(--ring) !important;
        }
        button{
            border-radius: 12px;
        }
        /* Tables */
        table{
            border-collapse: separate !important;
            border-spacing: 0 !important;
            overflow: hidden;
            border-radius: 16px;
        }
        thead th{
            position: sticky;
            top: 0;
            background: rgba(248,250,252,.95);
            backdrop-filter: blur(6px);
        }
        tbody tr:nth-child(even){
            background: rgba(2,6,23,.02);
        }
        tbody tr:hover{
            background: rgba(37,99,235,.06);
        }
        /* Modals */
        .modal{
            background: rgba(2,6,23,.55) !important;
        }
        /* Small nice scrollbar */
        ::-webkit-scrollbar{width:10px;height:10px}
        ::-webkit-scrollbar-thumb{background:rgba(100,116,139,.35);border-radius:999px}
        ::-webkit-scrollbar-thumb:hover{background:rgba(100,116,139,.55)}

</style>
</head>
<body class="bg-gray-50 text-gray-800">

<div id="app-container">
        <header class="bg-white shadow-md sticky top-0 z-40 no-print">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <img src="https://f.top4top.io/p_34699p7z31.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" class="h-12 sm:h-16">
                    <div>
                        <h1 class="text-xl sm:text-3xl font-bold text-blue-800">Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØªÙˆÙƒÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</h1>
                        <p class="text-center text-sm text-gray-600">Ø¥Ø¯Ø§Ø±Ø©: Ø§Ù„Ø­Ø§Ø¬ Ø§Ù„Ø³ÙŠØ¯ Ø²ÙŠØ§Ù† Ø´Ø§Ù…ÙŠØ© ÙˆØ§Ø¨Ùˆ Ø²ÙŠØ§Ø¯</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 sm:gap-6">
                    <div class="text-left hidden sm:block">
                        <p class="text-sm text-gray-700">Ù…Ø±Ø­Ø¨Ø§Ù‹, <strong id="current-user-name" class="text-blue-700"></strong></p>
                        <p id="live-clock" class="text-xs text-gray-500 mt-1"></p>
                        <button onclick="logout()" class="mt-2 bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded-full shadow">Ø®Ø±ÙˆØ¬</button>
                    </div>
                    <div class="relative">
                        <button onclick="toggleNotifications()" class="relative text-gray-600 hover:text-blue-700 focus:outline-none">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            <span id="notification-count" class="absolute top-0 right-0 block h-5 w-5 rounded-full bg-red-600 text-white text-xs flex items-center justify-center" style="display: none;">0</span>
                        </button>
                        <div id="notification-dropdown" class="absolute left-0 mt-2 w-80 bg-white rounded-lg shadow-xl overflow-hidden z-50" style="display: none;">
                            <div class="py-2 px-4 bg-gray-100 font-bold text-gray-800">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
                            <div id="notification-list" class="divide-y max-h-96 overflow-y-auto"></div>
                        </div>
                    </div>
                    <button id="menu-toggle-btn" class="lg:hidden text-gray-600 hover:text-blue-700">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </div>
            <nav id="main-nav" class="bg-white border-b-2 border-gray-200">
                <div id="nav-links-container" class="container mx-auto hidden lg:flex justify-center items-center flex-wrap">
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'dashboard')" data-tab="dashboard">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'inventory')" data-tab="inventory">Ø¬Ø±Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'purchases')" data-tab="purchases">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'sales')" data-tab="sales">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'contracts')" data-tab="contracts">Ø§Ù„Ø¹Ù‚ÙˆØ¯</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'quotes')" data-tab="quotes">Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'installments')" data-tab="installments">Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'custody')" data-tab="custody">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙÙ‡Ø¯</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'maintenance')" data-tab="maintenance">Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'reports')" data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'clients')" data-tab="clients">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'expenses')" data-tab="expenses">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'archive')" data-tab="archive">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'treasury')" data-tab="treasury">Ø§Ù„Ø®Ø²Ù†Ø©</button>
                    <button class="tab-link text-gray-600 px-4 font-semibold" onclick="openTab(event, 'activityLog')" data-tab="activityLog">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·</button>
                    <button id="settings-btn" class="tab-link text-gray-600 px-4 font-semibold" onclick="openSettingsModal()" style="display: none;">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                    
                    <div class="w-full lg:hidden border-t border-gray-200 mt-2 pt-4 px-4 space-y-4">
                        <div class="text-right">
                             <p class="text-sm text-gray-700">Ù…Ø±Ø­Ø¨Ø§Ù‹, <strong id="current-user-name-mobile" class="text-blue-700"></strong></p>
                             <p id="live-clock-mobile" class="text-xs text-gray-500 mt-1"></p>
                        </div>
                        <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow">
                            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <main class="container mx-auto p-4 md:p-6">
            <div class="mb-6 search-container no-print">
                <input type="text" id="globalSearch" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…..." class="w-full p-3 pr-12 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                <svg class="search-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            
            <div id="dashboard" class="tab-content">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="stat-card bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-500">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                        <p id="db-stock-value" class="text-3xl font-bold text-blue-600 mt-2">0 Ø¬.Ù….</p>
                    </div>
                    <div class="stat-card bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h3>
                        <p id="db-total-profits" class="text-3xl font-bold text-green-600 mt-2">0 Ø¬.Ù….</p>
                    </div>
                    <div class="stat-card bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-500">Ø±ØµÙŠØ¯ Ø§Ù„Ø®Ø²Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                        <p id="db-balance" class="text-3xl font-bold text-indigo-600 mt-2">0 Ø¬.Ù….</p>
                    </div>
                    <div class="stat-card bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-500">Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h3>
                        <p id="db-supplier-dues" class="text-3xl font-bold text-red-600 mt-2">0 Ø¬.Ù….</p>
                    </div>
                </div>

                <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold mb-4">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù‡Ø§Ù…Ø©</h3>
                        <div id="upcoming-alerts" class="space-y-3">
                            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold mb-4">Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                        <div class="space-y-3" id="recent-activities"></div>
                    </div>
                </div>
                
                <div class="mt-8 grid grid-cols-1">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold mb-4">ÙˆØµÙˆÙ„ Ø³Ø±ÙŠØ¹</h3>
                        <div class="flex flex-wrap gap-4 justify-center">
                            <button onclick="openModal('addPurchaseModal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-transform">ØªØ³Ø¬ÙŠÙ„ Ø³ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© +</button>
                            <button onclick="openModal('addSaleModal')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-transform">ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ +</button>
                            <button onclick="openModal('addExpenseModal')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform hover:scale-105 transition-transform">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ +</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="inventory" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Ø¬Ø±Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h2>
                    <div class="no-print flex-shrink-0">
                        <button onclick="exportTable('inventory-table', 'ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø¬Ø±Ø¯')" class="export-btn-excel text-white font-bold py-2 px-4 rounded-lg shadow ml-2">ØªØµØ¯ÙŠØ± Excel</button>
                        <button onclick="printContent('inventory-table-container')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow ml-2">Ø·Ø¨Ø§Ø¹Ø©</button>
                    </div>
                </div>
                <div id="inventory-table-container" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto print-area">
                    <h2 class="text-2xl font-bold text-center mb-4 hidden print:block">ØªÙ‚Ø±ÙŠØ± Ø¬Ø±Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h2>
                    <table class="w-full text-center" id="inventory-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù</th><th class="p-3">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th class="p-3">Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹</th><th class="p-3">Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡</th><th class="p-3">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</th><th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="p-3 no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="purchases" class="tab-content">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-700">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
                    <div class="flex items-center gap-4 no-print">
                        <select id="purchase-year-filter" class="p-2 border rounded-lg bg-white"></select>
                        <select id="purchase-month-filter" class="p-2 border rounded-lg bg-white"></select>
                    </div>
                    <div class="no-print flex-shrink-0">
                        <button onclick="exportTable('purchases-table', 'ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª')" class="export-btn-excel text-white font-bold py-2 px-4 rounded-lg shadow ml-2">ØªØµØ¯ÙŠØ± Excel</button>
                        <button onclick="openModal('addPurchaseModal')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow ml-2">+ ØªØ³Ø¬ÙŠÙ„ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                </div>
                <div id="purchases-table-container" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto print-area">
                    <h2 class="text-2xl font-bold text-center mb-4 hidden print:block">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
                    <table class="w-full text-center" id="purchases-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-3">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th class="p-3">Ø§Ù„Ù…ÙˆØ±Ø¯</th><th class="p-3">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th class="p-3">Ø£Ø¶ÙŠÙ Ø¨ÙˆØ§Ø³Ø·Ø©</th><th class="p-3 no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="sales" class="tab-content">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-700">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
                    <div class="flex items-center gap-4 no-print">
                        <select id="sale-year-filter" class="p-2 border rounded-lg bg-white"></select>
                        <select id="sale-month-filter" class="p-2 border rounded-lg bg-white"></select>
                    </div>
                    <div class="no-print flex-shrink-0">
                        <button onclick="exportTable('sales-table', 'ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª')" class="export-btn-excel text-white font-bold py-2 px-4 rounded-lg shadow ml-2">ØªØµØ¯ÙŠØ± Excel</button>
                        <button onclick="openModal('addSaleModal')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow ml-2">+ ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ¹</button>
                    </div>
                </div>
                <div id="sales-table-container" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto print-area">
                    <h2 class="text-2xl font-bold text-center mb-4 hidden print:block">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
                    <table class="w-full text-center" id="sales-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-3">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th class="p-3">Ø§Ù„Ù…Ø´ØªØ±ÙŠ</th><th class="p-3">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th class="p-3">Ø§Ù„Ø±Ø¨Ø­</th><th class="p-3">Ø£Ø¶ÙŠÙ Ø¨ÙˆØ§Ø³Ø·Ø©</th><th class="p-3 no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div id="quotes" class="tab-content">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-700">Ø³Ø¬Ù„ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h2>
                    <div class="no-print flex-shrink-0">
                        <button onclick="exportTable('quotes-table', 'ØªÙ‚Ø±ÙŠØ±-Ø¹Ø±ÙˆØ¶-Ø§Ù„Ø§Ø³Ø¹Ø§Ø±')" class="export-btn-excel text-white font-bold py-2 px-4 rounded-lg shadow ml-2">ØªØµØ¯ÙŠØ± Excel</button>
                        <button onclick="openAddQuoteModal()" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg shadow ml-2">+ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø³Ø¹Ø± ÙŠØ¯ÙˆÙŠ</button>
                    </div>
                </div>
                <div id="quotes-table-container" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto print-area">
                    <table class="w-full text-center" id="quotes-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶</th><th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="p-3">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th class="p-3">Ø§Ù„Ø³Ø¹Ø±</th><th class="p-3">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="p-3 no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="installments" class="tab-content">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</h2>
                <div class="flex justify-between items-start mb-4">
                    <div class="bg-white p-4 rounded-lg shadow-md flex-grow">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div><h4 class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</h4><p id="inst-total-due" class="text-2xl font-bold text-red-600">0 Ø¬.Ù….</p></div>
                            <div><h4 class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©</h4><p id="inst-total-paid" class="text-2xl font-bold text-green-600">0 Ø¬.Ù….</p></div>
                            <div><h4 class="text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</h4><p id="inst-total-remaining" class="text-2xl font-bold text-orange-500">0 Ø¬.Ù….</p></div>
                        </div>
                    </div>
                    <div class="no-print ml-4 flex-shrink-0">
                        <button onclick="exportTable('installments-table', 'ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø£Ù‚Ø³Ø§Ø·')" class="export-btn-excel text-white font-bold py-2 px-4 rounded-lg shadow w-full">ØªØµØ¯ÙŠØ± Excel</button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md mb-6 no-print">
                    <h3 class="text-lg font-bold mb-2">ÙÙ„ØªØ±Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</h3>
                    <div class="flex items-end gap-4">
                        <div class="flex-grow"><label>Ø¹Ø±Ø¶ Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø¹Ù…ÙŠÙ„</label><select id="inst-customer-filter" class="w-full p-2 border rounded"><option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option></select></div>
                        <button id="print-statement-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨</button>
                    </div>
                </div>
                <div id="installments-table-container" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto print-area">
                    <h2 class="text-2xl font-bold text-center mb-4 hidden print:block">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</h2>
                    <table class="w-full text-center" id="installments-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="p-3">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th class="p-3">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th class="p-3">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·</th><th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="p-3 no-print">Ø¥Ø¬Ø±Ø§Ø¡</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>


            <!-- ===================== CUSTODY ===================== -->
            <div id="custody" class="tab-content" style="display:none;">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙÙ‡Ø¯</h2>
                        <p class="text-sm text-gray-500 mt-1">ØªØ³Ø¬ÙŠÙ„ Ø¹Ù‡Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†ØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚ ÙˆØ§Ù„Ù…Ø³ÙˆÙŠÙ‘ØŒ ÙˆØ¥Ø±ÙØ§Ù‚ Ù…Ø³ØªÙ†Ø¯Ø§Øª.</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="btn-primary flex items-center gap-2" onclick="openModal('custodyModal')">
                            <span class="text-lg">+</span> ØµØ±Ù Ø¹ÙÙ‡Ø¯Ø©
                        </button>
                        <button class="btn-secondary" onclick="exportCustodyCSV()">ØªØµØ¯ÙŠØ± CSV</button>
                        <button class="btn-outline" onclick="printSection('custody')">Ø·Ø¨Ø§Ø¹Ø©</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                    <div class="card p-4 border-l-4 border-orange-500">
                        <p class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹ÙÙ‡Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚Ø©</p>
                        <p class="text-2xl font-extrabold text-orange-600" id="custodyTotalOpen">0</p>
                    </div>
                    <div class="card p-4 border-l-4 border-green-500">
                        <p class="text-sm text-gray-500">ØªÙ… ØªØ³ÙˆÙŠØªÙ‡Ø§ (Ø£Ø±Ø´ÙŠÙ)</p>
                        <p class="text-2xl font-extrabold text-green-600" id="custodyTotalSettled">0</p>
                    </div>
                    <div class="card p-4 border-l-4 border-blue-500">
                        <p class="text-sm text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</p>
                        <p class="text-2xl font-extrabold text-blue-700" id="custodyCount">0</p>
                    </div>
                </div>

                <div class="card p-4 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                        <div>
                            <label class="label">Ø¨Ø­Ø«</label>
                            <input id="custodySearch" class="input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¨ÙŠØ§Ù†/Ø§Ù„Ù…Ø¨Ù„Øº..." oninput="renderCustody()">
                        </div>
                        <div>
                            <label class="label">Ø§Ù„Ù…ÙˆØ¸Ù</label>
                            <select id="custodyEmployeeFilter" class="input" onchange="renderCustody()"></select>
                        </div>
                        <div>
                            <label class="label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                            <select id="custodyStatusFilter" class="input" onchange="renderCustody()">
                                <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                                <option value="open">ÙÙŠ Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…ÙˆØ¸Ù</option>
                                <option value="settled">ØªÙ… ØªØ³ÙˆÙŠØªÙ‡Ø§ (Ø£Ø±Ø´ÙŠÙ)</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="custodyFrom" class="input" onchange="renderCustody()">
                        </div>
                        <div>
                            <label class="label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="custodyTo" class="input" onchange="renderCustody()">
                        </div>
                    </div>
                </div>

                <div class="card overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="text-gray-600">
                                <th class="p-3 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th class="p-3 text-right">Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                                <th class="p-3 text-right">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                                <th class="p-3 text-right">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                                <th class="p-3 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th class="p-3 text-right">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</th>
                                <th class="p-3 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="custodyTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ===================== MAINTENANCE ===================== -->
            <div id="maintenance" class="tab-content" style="display:none;">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©</h2>
                        <p class="text-sm text-gray-500 mt-1">ØªØ³Ø¬ÙŠÙ„ ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§ØªØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚ØŒ ÙˆÙÙ„Ø§ØªØ± Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³ÙŠØ§Ø±Ø©.</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="btn-primary flex items-center gap-2" onclick="openModal('addMaintenanceModal')">
                            <span class="text-lg">+</span> Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø©
                        </button>
                        <button class="btn-secondary" onclick="exportMaintenanceCSV()">ØªØµØ¯ÙŠØ± CSV</button>
                        <button class="btn-outline" onclick="printSection('maintenance')">Ø·Ø¨Ø§Ø¹Ø©</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                    <div class="card p-4 border-l-4 border-blue-500">
                        <p class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©</p>
                        <p class="text-2xl font-extrabold text-blue-700" id="maintTotal">0</p>
                    </div>
                    <div class="card p-4 border-l-4 border-orange-500">
                        <p class="text-sm text-gray-500">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</p>
                        <p class="text-2xl font-extrabold text-orange-600" id="maintUnpaid">0</p>
                    </div>
                    <div class="card p-4 border-l-4 border-green-500">
                        <p class="text-sm text-gray-500">Ù…Ø¯ÙÙˆØ¹</p>
                        <p class="text-2xl font-extrabold text-green-600" id="maintPaid">0</p>
                    </div>
                </div>

                <div class="card p-4 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
                        <div class="md:col-span-2">
                            <label class="label">Ø¨Ø­Ø«</label>
                            <input id="maintSearch" class="input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø©/Ø§Ù„ÙˆØµÙ/Ø§Ù„ÙˆØ±Ø´Ø©..." oninput="renderMaintenance()">
                        </div>
                        <div>
                            <label class="label">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                            <select id="maintCarFilter" class="input" onchange="renderMaintenance()"></select>
                        </div>
                        <div>
                            <label class="label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                            <select id="maintPaidFilter" class="input" onchange="renderMaintenance()">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option value="paid">Ù…Ø¯ÙÙˆØ¹</option>
                                <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">Ù…Ù†</label>
                            <input type="date" id="maintFrom" class="input" onchange="renderMaintenance()">
                        </div>
                        <div>
                            <label class="label">Ø¥Ù„Ù‰</label>
                            <input type="date" id="maintTo" class="input" onchange="renderMaintenance()">
                        </div>
                    </div>
                </div>

                <div class="card overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="text-gray-600">
                                <th class="p-3 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th class="p-3 text-right">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                                <th class="p-3 text-right">Ø§Ù„ÙˆØµÙ</th>
                                <th class="p-3 text-right">Ø§Ù„ÙˆØ±Ø´Ø©/Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                                <th class="p-3 text-right">Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                                <th class="p-3 text-right">Ø§Ù„Ø¯ÙØ¹</th>
                                <th class="p-3 text-right">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                <th class="p-3 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="maintenanceTableBody"></tbody>
                    </table>
                </div>
            </div>


            <div id="reports" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>
                <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">ØªÙ‚Ø±ÙŠØ± Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Aging Report)</h3>
                        <button onclick="exportTable('aging-report-table', 'ØªÙ‚Ø±ÙŠØ±-Ø­Ø±ÙƒØ©-Ø§Ù„Ù…Ø®Ø²ÙˆÙ†')" class="export-btn-excel text-white font-bold py-2 px-4 rounded-lg shadow">ØªØµØ¯ÙŠØ± Excel</button>
                    </div>
                    <p class="text-gray-600 mb-4">Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠÙˆØ¶Ø­ Ù…Ø¯Ø© Ø¨Ù‚Ø§Ø¡ ÙƒÙ„ Ø³ÙŠØ§Ø±Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†. Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙŠ ØªØªØ¬Ø§ÙˆØ² 90 ÙŠÙˆÙ…Ø§Ù‹ (3 Ø£Ø´Ù‡Ø±) ØªØ¸Ù‡Ø± Ø¨Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡.</p>
                    <table class="w-full text-center" id="aging-report-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                                <th class="p-3">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                <th class="p-3">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th>
                                <th class="p-3">ØªÙƒÙ„ÙØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                
                <!-- ===== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ===== -->
                <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto mt-6" id="financial-analytics-container">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4 no-print">
                        <h3 class="text-xl font-bold">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø±Ø¨Ø­ÙŠØ© + Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª)</h3>
                        <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                            <div class="flex gap-2">
                                <label class="text-sm text-gray-600 self-center">Ù…Ù†</label>
                                <input id="fin-from" type="date" class="p-2 border rounded-lg">
                            </div>
                            <div class="flex gap-2">
                                <label class="text-sm text-gray-600 self-center">Ø¥Ù„Ù‰</label>
                                <input id="fin-to" type="date" class="p-2 border rounded-lg">
                            </div>
                            <select id="fin-group" class="p-2 border rounded-lg">
                                <option value="month">ØªØ¬Ù…ÙŠØ¹ Ø´Ù‡Ø±ÙŠ</option>
                                <option value="year">ØªØ¬Ù…ÙŠØ¹ Ø³Ù†ÙˆÙŠ</option>
                            </select>
                            <button onclick="renderFinancialAnalytics()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow">ØªØ­Ø¯ÙŠØ«</button>
                            <button onclick="printFinancialAnalytics()" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-2 px-4 rounded-lg shadow">Ø·Ø¨Ø§Ø¹Ø©</button>
                        </div>
                    </div>

                    <div id="financial-analytics-print" class="print-area">
                        <h2 class="text-2xl font-bold text-center mb-4 hidden print:block">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="p-4 rounded-lg border bg-gray-50">
                                <div class="text-gray-600 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­</div>
                                <div id="kpi-total-profit" class="text-2xl font-extrabold text-green-700">0</div>
                                <div class="text-xs text-gray-500 mt-1">Ø¨Ø¹Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ + Ø§Ù„ØµÙŠØ§Ù†Ø©</div>
                            </div>
                            <div class="p-4 rounded-lg border bg-gray-50">
                                <div class="text-gray-600 text-sm">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…ØªÙˆØ³Ø·</div>
                                <div id="kpi-avg-margin" class="text-2xl font-extrabold text-indigo-700">0%</div>
                                <div class="text-xs text-gray-500 mt-1">Ù…ØªÙˆØ³Ø· (Ø§Ù„Ø±Ø¨Ø­ / Ø§Ù„Ø¨ÙŠØ¹)</div>
                            </div>
                            <div class="p-4 rounded-lg border bg-gray-50">
                                <div class="text-gray-600 text-sm">Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                                <div id="kpi-ar" class="text-2xl font-extrabold text-amber-700">0</div>
                                <div class="text-xs text-gray-500 mt-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„ÙŠÙ‡Ù…</div>
                            </div>
                            <div class="p-4 rounded-lg border bg-gray-50">
                                <div class="text-gray-600 text-sm">Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
                                <div id="kpi-ap" class="text-2xl font-extrabold text-rose-700">0</div>
                                <div class="text-xs text-gray-500 mt-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù‡Ù…</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div>
                                <h4 class="font-bold mb-2">ğŸ“ˆ Ø£Ø±Ø¨Ø§Ø­ Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©</h4>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-center" id="profits-by-period-table">
                                        <thead class="bg-gray-200">
                                            <tr>
                                                <th class="p-3">Ø§Ù„ÙØªØ±Ø©</th>
                                                <th class="p-3">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th>
                                                <th class="p-3">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹</th>
                                                <th class="p-3">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                                <th class="p-3">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©</th>
                                                <th class="p-3">Ø§Ù„Ø±Ø¨Ø­</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-bold mb-2">ğŸ§¾ Ø§Ù„Ù‚ØµØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© (ØªØ­Ù„ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ)</h4>
                                <div id="financial-story" class="p-4 rounded-lg border bg-gray-50 leading-8 text-gray-800">
                                    Ø§Ø¶ØºØ· "ØªØ­Ø¯ÙŠØ«" Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ù„ÙŠÙ„.
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-bold">ğŸš— Ø±Ø¨Ø­ÙŠØ© ÙƒÙ„ Ø³ÙŠØ§Ø±Ø© (Ù…Ø¨Ø§Ø¹Ø©)</h4>
                                    <button onclick="exportTable('car-profit-table', 'Ø±Ø¨Ø­ÙŠØ©-ÙƒÙ„-Ø³ÙŠØ§Ø±Ø©')" class="export-btn-excel text-white font-bold py-2 px-4 rounded-lg shadow no-print">Excel</button>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-center" id="car-profit-table">
                                        <thead class="bg-gray-200">
                                            <tr>
                                                <th class="p-3">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                                                <th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                                <th class="p-3">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                                                <th class="p-3">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                                <th class="p-3">Ø§Ù„ØµÙŠØ§Ù†Ø©</th>
                                                <th class="p-3">Ø§Ù„Ø±Ø¨Ø­</th>
                                                <th class="p-3">Ù‡Ø§Ù…Ø´</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-bold">ğŸ’³ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ / Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h4>
                                </div>
                                <div class="grid grid-cols-1 gap-4">
                                    <div class="overflow-x-auto">
                                        <h5 class="font-bold mb-2">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø¹Ù„ÙŠÙ‡)</h5>
                                        <table class="w-full text-center" id="ar-table">
                                            <thead class="bg-gray-200">
                                                <tr>
                                                    <th class="p-3">Ø§Ù„Ø§Ø³Ù…</th>
                                                    <th class="p-3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                                    <th class="p-3">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                                    <th class="p-3">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>

                                    <div class="overflow-x-auto">
                                        <h5 class="font-bold mb-2 mt-4">Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Ù„Ù‡)</h5>
                                        <table class="w-full text-center" id="ap-table">
                                            <thead class="bg-gray-200">
                                                <tr>
                                                    <th class="p-3">Ø§Ù„Ø§Ø³Ù…</th>
                                                    <th class="p-3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                                    <th class="p-3">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                                    <th class="p-3">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <!-- ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ===== -->

</div>
            </div>
            
            <div id="clients" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-700">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø§Ù„Ù…Ø´ØªØ±ÙŠÙ†)</h2>
                            <div class="no-print flex-shrink-0">
                                <button onclick="exportTable('customers-table', 'Ø¨ÙŠØ§Ù†Ø§Øª-Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡')" class="export-btn-excel text-white font-bold py-2 px-4 rounded-lg shadow ml-2">Excel</button>
                                <button onclick="openModal('addClientModal')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow ml-2">+ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
                            </div>
                        </div>
                        <div id="customers-table-container" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto print-area">
                            <h2 class="text-2xl font-bold text-center mb-4 hidden print:block">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
                            <table class="w-full text-center" id="customers-table">
                                <thead class="bg-gray-200"><tr><th class="p-3">Ø§Ù„Ø§Ø³Ù…</th><th class="p-3">Ø§Ù„Ù‡Ø§ØªÙ</th><th class="p-3">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th class="p-3">Ø§Ù„Ø±ØµÙŠØ¯</th><th class="p-3 no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-700">Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h2>
                            <div class="no-print flex-shrink-0">
                                <button onclick="exportTable('suppliers-table', 'Ø¨ÙŠØ§Ù†Ø§Øª-Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†')" class="export-btn-excel text-white font-bold py-2 px-4 rounded-lg shadow ml-2">Excel</button>
                                <button onclick="openModal('addSupplierModal')" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow ml-2">+ Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯</button>
                            </div>
                        </div>
                        <div id="suppliers-table-container" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto print-area">
                            <h2 class="text-2xl font-bold text-center mb-4 hidden print:block">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h2>
                            <table class="w-full text-center" id="suppliers-table">
                                <thead class="bg-gray-200"><tr><th class="p-3">Ø§Ù„Ø§Ø³Ù…</th><th class="p-3">Ø§Ù„Ù‡Ø§ØªÙ</th><th class="p-3">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th class="p-3">Ø§Ù„Ø±ØµÙŠØ¯</th><th class="p-3 no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="expenses" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
                    <div class="no-print flex-shrink-0">
                        <button onclick="exportTable('expenses-table', 'ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª')" class="export-btn-excel text-white font-bold py-2 px-4 rounded-lg shadow ml-2">ØªØµØ¯ÙŠØ± Excel</button>
                        <button onclick="openModal('addExpenseModal')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow ml-2">+ ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</button>
                    </div>
                </div>
                <div id="expenses-table-container" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto print-area">
                    <h2 class="text-2xl font-bold text-center mb-4 hidden print:block">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
                    <table class="w-full text-center" id="expenses-table">
                        <thead class="bg-gray-200"><tr><th class="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-3">Ø§Ù„Ø¨ÙŠØ§Ù†</th><th class="p-3">Ø§Ù„Ù…Ø¨Ù„Øº</th><th class="p-3">Ø£Ø¶ÙŠÙ Ø¨ÙˆØ§Ø³Ø·Ø©</th><th class="p-3 no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            
        <div id="contracts" class="tab-content">
            <div class="container mx-auto p-4">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4 no-print">
                        <h2 class="text-2xl font-bold text-gray-800">Ø§Ù„Ø¹Ù‚ÙˆØ¯</h2>
                        <div class="search-container w-full md:w-80">
                            <span class="search-icon"><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 104.5 4.5a7.5 7.5 0 0012.15 12.15z"/></svg></span>
                            <input id="contractsSearch" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø§Ù„Ø³ÙŠØ§Ø±Ø© / Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯..." class="w-full p-3 pr-10 border rounded-lg" />
                        </div>
                    </div>
                    <div class="overflow-x-auto print-area">
                        <h2 class="text-2xl font-bold text-center mb-4 hidden print:block">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯</h2>
                        <table class="w-full text-center" id="contracts-table">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="p-3">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                                    <th class="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th class="p-3">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                                    <th class="p-3">Ø§Ù„Ù…Ø´ØªØ±ÙŠ</th>
                                    <th class="p-3 no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="mt-4 no-print flex justify-end">
                        <button onclick="printContractsList()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6v-8z"/></svg> Ø·Ø¨Ø§Ø¹Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯</button>
                    </div>
                </div>
            </div>
        </div>

<div id="archive" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</h2>
                    <div class="no-print flex-shrink-0">
                        <button onclick="openModal('addArchiveModal')" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow ml-2">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md mb-4 no-print">
                    <h3 class="text-lg font-bold mb-2">ØªØµÙÙŠØ© Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h3>
                    <div class="flex items-end gap-4">
                        <div class="flex-grow">
                            <label>Ø¹Ø±Ø¶ Ø£Ø±Ø´ÙŠÙ Ø³ÙŠØ§Ø±Ø© Ù…Ø­Ø¯Ø¯Ø©</label>
                            <select id="archive-car-filter" class="w-full p-2 border rounded">
                                <option value="all">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="archive-table-container" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-center" id="archive-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th class="p-3">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
                                <th class="p-3">Ø§Ù„ÙˆØµÙ</th>
                                <th class="p-3">Ù…Ø±ØªØ¨Ø· Ø¨Ù€</th>
                                <th class="p-3">Ø£Ø¶ÙŠÙ Ø¨ÙˆØ§Ø³Ø·Ø©</th>
                                <th class="p-3 no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div id="treasury" class="tab-content">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Ø§Ù„Ø®Ø²Ù†Ø©</h2>
                <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center border-b pb-2">
                            <span class="font-semibold text-lg text-green-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶Ø§Øª (Ù†Ù‚Ø¯ÙŠ + Ù…Ù‚Ø¯Ù…Ø§Øª + Ø£Ù‚Ø³Ø§Ø·):</span>
                            <span id="t-total-inflow" class="font-bold text-lg text-green-700">0 Ø¬.Ù….</span>
                        </div>
                        <div class="flex justify-between items-center border-b pb-2">
                            <span class="font-semibold text-lg text-red-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (ØµÙŠØ§Ù†Ø© + Ù…ØµØ±ÙˆÙØ§Øª + Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†):</span>
                            <span id="t-total-outflow" class="font-bold text-lg text-red-700">0 Ø¬.Ù….</span>
                        </div>
                        <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg mt-4">
                            <span class="font-bold text-xl text-gray-800">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø®Ø²Ù†Ø©:</span>
                            <span id="t-balance" class="font-bold text-xl text-gray-800">0 Ø¬.Ù….</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="activityLog" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Ø³Ø¬Ù„ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
                <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-center" id="activity-log-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                                <th class="p-3">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th class="p-3">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
</main>

        <div id="addPurchaseModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('addPurchaseModal')">Ã—</span><h3 class="text-xl font-bold mb-4">ØªØ³Ø¬ÙŠÙ„ Ø³ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3><form id="addPurchaseForm" class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block">Ø§Ù„Ù…ÙˆØ±Ø¯</label><select id="purchaseSupplier" class="w-full p-2 border rounded" required></select></div><div><label class="block">Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡)</label><select id="purchaseCarCondition" class="w-full p-2 border rounded"><option value="Ø¬Ø¯ÙŠØ¯Ø©">Ø¬Ø¯ÙŠØ¯Ø©</option><option value="Ù…Ø³ØªØ¹Ù…Ù„Ø©">Ù…Ø³ØªØ¹Ù…Ù„Ø©</option></select></div><div><label class="block">Ø§Ù„Ù†ÙˆØ¹ (e.g. Ø§ÙŠØ³ÙˆØ²Ùˆ)</label><input type="text" id="purchaseCarType" class="w-full p-2 border rounded" required></div><div><label class="block">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ (e.g. Ø¬Ø§Ù…Ø¨Ùˆ)</label><input type="text" id="purchaseCarModel" class="w-full p-2 border rounded" required></div><div><label class="block">Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹</label><input type="number" id="purchaseModelYear" class="w-full p-2 border rounded" required placeholder="YYYY" min="1900" max="2100"></div><div><label class="block">Ø§Ù„Ù„ÙˆÙ†</label><input type="text" id="purchaseColor" class="w-full p-2 border rounded" required></div><div class="md:col-span-2"><label class="block">Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡</label><input type="text" id="purchaseVin" class="w-full p-2 border rounded" required></div><div><label class="block">Ø±Ù‚Ù… Ø§Ù„Ù…Ø§ØªÙˆØ±</label><input type="text" id="purchaseEngineNumber" class="w-full p-2 border rounded" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div><div><label class="block">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label><input type="text" id="purchasePlateNumber" class="w-full p-2 border rounded" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div><div><label class="block">Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª</label><input type="number" id="purchaseOdometer" class="w-full p-2 border rounded" required></div><div><label class="block">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label><input type="number" step="any" id="purchasePrice" class="w-full p-2 border rounded" required></div><div><label class="block">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</label><input type="date" id="purchaseDate" class="w-full p-2 border rounded" required></div><div class="border-t pt-4 mt-2 md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø®ØµØ©</label><input type="date" id="purchaseLicenseExpiry" class="w-full p-2 border rounded"></div><div><label class="block">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†</label><input type="date" id="purchaseInsuranceExpiry" class="w-full p-2 border rounded"></div></div><div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-3"><button type="submit" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´Ø±Ø§Ø¡</button><button type="button" class="w-full bg-gray-200 text-gray-800 p-3 rounded hover:bg-gray-300" onclick="cancelPurchase()">Ø¥Ø±Ø¬Ø§Ø¹ / Ø¥Ù„ØºØ§Ø¡</button></div></form></div></div>
        <div id="editCarModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('editCarModal')">Ã—</span><h3 class="text-xl font-bold mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ§Ø±Ø©</h3><form id="editCarForm" class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="hidden" id="editCarId"><div><label class="block">Ø§Ù„Ù†ÙˆØ¹</label><input type="text" id="editCarType" class="w-full p-2 border rounded" required></div><div><label class="block">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label><input type="text" id="editCarModel" class="w-full p-2 border rounded" required></div><div><label class="block">Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹</label><input type="number" id="editModelYear" class="w-full p-2 border rounded" required></div><div><label class="block">Ø§Ù„Ù„ÙˆÙ†</label><input type="text" id="editColor" class="w-full p-2 border rounded" required></div><div class="md:col-span-2"><label class="block">Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡</label><input type="text" id="editCarVin" class="w-full p-2 border rounded" required></div><div><label class="block">Ø±Ù‚Ù… Ø§Ù„Ù…Ø§ØªÙˆØ±</label><input type="text" id="editEngineNumber" class="w-full p-2 border rounded" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div><div><label class="block">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label><input type="text" id="editPlateNumber" class="w-full p-2 border rounded" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div><div><label class="block">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label><input type="number" step="any" id="editCarPurchasePrice" class="w-full p-2 border rounded" required></div><div><label class="block">Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="editCarStatus" class="w-full p-2 border rounded"></select></div><div class="md:col-span-2 border-t pt-4 mt-2 grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø®ØµØ©</label><input type="date" id="editLicenseExpiry" class="w-full p-2 border rounded"></div><div><label class="block">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†</label><input type="date" id="editInsuranceExpiry" class="w-full p-2 border rounded"></div></div><div class="md:col-span-2"><button type="submit" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button></div></form></div></div>
        <div id="carDetailsModal" class="modal"><div class="modal-content max-w-4xl"></div></div>
        <div id="carDocsModal" class="modal">
            <div class="modal-content max-w-4xl">
                <span class="close-button" onclick="closeModal('carDocsModal')">Ã—</span>
                <div class="flex items-center justify-between gap-3 mb-4">
                    <h3 class="text-xl font-bold">Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h3>
                    <div id="carDocsCarTitle" class="text-gray-600 text-sm"></div>
                </div>
                <div id="carDocsList" class="space-y-3"></div>
                <div class="mt-6">
                    <button type="button" class="w-full bg-gray-200 text-gray-800 p-3 rounded hover:bg-gray-300" onclick="closeModal('carDocsModal')">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>

        <div id="addSaleModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('addSaleModal')">Ã—</span><h3 class="text-xl font-bold mb-4">ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹</h3><form id="addSaleForm" class="space-y-4"><div><label class="block">Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label><select id="saleCarId" class="w-full p-2 border rounded" required></select></div><div><label class="block">Ø§Ù„Ø¹Ù…ÙŠÙ„</label><select id="saleCustomerId" class="w-full p-2 border rounded" required></select></div><div><label class="block">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label><input type="number" step="any" id="salePrice" class="w-full p-2 border rounded" required></div><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-semibold mb-2">Ø±Ø³ÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h4><div id="additional-charges-container" class="space-y-2"></div><button type="button" id="add-charge-btn" class="text-sm text-blue-600 hover:text-blue-800 mt-2">+ Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ù…</button></div><div><label class="block">Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨ÙŠØ¹</label><input type="number" id="saleOdometer" class="w-full p-2 border rounded" required></div><div><label class="block">Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¯Ø§Ø¯</label><select id="saleType" class="w-full p-2 border rounded"><option value="Ù†Ù‚Ø¯ÙŠ">Ù†Ù‚Ø¯ÙŠ</option><option value="ØªÙ‚Ø³ÙŠØ·">ØªÙ‚Ø³ÙŠØ·</option><option value="Ø¯ÙØ¹Ø§Øª">Ø¯ÙØ¹Ø§Øª</option></select></div><div id="installment-fields" class="hidden space-y-4"><div><label class="block">Ø§Ù„Ù…Ù‚Ø¯Ù…</label><input type="number" step="any" id="saleDownPayment" class="w-full p-2 border rounded" value="0"></div><div><label class="block">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</label><input type="number" id="saleInstallmentCount" class="w-full p-2 border rounded" value="12"></div></div>

<div id="payments-fields" class="hidden space-y-4 p-4 bg-gray-50 rounded-lg border">
  <h4 class="font-semibold">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</h4>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
    <div><label class="block">Ø§Ù„Ù…Ù‚Ø¯Ù…</label><input type="number" step="any" id="paymentsDownPayment" class="w-full p-2 border rounded" value="0"></div>
    <div><label class="block">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</label><input type="number" id="paymentsCount" class="w-full p-2 border rounded" value="4" min="1"></div>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
    <div>
      <label class="block">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª</label>
      <select id="paymentsPlan" class="w-full p-2 border rounded">
        <option value="3">ÙƒÙ„ 3 Ø´Ù‡ÙˆØ±</option>
        <option value="6">ÙƒÙ„ 6 Ø´Ù‡ÙˆØ±</option>
        <option value="manual">ØªØ­Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠ</option>
      </select>
    </div>
    <div class="text-sm text-gray-600 flex items-end">* ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„ Ø¯ÙØ¹Ø© Ø¨ØªØ§Ø±ÙŠØ®Ù‡Ø§ ÙˆÙ…Ø¨Ù„ØºÙ‡Ø§.</div>
  </div>
  <div id="manual-payments" class="hidden space-y-2">
    <div class="flex justify-between items-center">
      <div class="font-semibold">Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ©</div>
      <button type="button" class="btn btn-secondary" onclick="addManualPaymentRow()">Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</button>
    </div>
    <div id="manual-payments-rows" class="space-y-2"></div>
  </div>
</div>

<div><label class="block">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹</label><input type="date" id="saleDate" class="w-full p-2 border rounded" required></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3"><button type="submit" class="w-full bg-emerald-600 text-white p-3 rounded hover:bg-emerald-700">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹</button><button type="button" class="w-full bg-gray-200 text-gray-800 p-3 rounded hover:bg-gray-300" onclick="cancelSale()">Ø¥Ø±Ø¬Ø§Ø¹ / Ø¥Ù„ØºØ§Ø¡</button></div></form></div></div>
        <div id="addExpenseModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('addExpenseModal')">Ã—</span><h3 class="text-xl font-bold mb-4">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</h3><form id="addExpenseForm" class="space-y-4"><div><label class="block">Ø¨ÙŠØ§Ù† Ø§Ù„Ù…ØµØ±ÙˆÙ</label><input type="text" id="expenseDescription" class="w-full p-2 border rounded" required></div><div><label class="block">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label><select id="expenseType" class="w-full p-2 border rounded"><option value="Ø¹Ø§Ù…Ø©">Ø¹Ø§Ù…Ø©</option><option value="ØµÙŠØ§Ù†Ø©" disabled>ØµÙŠØ§Ù†Ø© (ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø©)</option></select></div><div><label class="block">Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" step="any" id="expenseAmount" class="w-full p-2 border rounded" required></div><div><label class="block">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="expenseDate" class="w-full p-2 border rounded" required></div><button type="submit" class="w-full bg-red-600 text-white p-3 rounded hover:bg-red-700">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</button></form></div></div>
        <div id="addMaintenanceModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('addMaintenanceModal')">Ã—</span><h3 class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØµÙŠØ§Ù†Ø©</h3><form id="addMaintenanceForm" class="space-y-4"><input type="hidden" id="maintenanceCarId"><div class="bg-blue-100 p-2 rounded text-center font-bold" id="maintenanceCarName"></div><div><label>Ø¨ÙŠØ§Ù† Ø§Ù„ØµÙŠØ§Ù†Ø©</label><input id="maintenanceDescription" class="w-full p-2 border rounded" required></div><div><label>Ø§Ù„ÙˆØ±Ø´Ø© / Ø§Ù„ÙÙ†ÙŠ</label><input id="maintenanceWorkshop" class="w-full p-2 border rounded"></div><div><label>Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</label><textarea id="maintenanceParts" class="w-full p-2 border rounded"></textarea></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label>Ø§Ù„ØªÙƒÙ„ÙØ©</label><input type="number" step="any" id="maintenanceCost" class="w-full p-2 border rounded" required></div><div><label>Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label><input type="number" id="maintenanceOdometer" class="w-full p-2 border rounded"></div><div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙŠØ§Ù†Ø©</label><input type="date" id="maintenanceDate" class="w-full p-2 border rounded" required></div></div><button type="submit" class="w-full bg-orange-600 text-white p-3 rounded hover:bg-orange-700">Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©</button></form></div></div>
        <div id="addClientModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('addClientModal')">Ã—</span><h3 class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3><form id="addClientForm" class="space-y-4"><div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="clientName" class="w-full p-2 border rounded" required></div><div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="clientPhone" class="w-full p-2 border rounded"></div><div><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="clientAddress" class="w-full p-2 border rounded"></div><button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded hover:bg-indigo-700">Ø¥Ø¶Ø§ÙØ©</button></form></div></div>
        <div id="addSupplierModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('addSupplierModal')">Ã—</span><h3 class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯</h3><form id="addSupplierForm" class="space-y-4"><div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="supplierName" class="w-full p-2 border rounded" required></div><div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="supplierPhone" class="w-full p-2 border rounded"></div><div><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="supplierAddress" class="w-full p-2 border rounded"></div><button type="submit" class="w-full bg-purple-600 text-white p-3 rounded hover:bg-purple-700">Ø¥Ø¶Ø§ÙØ©</button></form></div></div>
        <div id="editPersonModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('editPersonModal')">Ã—</span><h3 id="editPersonTitle" class="text-xl font-bold mb-4"></h3><form id="editPersonForm" class="space-y-4"><input type="hidden" id="editPersonId"><input type="hidden" id="editPersonType"><div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="editPersonName" class="w-full p-2 border rounded" required></div><div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="editPersonPhone" class="w-full p-2 border rounded"></div><div><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="editPersonAddress" class="w-full p-2 border rounded"></div><button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded hover:bg-indigo-700">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button></form></div></div>
        <div id="editExpenseModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('editExpenseModal')">Ã—</span><h3 class="text-xl font-bold mb-4">ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ</h3><form id="editExpenseForm" class="space-y-4"><input type="hidden" id="editExpenseId"><div><label>Ø§Ù„Ø¨ÙŠØ§Ù†</label><input id="editExpenseDescription" class="w-full p-2 border rounded" required></div><div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" step="any" id="editExpenseAmount" class="w-full p-2 border rounded" required></div><button type="submit" class="w-full bg-red-600 text-white p-3 rounded hover:bg-red-700">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button></form></div></div>
        <div id="addArchiveModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('addArchiveModal')">Ã—</span><h3 class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ù„Ù„Ø£Ø±Ø´ÙŠÙ</h3><form id="addArchiveForm" class="space-y-4"><div><label class="block">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯</label><input type="text" id="archiveTitle" class="w-full p-2 border rounded" required></div><div><label class="block">ÙˆØµÙ Ù‚ØµÙŠØ±</label><textarea id="archiveDescription" class="w-full p-2 border rounded"></textarea></div><div><label class="block">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ†Ø¯ (Image/PDF Link)</label><input type="url" id="archiveLink" placeholder="https://example.com/image.jpg" class="w-full p-2 border rounded" required></div><div><label class="block">Ø±Ø¨Ø· Ø¨Ø³ÙŠØ§Ø±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><select id="archiveCarId" class="w-full p-2 border rounded"></select></div><div><label class="block">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="archiveDate" class="w-full p-2 border rounded" required></div><button type="submit" class="w-full bg-teal-600 text-white p-3 rounded hover:bg-teal-700">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button></form></div></div>
        <div id="confirmModal" class="modal"><div class="modal-content max-w-sm"><h3 class="text-xl font-bold mb-4">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3><p id="confirmMessage" class="mb-6"></p><div class="flex justify-end gap-4"><button id="confirmCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded">Ø¥Ù„ØºØ§Ø¡</button><button id="confirmOkBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded">ØªØ£ÙƒÙŠØ¯</button></div></div></div>
        
        <div id="addQuoteModal" class="modal">
            <div class="modal-content max-w-lg">
                <span class="close-button" onclick="closeModal('addQuoteModal')">Ã—</span>
                <h3 class="text-xl font-bold mb-4">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø³Ø¹Ø±</h3>
                <form id="addQuoteForm" class="space-y-4">
                    <div>
                        <label class="block">Ø§Ù„Ø³ÙŠØ§Ø±Ø© (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø©)</label>
                        <select id="quoteCarId" class="w-full p-2 border rounded" required></select>
                    </div>
                    <div>
                        <label class="block">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <select id="quoteCustomerId" class="w-full p-2 border rounded" required></select>
                    </div>
                    <div>
                        <label class="block">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù„Ù„Ø¨ÙŠØ¹</label>
                        <input type="number" step="any" id="quotePrice" class="w-full p-2 border rounded" required>
                    </div>
                     <div>
                        <label class="block">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¹Ø±Ø¶</label>
                        <input type="date" id="quoteExpiryDate" class="w-full p-2 border rounded" required>
                    </div>
                     <div>
                        <label class="block">Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ´Ø±ÙˆØ· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <textarea id="quoteNotes" class="w-full p-2 border rounded" rows="3" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø§ ÙŠØ´Ù…Ù„ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-cyan-600 text-white p-3 rounded hover:bg-cyan-700">Ø­ÙØ¸ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¹Ø±Ø¶</button>
                </form>
            </div>
        </div>

        
        <div id="contractModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('contractModal')">Ã—</span>
                <div class="flex justify-between items-center mb-4 no-print">
                    <h3 class="text-xl font-bold">Ø¹Ù‚Ø¯ Ø¨ÙŠØ¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</h3>
                    <div class="flex gap-2">
                        <button onclick="toggleContractEdit(true)" class="bg-gray-100 hover:bg-gray-200 text-gray-900 font-bold py-2 px-4 rounded flex items-center gap-2">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button onclick="printCurrentContract()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2">Ø·Ø¨Ø§Ø¹Ø©</button>
                    </div>
                </div>

                <div id="contractEditPanel" class="no-print" style="display:none; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin-bottom:12px; background:#fff;">
                    <div class="flex items-center justify-between gap-2 mb-3">
                        <div class="font-bold text-lg">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯</div>
                        <div class="flex gap-2">
                            <button onclick="openShowroomsManager()" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-900 font-bold py-2 px-3 rounded flex items-center gap-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
                            <button onclick="toggleContractEdit(false)" class="bg-gray-100 hover:bg-gray-200 text-gray-900 font-bold py-2 px-3 rounded">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-bold mb-1">Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø¹Ø±Ø¶ (Ø§Ù„Ø¨Ø§Ø¦Ø¹)</label>
                             <select id="contractEmployeeSelect" class="w-full p-2 border rounded"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ</label>
                            <input id="contractBuyerName" class="w-full p-2 border rounded" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø´ØªØ±ÙŠ</label>
                            <input id="contractBuyerPhone" class="w-full p-2 border rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
                            <input id="contractBuyerNID" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Ø§Ù„Ù…Ù‡Ù†Ø© (Ø¨Ø§Ù„Ù€ Ø¨Ø·Ø§Ù‚Ø©)</label>
                            <input id="contractBuyerJob" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ù…Ù‡Ù†Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø´ØªØ±ÙŠ</label>
                            <input id="contractBuyerAddress" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
                        </div>

                        <div>
                            <label class="block text-sm font-bold mb-1">Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©/Ø§Ù„Ù„ÙˆØ­Ø©</label>
                            <input id="contractPlateNumber" class="w-full p-2 border rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Ù…Ø§Ø±ÙƒØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                            <input id="contractCarBrand" class="w-full p-2 border rounded" placeholder="Ù…Ø«Ø§Ù„: Ø´ÙŠÙØ±ÙˆÙ„ÙŠÙ‡ Ø¬Ø§Ù…Ø¨Ùˆ">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Ù…ÙˆØ¯ÙŠÙ„ (Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹)</label>
                            <input id="contractModelYear" class="w-full p-2 border rounded" placeholder="Ù…Ø«Ø§Ù„: 2025">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Ø§Ù„Ù„ÙˆÙ†</label>
                            <input id="contractCarColor" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ù„ÙˆÙ†">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡</label>
                            <input id="contractVin" class="w-full p-2 border rounded" placeholder="VIN">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØªÙˆØ±</label>
                            <input id="contractEngineNumber" class="w-full p-2 border rounded" placeholder="Engine No">
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯</label>
                            <textarea id="contractNotes" class="w-full p-2 border rounded" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-2 mt-3">
                        <button onclick="saveContractEdits()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                    </div>
                </div>

                <div id="contractContent" class="print-area"></div>
            </div>
        </div>



        <div id="showroomsModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('showroomsModal')">Ã—</span>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ø¶ / Ø§Ù„Ø´Ø±ÙƒØ§Ø¡</h3>
                    <button onclick="addShowroomRow()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                <div class="overflow-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="p-2 text-right">Ø§Ù„Ø§Ø³Ù…</th>
                                <th class="p-2 text-right">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©/Ø§Ù„Ù…Ø§Ù„Ùƒ</th>
                                <th class="p-2 text-right">Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th class="p-2 text-right">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th class="p-2 text-center">Ø¥Ø¬Ø±Ø§Ø¡</th>
                            </tr>
                        </thead>
                        <tbody id="showroomsTbody"></tbody>
                    </table>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="saveShowrooms()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded flex items-center gap-2">Ø­ÙØ¸</button>
                </div>
            </div>
        </div>


<div id="invoiceModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('invoiceModal')">Ã—</span>
                <div id="invoiceContent" class="print-area"></div>
                <div class="text-center mt-4 no-print">
                    <button onclick="printContent('invoiceContent')" class="bg-blue-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-700">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                </div>
            </div>
        </div>

        
        <div id="statementModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal('statementModal')">Ã—</span>
                <div id="statementContent" class="print-area"></div>
                <div class="text-center mt-4 no-print">
                    <button onclick="printContent('statementContent')" class="bg-blue-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-700">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù</button>
                </div>
            </div>
        </div>

        <div id="settingsModal" class="modal">
            <div class="modal-content max-w-2xl">
                <span class="close-button" onclick="closeModal('settingsModal')">Ã—</span>
                <h3 class="text-xl font-bold mb-4">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                
                <form id="user-form" class="bg-gray-50 p-4 rounded-lg mb-6 space-y-3">
                    <input type="hidden" id="user-id">
                    <h4 id="user-form-title" class="text-lg font-semibold">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø¹Ø±Ø¶)</label>
                            <input id="user-fullname" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block">Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª)</label>
                            <input id="user-username" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input id="user-password" class="w-full p-2 border rounded" required>
                        </div>
                        <div>
                            <label class="block">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ø§ÙØµÙ„ Ø¨ÙŠÙ†Ù‡Ø§ Ø¨ÙØ§ØµÙ„Ø© ,)</label>
                            <input id="user-permissions" class="w-full p-2 border rounded" placeholder="Ù…Ø«Ø§Ù„: sales,clients,expenses">
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                        <button type="button" onclick="resetUserForm()" class="w-1/3 bg-gray-400 text-white p-3 rounded hover:bg-gray-500">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                    </div>
                </form>

                <div class="overflow-x-auto">
                    <table class="w-full text-center" id="users-table">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="p-3">Ø§Ù„Ø§Ø³Ù…</th>
                                <th class="p-3">Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                                <th class="p-3">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th>
                                <th class="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="addSupplierPaymentModal" class="modal">
            <div class="modal-content max-w-lg">
                <span class="close-button" onclick="closeModal('addSupplierPaymentModal')">Ã—</span>
                <h3 class="text-xl font-bold mb-4">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ù„Ù…ÙˆØ±Ø¯</h3>
                <form id="addSupplierPaymentForm" class="space-y-4">
                    <input type="hidden" id="paymentSupplierId" required>
                    <div>
                        <label class="block">Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                        <p id="paymentSupplierName" class="w-full p-2 bg-gray-100 rounded"></p>
                    </div>
                    <div>
                        <label class="block">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                        <input type="number" step="any" id="paymentAmount" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label class="block">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø©</label>
                        <input type="date" id="paymentDate" class="w-full p-2 border rounded" required>
                    </div>
                     <div>
                        <label class="block">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" id="paymentNotes" class="w-full p-2 border rounded">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white p-3 rounded hover:bg-green-700">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
                </form>
            </div>
        </div>

        <div id="editSupplierPaymentModal" class="modal">
            <div class="modal-content max-w-lg">
                <span class="close-button" onclick="closeModal('editSupplierPaymentModal')">Ã—</span>
                <h3 class="text-xl font-bold mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹Ø© Ù…ÙˆØ±Ø¯</h3>
                <form id="editSupplierPaymentForm" class="space-y-4">
                    <input type="hidden" id="editPaymentId" required>
                    <div>
                        <label class="block">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                        <input type="number" step="any" id="editPaymentAmount" class="w-full p-2 border rounded" required>
                    </div>
                    <div>
                        <label class="block">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø©</label>
                        <input type="date" id="editPaymentDate" class="w-full p-2 border rounded" required>
                    </div>
                     <div>
                        <label class="block">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" id="editPaymentNotes" class="w-full p-2 border rounded">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                </form>
            </div>
        </div>

        <div id="toast-notification" class="toast"></div>
        
        <footer class="text-center p-4 mt-8 text-gray-500 no-print">
            <p>Ø§Ù‡Ø¯Ø§Ø¡ Ù…Ù† Ù…/Ø±Ø§Ø¶ÙŠ Ù…Ù‡Ù†ÙŠ Ø¯ÙŠØ§Ø¨ Â© 2025</p>
            <p>ÙØ¶Ù„Ø§ ÙˆÙ„ÙŠØ³ Ø§Ù…Ø±Ø§ Ù†Ø±Ø¬Ùˆ Ø§Ù„Ø¯Ø¹Ø§Ø¡ Ù„ÙˆØ§Ù„Ø¯ÙŠ Ø§Ù„Ù…Ø±Ø­ÙˆÙ… Ù…Ù‡Ù†ÙŠ Ø¯ÙŠØ§Ø¨</p>
            <div id="admin-footer-controls" class="flex justify-center gap-4 flex-wrap" style="display: none;">
                <button onclick="backupData()" class="mt-4 bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg shadow">ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                <button onclick="document.getElementById('restore-input').click()" class="mt-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                <input type="file" id="restore-input" class="hidden" accept=".json" onchange="restoreData(event)">
                <button onclick="resetSystem()" class="mt-4 bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg shadow">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù… (Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</button>
            </div>
        </footer>
    </div>
    
    <script>
        // --- Database Initialization ---
        let db = { cars: [], sales: [], installments: [], expenses: [], customers: [], suppliers: [], archive: [], activityLog: [], invoiceCounter: 1, carFileCounter: 1, users: [], supplierPayments: [], maintenanceLog: [], quotes: [], custody: [], custodyCounter: 1,  quoteCounter: 1, contracts: [], contractCounter: 1, showrooms: [], showroomCounter: 1, carDocs: {} , custodyDocs: {} };
        const DB_KEY = 'mutawakelCarSystemDB_v23_final'; 
        let currentUser = null;
        const CAR_STATUSES = {
            AVAILABLE: 'Ù…ØªØ§Ø­Ø©',
            RESERVED: 'Ù…Ø­Ø¬ÙˆØ²Ø©',
            SOLD: 'Ù…Ø¨Ø§Ø¹Ø©'
        };

        function saveData() { try { localStorage.setItem(DB_KEY, JSON.stringify(db)); } catch (e) { console.error("Error saving data:", e); showToast("Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."); } }
        
        function loadData() {
            const savedData = localStorage.getItem(DB_KEY);
            if (savedData) {
                db = JSON.parse(savedData);
            }
            
            if (!db.users || db.users.length === 0) {
                db.users = [
                    { id: 1, username: 'developer', password: 'RADY-SUPER-ADMIN-2025', name: 'Ø±Ø§Ø¶ÙŠ Ù…Ù‡Ù†ÙŠ Ø¯ÙŠØ§Ø¨', permissions: ['all'], isDeveloper: true },
                    { id: 2, username: 'admin', password: '000', name: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…', permissions: ['all'] },
                    { id: 3, username: 'mahmoud', password: '111', name: 'Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ø³ÙŠØ¯', permissions: ['expenses', 'clients'] },
                    { id: 4, username: 'abogeny', password: '222', name: 'Ø§Ø¨Ùˆ Ø¬Ù†ÙŠ', permissions: ['sales', 'installments', 'clients', 'quotes'] },
                    { id: 5, username: 'abozeyad', password: '333', name: 'Ø§Ø¨Ùˆ Ø²ÙŠØ§Ø¯', permissions: ['purchases', 'inventory', 'clients'] },
                    { id: 6, username: 'accountant', password: '444', name: 'Ø§Ù„Ù…Ø­Ø§Ø³Ø¨', permissions: ['purchases', 'sales', 'expenses', 'installments', 'treasury', 'clients', 'activityLog', 'reports', 'quotes'] }
                ];
                saveData();
            }
            if (!db.invoiceCounter) db.invoiceCounter = 1;
            if (!db.carFileCounter) db.carFileCounter = 1;
            if (!db.archive) db.archive = [];
            if (!db.activityLog) db.activityLog = [];
            if (!db.supplierPayments) db.supplierPayments = [];
            if (!db.maintenanceLog) db.maintenanceLog = [];
            if (!db.quotes) db.quotes = [];
            if (!db.quoteCounter) db.quoteCounter = 1;
            if (!db.carDocs) db.carDocs = {};
            if (!db.contracts) db.contracts = [];
            if (!db.contractCounter) db.contractCounter = 1;
            if (!db.showrooms) db.showrooms = [];
            if (!db.showroomCounter) db.showroomCounter = 1;
        }

        function resetSystem() { openConfirmModal("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.", () => { localStorage.removeItem(DB_KEY); location.reload(true); }); }
        function logout() { openConfirmModal("ØªØµØ­Ø¨ÙƒÙ… Ø§Ù„Ø³Ù„Ø§Ù…Ø©ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ\nØ§Ù‡Ø¯Ø§Ø¡ Ù…Ù† Ù…/Ø±Ø§Ø¶ÙŠ Ù…Ù‡Ù†ÙŠ Ø¯ÙŠØ§Ø¨", () => { location.reload(true); }); }
        
        function applyPermissions() {
            document.getElementById('settings-btn').style.display = 'none';
            if (currentUser.isDeveloper || (currentUser.permissions && currentUser.permissions.includes('all'))) {
                document.getElementById('admin-footer-controls').style.display = 'flex';
                document.getElementById('settings-btn').style.display = 'block';
            }
            
            if (!currentUser || (currentUser.permissions && currentUser.permissions.includes('all'))) {
                 document.querySelectorAll('#main-nav .tab-link').forEach(link => link.style.display = 'block');
                return;
            }

            const navLinks = document.querySelectorAll('#main-nav .tab-link');
            const allowedTabs = new Set(['dashboard', ...currentUser.permissions]);
            navLinks.forEach(link => {
                const tabName = link.dataset.tab;
                if (allowedTabs.has(tabName)) {
                    link.style.display = 'block';
                } else {
                    link.style.display = 'none';
                }
            });
        }

        function backupData() { try { const dataStr = JSON.stringify(db); const dataBlob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; const date = new Date().toISOString().slice(0, 10); link.download = `mutawakel-backup-${date}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showToast("ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­."); } catch (e) { console.error("Backup failed:", e); showToast("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©."); } }
        function restoreData(event) { const file = event.target.files[0]; if (!file) return; openConfirmModal(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„ÙØŸ Ø³ÙŠØªÙ… Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.`, () => { const reader = new FileReader(); reader.onload = function(e) { try { const restoredDb = JSON.parse(e.target.result); if (restoredDb && typeof restoredDb.cars !== 'undefined' && typeof restoredDb.sales !== 'undefined') { db = restoredDb; saveData(); showToast("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©."); setTimeout(() => location.reload(true), 1500); } else { showToast("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù."); } } catch (err) { console.error("Restore failed:", err); showToast("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ù…Ù„Ù Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØµØ§Ù„Ø­."); } }; reader.readAsText(file); event.target.value = null; }); }
        function exportTable(tableId, fileName) { const table = document.getElementById(tableId); if (!table) { console.error("Table not found!"); return; } const tableClone = table.cloneNode(true); const noPrintHeaders = Array.from(tableClone.querySelectorAll('th.no-print')); const indicesToRemove = noPrintHeaders.map(th => Array.from(th.parentNode.children).indexOf(th)); Array.from(tableClone.rows).forEach(row => { indicesToRemove.sort((a, b) => b - a).forEach(index => { if(row.cells[index]) row.deleteCell(index); }); }); const wb = XLSX.utils.table_to_book(tableClone, { sheet: "Sheet1" }); XLSX.writeFile(wb, `${fileName}.xlsx`); }
        
        const formatCurrency = (num) => new Intl.NumberFormat('ar-EG', { style: 'currency', currency: 'EGP' }).format(num || 0);
        const getTodayDate = () => new Date().toISOString().slice(0, 10);
        const showToast = (message) => { const toast = document.getElementById('toast-notification'); toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); };


// ===== Fix: missing helpers (custody/showrooms defaults + HTML escape) =====
function escapeHtml(str){
  return String(str ?? '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

function ensureCustodyDefaults(){
  // Keep the structure stable even if older DBs don't have these keys
  db.custody = Array.isArray(db.custody) ? db.custody : [];
  db.custodyEmployees = Array.isArray(db.custodyEmployees) ? db.custodyEmployees : [];
  db.custodyFiles = db.custodyFiles && typeof db.custodyFiles === 'object' ? db.custodyFiles : {};
}

function ensureShowroomsDefaults(){
  db.showrooms = Array.isArray(db.showrooms) ? db.showrooms : [];
  db.partners = Array.isArray(db.partners) ? db.partners : [];
  db.companyProfile = db.companyProfile && typeof db.companyProfile === 'object' ? db.companyProfile : {
    name: 'Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØªÙˆÙƒÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª',
    address: 'ØªÙ„Ø§ - Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©',
    phones: ['',''],
    // 3 Ù…ÙˆØ¸ÙÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ† (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ù… Ù…Ù† Ø²Ø± "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ø¶")
    employees: [
      { id: 1, name: 'Ù…ÙˆØ¸Ù 1', phone:'', nationalId:'', job:'', address:'' },
      { id: 2, name: 'Ù…ÙˆØ¸Ù 2', phone:'', nationalId:'', job:'', address:'' },
      { id: 3, name: 'Ù…ÙˆØ¸Ù 3', phone:'', nationalId:'', job:'', address:'' },
    ],
  };

  // ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù‡ÙˆØ§ØªÙ
  if(!Array.isArray(db.companyProfile.phones)) db.companyProfile.phones = ['',''];
  if(db.companyProfile.phones.length < 2) db.companyProfile.phones = [db.companyProfile.phones[0]||'', db.companyProfile.phones[1]||''];

  // ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (3 ÙÙ‚Ø·)
  const old = Array.isArray(db.companyProfile.employees) ? db.companyProfile.employees : [];
  db.companyProfile.employees = [0,1,2].map((i)=>({
    id: i+1,
    name: (old[i]?.name || `Ù…ÙˆØ¸Ù ${i+1}`),
    phone: (old[i]?.phone || ''),
    nationalId: (old[i]?.nationalId || old[i]?.nid || ''),
    job: (old[i]?.job || ''),
    address: (old[i]?.address || ''),
  }));
}

// ===== Showroom profile & employees (for contracts) =====
function openShowroomsManager(){
  ensureShowroomsDefaults();
  // fill modal inputs
  const cp = db.companyProfile || {};
  const setVal = (id, v)=>{ const el=document.getElementById(id); if(el) el.value = v ?? ''; };
  setVal('cpName', cp.name || '');
  setVal('cpAddress', cp.address || '');
  setVal('cpPhone1', cp.phones?.[0] || '');
  setVal('cpPhone2', cp.phones?.[1] || '');

  (cp.employees || []).forEach((e, idx)=>{
    const n = idx+1;
    setVal(`emp${n}Name`, e.name || '');
    setVal(`emp${n}Phone`, e.phone || '');
    setVal(`emp${n}NID`, e.nationalId || '');
    setVal(`emp${n}Job`, e.job || '');
    setVal(`emp${n}Address`, e.address || '');
  });

  openModal('showroomEmployeesModal');
}

function saveShowroomEmployees(){
  ensureShowroomsDefaults();
  const getVal = (id)=> (document.getElementById(id)?.value || '').trim();
  db.companyProfile.name = getVal('cpName') || db.companyProfile.name;
  db.companyProfile.address = getVal('cpAddress') || '';
  db.companyProfile.phones = [getVal('cpPhone1'), getVal('cpPhone2')];

  db.companyProfile.employees = [1,2,3].map((n)=>({
    id: n,
    name: getVal(`emp${n}Name`) || `Ù…ÙˆØ¸Ù ${n}`,
    phone: getVal(`emp${n}Phone`),
    nationalId: getVal(`emp${n}NID`),
    job: getVal(`emp${n}Job`),
    address: getVal(`emp${n}Address`),
  }));

  saveData();

  // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
  const empSel = document.getElementById('contractEmployeeSelect');
  if(empSel && document.getElementById('contractEditPanel')?.style.display === 'block'){
    empSel.innerHTML = '';
    (db.companyProfile.employees||[]).forEach(e=>{
      const opt=document.createElement('option');
      opt.value=e.id; opt.textContent=e.name || ('Ù…ÙˆØ¸Ù #' + e.id);
      empSel.appendChild(opt);
    });
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…ÙØªÙˆØ­ (Ø¥Ù† ÙˆÙØ¬Ø¯)
  if(typeof __currentContractSaleId !== 'undefined' && __currentContractSaleId){
    const c = ensureSaleContract(__currentContractSaleId);
    if(c){
      // Ø§Ø¬Ø¹Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
      c.showroomName = db.companyProfile.name;
      c.showroomAddress = db.companyProfile.address;
      c.showroomPhone = (db.companyProfile.phones||[]).filter(Boolean).join(' - ');

      const empId = Number(document.getElementById('contractEmployeeSelect')?.value || c.sellerEmployeeId || 1);
      c.sellerEmployeeId = empId || 1;
      const emp = (db.companyProfile.employees||[]).find(e=>Number(e.id)===Number(c.sellerEmployeeId)) || (db.companyProfile.employees||[])[0];
      if(emp){
        c.sellerName = emp.name; c.sellerPhone = emp.phone; c.sellerNationalId = emp.nationalId; c.sellerJob = emp.job; c.sellerAddress = emp.address;
      }
      const content = document.getElementById('contractContent');
      if(content) content.innerHTML = buildContractHTML(c);
    }
  }

  closeModal('showroomEmployeesModal');
  showToast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ø¶ ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', 'success');
}
// ===== End showroom profile =====

// ===== End fix =====

        const openTab = (evt, tabName) => {
            // Ø£Ø®ÙÙ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
            // ÙØ¹Ù‘Ù„ Ø§Ù„Ø²Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù† ÙˆÙØ¬Ø¯ Ø­Ø¯Ø«
            document.querySelectorAll('.tab-link').forEach(tl => tl.classList.remove('active'));
            const target = document.getElementById(tabName);
            if (target) target.style.display = 'block';

            if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
            else {
                // ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØªØ­ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ø¨Ø¯ÙˆÙ† event
                const btn = document.querySelector(`.tab-link[data-tab="${tabName}"]`);
                if (btn) btn.classList.add('active');
            }

            // Render Ù„Ù„Ù‚Ø³Ù… Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø© (ERP ready)
            try {
                if (typeof renderVisibleTab === 'function') renderVisibleTab(tabName);
                else if (typeof renderAll === 'function') renderAll(document.getElementById('globalSearch')?.value?.toLowerCase() || '');
            } catch (e) { console.error(e); }
        };
        
        const openModal = (modalId) => { 
            if (modalId === 'addPurchaseModal') {
                populateSelect('purchaseSupplier', db.suppliers);
            }
            if (modalId === 'addSaleModal') { 
                populateSelect('saleCarId', db.cars.filter(c => c.status === CAR_STATUSES.AVAILABLE)); 
                populateSelect('saleCustomerId', db.customers);
                document.getElementById('additional-charges-container').innerHTML = '';
            } 
            if (modalId === 'addArchiveModal') {
                populateSelect('archiveCarId', db.cars, true);
            }
            if (modalId === 'addQuoteModal') {
                populateSelect('quoteCarId', db.cars.filter(c => c.status === CAR_STATUSES.AVAILABLE));
                populateSelect('quoteCustomerId', db.customers);
                
                const futureDate = new Date();
                futureDate.setDate(futureDate.getDate() + 7);
                document.getElementById('quoteExpiryDate').value = futureDate.toISOString().slice(0, 10);
            }
            document.querySelectorAll('input[type="date"]').forEach(el => { if (!el.value) el.value = getTodayDate(); }); 
            document.getElementById(modalId).style.display = "flex"; 
        };
        const closeModal = (modalId) => { document.getElementById(modalId).style.display = "none"; };
        const populateSelect = (selectId, data, optional = false, nameKey = 'name') => { const select = document.getElementById(selectId); select.innerHTML = optional ? '<option value="">-- Ù…Ø³ØªÙ†Ø¯ Ø¹Ø§Ù… --</option>' : '<option value="" disabled selected>-- Ø§Ø®ØªØ± --</option>'; data.forEach(item => { let name = item.carType ? `${item.carType} ${item.carModel} ${item.modelYear}` : item[nameKey]; select.innerHTML += `<option value="${item.id}">${name}</option>`; }); };
        const openConfirmModal = (message, onConfirm) => { document.getElementById('confirmMessage').textContent = message; const confirmBtn = document.getElementById('confirmOkBtn'), cancelBtn = document.getElementById('confirmCancelBtn'), modal = document.getElementById('confirmModal'); const confirmHandler = () => { onConfirm(); closeConfirmModal(); }; const closeConfirmModal = () => { modal.style.display = 'none'; confirmBtn.removeEventListener('click', confirmHandler); cancelBtn.removeEventListener('click', closeConfirmModal); }; confirmBtn.addEventListener('click', confirmHandler); cancelBtn.addEventListener('click', closeConfirmModal); modal.style.display = 'block'; };
        
        
        // ===== Ø·Ø¨Ø§Ø¹Ø© Ù…ÙˆØ­Ù‘Ø¯Ø© (Letterhead) =====
        const buildLetterheadHTML = () => {
            // Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø¥Ù† ÙˆÙØ¬Ø¯)
            const companyEl = document.querySelector('header h1');
            const mgmtEl = document.querySelector('header p');
            const companyName = (companyEl?.textContent || 'Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØªÙˆÙƒÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª').trim();
            const mgmtLine = (mgmtEl?.textContent || 'Ø¥Ø¯Ø§Ø±Ø©: Ø§Ù„Ø­Ø§Ø¬ Ø§Ù„Ø³ÙŠØ¯ Ø²ÙŠØ§Ù† Ø´Ø§Ù…ÙŠØ© ÙˆØ§Ø¨Ùˆ Ø²ÙŠØ§Ø¯').trim();

            return `
                <div class="print-letterhead">
                    <div class="print-letterhead__inner">
                        <div class="print-letterhead__brand">
                            <div class="print-letterhead__logo" aria-hidden="true">ğŸšš</div>
                            <div class="print-letterhead__text">
                                <div class="print-letterhead__name">${companyName}</div>
                                <div class="print-letterhead__mgmt">${mgmtLine}</div>
                            </div>
                        </div>
                        <div class="print-letterhead__meta">
                            <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-EG')}</div>
                            <div>Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleTimeString('ar-EG')}</div>
                        </div>
                    </div>
                </div>
            `;
        };

        const collectPrintableHead = () => {
            const parts = [];
            parts.push('<meta charset="utf-8">');
            // Fonts
            const googleFonts = document.querySelector('link[href*="fonts.googleapis.com"]');
            if (googleFonts) parts.push(googleFonts.outerHTML);
            // Tailwind (Ø¥Ù† ÙˆØ¬Ø¯)
            const tailwindStyles = document.getElementById('tailwindcss');
            if (tailwindStyles) parts.push(tailwindStyles.outerHTML);
            // Ø¨Ù‚ÙŠØ© Ø§Ù„Ø³ØªØ§ÙŠÙ„Ø§Øª
            document.querySelectorAll('head > style:not(#tailwindcss)').forEach(s => parts.push(s.outerHTML));

            // Ø³ØªØ§ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ù„Ù€ Letterhead + Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            parts.push(`
                <style>
                    .print-letterhead{padding:16px 0 10px;margin:0 0 14px;border-bottom:2px solid #1f2937;}
                    .print-letterhead__inner{display:flex;align-items:flex-end;justify-content:space-between;gap:16px}
                    .print-letterhead__brand{display:flex;align-items:center;gap:10px}
                    .print-letterhead__logo{width:42px;height:42px;border:2px solid #16a34a;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
                    .print-letterhead__name{font-size:18px;font-weight:800;color:#1e40af;line-height:1.2}
                    .print-letterhead__mgmt{font-size:12px;color:#4b5563;margin-top:2px}
                    .print-letterhead__meta{font-size:11px;color:#374151;text-align:left}
                    .print-wrap{padding:0 18px 18px}
                    @media print{
                        .no-print{display:none!important}
                        body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size:12px; }
                        .print-wrap{padding:0}
                        .print-letterhead{break-after:avoid}
                    }
                </style>
            `);
            return parts.join('\n');
        };

        const openPrintWindow = (title, innerHtml, opts={}) => { const { letterhead=true } = opts;
            const w = window.open('', '_blank');
            if (!w) return showToast('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');

            const head = collectPrintableHead();
            const letterheadHTML = buildLetterheadHTML();

            w.document.open();
            w.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <title>${title || document.title}</title>
                    ${head}
                </head>
                <body>
                    <div class="print-wrap">
                        ${letterhead ? letterheadHTML : ''}
                        ${innerHtml}
                    </div>
                </body>
                </html>
            `);
            w.document.close();
            w.focus();
            setTimeout(() => { try { w.print(); } catch(e){} }, 250);
        };
        // ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯Ø© =====

const printContent = (elementId) => {
            const nodeToPrint = document.getElementById(elementId);
            if (!nodeToPrint) {
                console.error('Element to print not found:', elementId);
                return;
            }
            logActivity(`Ù‚Ø§Ù… Ø¨ØªÙ†ÙÙŠØ° Ø£Ù…Ø± Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„Ù‚Ø³Ù…: ${elementId}`);

            const iframe = document.createElement('iframe');
            iframe.style.position = 'absolute';
            iframe.style.width = '0';
            iframe.style.height = '0';
            iframe.style.border = '0';
            iframe.style.visibility = 'hidden';
            document.body.appendChild(iframe);

            const doc = iframe.contentWindow.document;
            doc.open();
            doc.write('<!DOCTYPE html><html lang="ar" dir="rtl"><head><title>' + document.title + '</title></head><body></body></html>');

            const googleFonts = document.querySelector('link[href*="fonts.googleapis.com"]');
            if (googleFonts) {
                doc.head.appendChild(googleFonts.cloneNode(true));
            }
            
            const tailwindStyles = document.getElementById('tailwindcss');
            if (tailwindStyles) {
                doc.head.appendChild(tailwindStyles.cloneNode(true));
            }

            const customStyles = document.querySelectorAll('head > style:not(#tailwindcss)');
            customStyles.forEach(style => {
                doc.head.appendChild(style.cloneNode(true));
            });
            
            doc.body.innerHTML = `<div class="print-wrap">${buildLetterheadHTML()}${nodeToPrint.innerHTML}</div>`;

            setTimeout(() => {
                try {
                    iframe.contentWindow.focus();
                    iframe.contentWindow.print();
                } catch (e) {
                    console.error("Print failed:", e);
                    showToast("ÙØ´Ù„Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.");
                } finally {
                    document.body.removeChild(iframe);
                }
            }, 500); 

            doc.close();
        };

        function logActivity(description) { if (!db.activityLog) db.activityLog = []; db.activityLog.push({ timestamp: new Date().toLocaleString('ar-EG'), user: currentUser.name, description: description }); }
        function toggleNotifications() { const dropdown = document.getElementById('notification-dropdown'); dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none'; }
        const getMaintenanceCostForCar = (carId) => db.maintenanceLog.filter(m => m.carId === carId).reduce((sum, m) => sum + m.cost, 0);

        const renderAll = (searchTerm = '') => { 
    const purchaseYear = document.getElementById('purchase-year-filter')?.value || 'all';
    const purchaseMonth = document.getElementById('purchase-month-filter')?.value || 'all';
    const saleYear = document.getElementById('sale-year-filter')?.value || 'all';
    const saleMonth = document.getElementById('sale-month-filter')?.value || 'all';
    const installmentCustomer = document.getElementById('inst-customer-filter')?.value || 'all';
    const archiveCarFilter = document.getElementById('archive-car-filter')?.value || 'all';

    updateSummary(); 
    renderCars(searchTerm); 
    renderPurchases(searchTerm, purchaseYear, purchaseMonth); 
    renderSales(searchTerm, saleYear, saleMonth); 
    renderQuotes(searchTerm);
    renderInstallments(searchTerm, installmentCustomer); 
    renderClients(searchTerm); 
    renderExpenses(searchTerm); 
    renderArchive(searchTerm, archiveCarFilter); 
    renderRecentActivities(); 
    populateInstallmentCustomerFilter(); 
    populateArchiveCarFilter();
    renderUpcomingAlerts();
    renderNotifications();
    renderActivityLog();
    renderInventoryAgingReport();

    // ERP modules
    if (typeof renderCustody === 'function') renderCustody();
    if (typeof renderMaintenance === 'function') renderMaintenance();
};

function renderVisibleTab(tabName){
    const searchTerm = (document.getElementById('globalSearch')?.value || '').toLowerCase();
    const purchaseYear = document.getElementById('purchase-year-filter')?.value || 'all';
    const purchaseMonth = document.getElementById('purchase-month-filter')?.value || 'all';
    const saleYear = document.getElementById('sale-year-filter')?.value || 'all';
    const saleMonth = document.getElementById('sale-month-filter')?.value || 'all';
    const installmentCustomer = document.getElementById('inst-customer-filter')?.value || 'all';
    const archiveCarFilter = document.getElementById('archive-car-filter')?.value || 'all';

    // Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¹Ø§Ù…
    updateSummary();
    renderNotifications();
    renderUpcomingAlerts();
    renderRecentActivities();
    renderActivityLog();

    if(tabName==='inventory') renderCars(searchTerm);
    if(tabName==='purchases') renderPurchases(searchTerm, purchaseYear, purchaseMonth);
    if(tabName==='sales') renderSales(searchTerm, saleYear, saleMonth);
    if(tabName==='quotes') renderQuotes(searchTerm);
    if(tabName==='installments') renderInstallments(searchTerm, installmentCustomer);
    if(tabName==='clients') renderClients(searchTerm);
    if(tabName==='contracts') renderContracts((document.getElementById('contractsSearch')?.value || '').toLowerCase());
    if(tabName==='expenses') renderExpenses(searchTerm);
    if(tabName==='archive') renderArchive(searchTerm, archiveCarFilter);
    if(tabName==='reports') { renderInventoryAgingReport(); renderFinancialAnalytics(); }
    if(tabName==='treasury') updateSummary();

    // ERP
    if(tabName==='custody' && typeof renderCustody==='function') renderCustody();
    if(tabName==='maintenance' && typeof renderMaintenance==='function') renderMaintenance();
}

// ===================== ERP: CUSTODY MODULE =====================
        const ensureMaintenanceDefaults = () => {
            if (!db.maintenanceLog) db.maintenanceLog = [];
            // Ø§Ø¹ØªØ¨Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© "Ù…Ø¯ÙÙˆØ¹Ø©" Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ø­Ø¯Ø¯Ø©
            db.maintenanceLog.forEach(l => {
                if (l && typeof l.isPaid === 'undefined') l.isPaid = true;
            });
        };


        const fillCustodyEmployeeFilter = () => {
            const sel = document.getElementById('custodyEmployeeFilter');
            if (!sel) return;
            const current = sel.value || '';
            const names = new Set();
            (db.users || []).forEach(u => u?.name && names.add(u.name));
            (db.custody || []).forEach(r => r?.employee && names.add(r.employee));
            const opts = ['<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>', ...Array.from(names).sort().map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`)];
            sel.innerHTML = opts.join('');
            sel.value = current;
        };

        const renderCustody = () => {
            ensureCustodyDefaults();
            fillCustodyEmployeeFilter();

            const q = (document.getElementById('custodySearch')?.value || '').toLowerCase();
            const emp = document.getElementById('custodyEmployeeFilter')?.value || '';
            const st = document.getElementById('custodyStatusFilter')?.value || '';
            const from = document.getElementById('custodyFrom')?.value || '';
            const to = document.getElementById('custodyTo')?.value || '';

            const rows = (db.custody || []).slice().sort((a,b)=> (b.date||'').localeCompare(a.date||''));

            const filtered = rows.filter(r => {
                if (emp && r.employee !== emp) return false;
                if (st && r.status !== st) return false;
                if (from && (r.date||'') < from) return false;
                if (to && (r.date||'') > to) return false;
                const hay = `${r.employee||''} ${r.statement||''} ${r.amount||''} ${r.notes||''}`.toLowerCase();
                if (q && !hay.includes(q)) return false;
                return true;
            });

            const openSum = (db.custody||[]).filter(r=>r.status==='open').reduce((s,r)=>s+Number(r.amount||0),0);
            const settledSum = (db.custody||[]).filter(r=>r.status==='settled').reduce((s,r)=>s+Number(r.amount||0),0);

            const setText = (id, val) => { const el=document.getElementById(id); if(el) el.textContent = typeof val==='number' ? formatCurrency(val) : String(val); };
            setText('custodyTotalOpen', openSum);
            setText('custodyTotalSettled', settledSum);
            setText('custodyCount', (db.custody||[]).length);

            const tbody = document.getElementById('custodyTableBody');
            if (!tbody) return;

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td class="p-4 text-center text-gray-500" colspan="7">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(r => {
                const badge = r.status === 'settled'
                    ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">ØªÙ… ØªØ³ÙˆÙŠØªÙ‡Ø§</span>`
                    : `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">ÙÙŠ Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…ÙˆØ¸Ù</span>`;
                return `
                    <tr class="border-t hover:bg-gray-50">
                        <td class="p-3">${escapeHtml(r.date || '')}</td>
                        <td class="p-3 font-semibold">${escapeHtml(r.employee || '')}</td>
                        <td class="p-3">${escapeHtml(r.statement || '')}</td>
                        <td class="p-3 font-bold">${formatCurrency(Number(r.amount||0))}</td>
                        <td class="p-3">${badge}</td>
                        <td class="p-3 text-gray-500">-</td>
                        <td class="p-3">
                            <div class="flex justify-center gap-2 flex-wrap">
                                ${r.status==='open' ? `<button class="btn-success btn-sm" onclick="settleCustody(${r.id})">ØªØ³ÙˆÙŠØ©</button>` : `<button class="btn-outline btn-sm" onclick="reopenCustody(${r.id})">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³ÙˆÙŠØ©</button>`}
                                <button class="btn-danger btn-sm" onclick="deleteCustody(${r.id})">Ø­Ø°Ù</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        const addCustody = (payload) => {
            ensureCustodyDefaults();
            const rec = {
                id: db.custodyCounter++,
                date: payload.date,
                employee: payload.employee,
                statement: payload.statement,
                amount: Number(payload.amount || 0),
                status: payload.status || 'open',
                notes: payload.notes || '',
                createdAt: new Date().toISOString()
            };
            db.custody.push(rec);
            logActivity(`ØµØ±Ù Ø¹Ù‡Ø¯Ø© Ù„Ù„Ù…ÙˆØ¸Ù ${rec.employee} Ø¨Ù‚ÙŠÙ…Ø© ${formatCurrency(rec.amount)}`);
            saveData();
            renderAll();
        };

        const settleCustody = (id) => {
            const rec = (db.custody||[]).find(r=>r.id===id);
            if(!rec) return;
            if(!confirm('ØªØ£ÙƒÙŠØ¯ ØªØ³ÙˆÙŠØ© Ø§Ù„Ø¹ÙÙ‡Ø¯Ø©ØŸ Ø³ÙŠØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ù„Ù„Ø£Ø±Ø´ÙŠÙ.')) return;
            rec.status='settled';
            rec.settledAt=new Date().toISOString();
            logActivity(`ØªØ³ÙˆÙŠØ© Ø¹Ù‡Ø¯Ø© Ù„Ù„Ù…ÙˆØ¸Ù ${rec.employee} Ø¨Ù‚ÙŠÙ…Ø© ${formatCurrency(rec.amount)}`);
            saveData();
            renderAll();
        };

        const reopenCustody = (id) => {
            const rec = (db.custody||[]).find(r=>r.id===id);
            if(!rec) return;
            if(!confirm('Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³ÙˆÙŠØ© ÙˆØ¥Ø±Ø¬Ø§Ø¹Ù‡Ø§ Ù„Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…ÙˆØ¸ÙØŸ')) return;
            rec.status='open';
            delete rec.settledAt;
            saveData();
            renderAll();
        };

        const deleteCustody = (id) => {
            const rec = (db.custody||[]).find(r=>r.id===id);
            if(!rec) return;
            if(!confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¹ÙÙ‡Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
            db.custody = (db.custody||[]).filter(r=>r.id!==id);
            logActivity(`Ø­Ø°Ù Ø¹Ù‡Ø¯Ø© Ù„Ù„Ù…ÙˆØ¸Ù ${rec.employee} Ø¨Ù‚ÙŠÙ…Ø© ${formatCurrency(rec.amount)}`);
            saveData();
            renderAll();
        };

        const exportCustodyCSV = () => {
            const rows = (db.custody||[]).map(r => ({
                id: r.id, date: r.date, employee: r.employee, statement: r.statement, amount: r.amount, status: r.status, notes: r.notes
            }));
            downloadCSV(rows, 'custody.csv');
        };

        // ===================== ERP: MAINTENANCE TAB (filters) =====================
        const fillMaintenanceCarFilter = () => {
            const sel = document.getElementById('maintCarFilter');
            if (!sel) return;
            const current = sel.value || '';
            const opts = ['<option value="">ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>'].concat((db.cars||[]).map(c => {
                const label = `${c.carType||''} ${c.carModel||''} (${c.vin||'Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø³ÙŠÙ‡'})`;
                return `<option value="${c.id}">${escapeHtml(label)}</option>`;
            }));
            sel.innerHTML = opts.join('');
            sel.value = current;
        };

        const renderMaintenance = () => {
            ensureMaintenanceDefaults();
            fillMaintenanceCarFilter();
            const q = (document.getElementById('maintSearch')?.value || '').toLowerCase();
            const carId = document.getElementById('maintCarFilter')?.value || '';
            const paid = document.getElementById('maintPaidFilter')?.value || '';
            const from = document.getElementById('maintFrom')?.value || '';
            const to = document.getElementById('maintTo')?.value || '';

            const logs = (db.maintenanceLog||[]).slice().sort((a,b)=> (b.date||'').localeCompare(a.date||''));

            const filtered = logs.filter(l => {
                if (carId && String(l.carId) !== String(carId)) return false;
                const isPaid = !!l.isPaid;
                if (paid==='paid' && !isPaid) return false;
                if (paid==='unpaid' && isPaid) return false;
                if (from && (l.date||'') < from) return false;
                if (to && (l.date||'') > to) return false;
                const car = (db.cars||[]).find(c=>c.id===l.carId);
                const carLabel = car ? `${car.carType||''} ${car.carModel||''} ${car.vin||''}` : '';
                const hay = `${carLabel} ${l.description||''} ${l.workshop||''} ${l.parts||''} ${l.notes||''} ${l.cost||''}`.toLowerCase();
                if (q && !hay.includes(q)) return false;
                return true;
            });

            const total = (db.maintenanceLog||[]).reduce((s,l)=>s+Number(l.cost||0),0);
            const paidSum = (db.maintenanceLog||[]).filter(l=>!!l.isPaid).reduce((s,l)=>s+Number(l.cost||0),0);
            const unpaidSum = total - paidSum;

            const setText = (id, val) => { const el=document.getElementById(id); if(el) el.textContent = formatCurrency(Number(val||0)); };
            setText('maintTotal', total);
            setText('maintPaid', paidSum);
            setText('maintUnpaid', unpaidSum);

            const tbody = document.getElementById('maintenanceTableBody');
            if(!tbody) return;
            if(filtered.length===0){
                tbody.innerHTML = `<tr><td class="p-4 text-center text-gray-500" colspan="8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
                return;
            }
            tbody.innerHTML = filtered.map(l => {
                const car = (db.cars||[]).find(c=>c.id===l.carId);
                const carLabel = car ? `${car.carType||''} ${car.carModel||''}` : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                const payBadge = l.isPaid
                    ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">Ù…Ø¯ÙÙˆØ¹</span>`
                    : `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>`;
                return `
                    <tr class="border-t hover:bg-gray-50">
                        <td class="p-3">${escapeHtml(l.date||'')}</td>
                        <td class="p-3 font-semibold">${escapeHtml(carLabel)}<div class="text-xs text-gray-500">${escapeHtml(car?.vin||'')}</div></td>
                        <td class="p-3">${escapeHtml(l.description||'')}</td>
                        <td class="p-3">${escapeHtml(l.workshop||'')}</td>
                        <td class="p-3 font-bold">${formatCurrency(Number(l.cost||0))}</td>
                        <td class="p-3">${payBadge}</td>
                        <td class="p-3 text-gray-600">${escapeHtml(l.notes||'')}</td>
                        <td class="p-3">
                            <div class="flex justify-center gap-2 flex-wrap">
                                <button class="btn-outline btn-sm" onclick="toggleMaintenancePaid(${l.id})">${l.isPaid ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹' : 'ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯ÙÙˆØ¹'}</button>
                                <button class="btn-danger btn-sm" onclick="deleteMaintenanceLog(${l.id})">Ø­Ø°Ù</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        const toggleMaintenancePaid = (id) => {
            const log = (db.maintenanceLog||[]).find(l=>l.id===id);
            if(!log) return;
            log.isPaid = !log.isPaid;
            saveData();
            renderAll();
        };

        const deleteMaintenanceLog = (id) => {
            const log = (db.maintenanceLog||[]).find(l=>l.id===id);
            if(!log) return;
            if(!confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
            db.maintenanceLog = (db.maintenanceLog||[]).filter(l=>l.id!==id);
            saveData();
            renderAll();
        };

        const exportMaintenanceCSV = () => {
            const rows = (db.maintenanceLog||[]).map(l => ({
                id:l.id, date:l.date, carId:l.carId, description:l.description, workshop:l.workshop, cost:l.cost, paid: l.isPaid?'paid':'unpaid', notes:l.notes
            }));
            downloadCSV(rows, 'maintenance.csv');
        };

        // ===================== Utilities (ERP touch) =====================
        const printSection = (tabId) => {
            const el = document.getElementById(tabId);
            if(!el) return;
            openPrintWindow('Ø·Ø¨Ø§Ø¹Ø©', el.innerHTML);
            w.focus();
            w.print();
            w.close();
        };

        const downloadCSV = (rows, filename) => {
            const esc = (v) => {
                const s = (v ?? '').toString().replace(/"/g,'""');
                return `"${s}"`;
            };
            const keys = rows.length ? Object.keys(rows[0]) : [];
            const csv = [keys.join(',')].concat(rows.map(r => keys.map(k=>esc(r[k])).join(','))).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };


        const ICONS = {
            edit: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>`,
            delete: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`,
            rollback: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4A1 1 0 017.707 3.707a1 1 0 010 1.414L5.414 7.414H9a7 7 0 110 14 1 1 0 110-2 5 5 0 000-10H5.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>`,
                        attach: `<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21.44 11.05l-8.49 8.49a5 5 0 01-7.07-7.07l9.19-9.19a3.5 3.5 0 014.95 4.95l-9.9 9.9a2 2 0 01-2.83-2.83l8.49-8.49"/></svg>`,
            details: `<svg class="w-5 h-5 text-gray-500 hover:text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`,
            invoice: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
            receipt: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>`,
            print: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"></path></svg>`,
            whatsapp: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413 0 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.687-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.267.655 4.398 1.803 6.12l-1.215 4.433 4.515-1.182z"></path></svg>`,
            addPayment: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            view: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`
        };

        const renderCars = (filter) => { const tbody = document.querySelector("#inventory-table tbody"); tbody.innerHTML = ""; db.cars.filter(c => `${c.carType} ${c.carModel}`.toLowerCase().includes(filter) || c.vin.toLowerCase().includes(filter)).sort((a,b) => b.id - a.id).forEach(car => { const totalCost = car.purchasePrice + getMaintenanceCostForCar(car.id); const carName = `${car.carType} ${car.carModel}`; let statusClass; switch(car.status) { case CAR_STATUSES.SOLD: statusClass = 'bg-red-200 text-red-800'; break; case CAR_STATUSES.RESERVED: statusClass = 'bg-yellow-200 text-yellow-800'; break; default: statusClass = 'bg-green-200 text-green-800'; } tbody.innerHTML += `<tr class="border-b hover:bg-gray-50 ${car.status === CAR_STATUSES.SOLD ? 'opacity-60' : ''}"><td data-label="Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù" class="p-3 font-bold text-blue-600">#${car.fileNumber}</td><td data-label="Ø§Ù„Ø³ÙŠØ§Ø±Ø©" class="p-3 font-semibold">${carName}</td><td data-label="Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹" class="p-3">${car.modelYear}</td><td data-label="Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡" class="p-3">${car.vin}</td><td data-label="Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©" class="p-3 font-bold">${formatCurrency(totalCost)}</td><td data-label="Ø§Ù„Ø­Ø§Ù„Ø©" class="p-3"><span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">${car.status}</span></td><td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3 no-print"><div class="flex justify-center items-center gap-4"><button onclick="openCarDetailsModal(${car.id})" title="Ù…Ù„Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø©">${ICONS.details}</button><button onclick="openCarDocsModal(${car.id})" title="Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©" class="text-slate-700">${ICONS.attach}</button><button onclick="openEditPurchaseModal(${car.id})" title="ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡" class="text-blue-600">${ICONS.edit}</button><button onclick="openEditCarModal(${car.id})" title="ØªØ¹Ø¯ÙŠÙ„" class="text-blue-600">${ICONS.edit}</button><button onclick="deleteCar(${car.id})" title="Ø­Ø°Ù" class="text-red-600">${ICONS.delete}</button></div></td></tr>`; }); };
        const renderPurchases = (filter, year, month) => { const tbody = document.querySelector("#purchases-table tbody"); tbody.innerHTML = ""; db.cars.filter(car => { const supplier = db.suppliers.find(s=>s.id === car.supplierId); const searchMatch = `${car.carType} ${car.carModel}`.toLowerCase().includes(filter) || (supplier?.name.toLowerCase() || '').includes(filter); const yearMatch = year === 'all' || car.date.startsWith(year); const monthMatch = month === 'all' || new Date(car.date).getMonth() + 1 == month; return searchMatch && yearMatch && monthMatch; }).sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(car => { const carName = `${car.carType} ${car.carModel} ${car.modelYear}`; const supplier = db.suppliers.find(s => s.id === car.supplierId); tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®" class="p-3">${car.date}</td><td data-label="Ø§Ù„Ø³ÙŠØ§Ø±Ø©" class="p-3">${carName}</td><td data-label="Ø§Ù„Ù…ÙˆØ±Ø¯" class="p-3">${supplier?.name || ''}</td><td data-label="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡" class="p-3 font-bold">${formatCurrency(car.purchasePrice)}</td><td data-label="Ø£Ø¶ÙŠÙ Ø¨ÙˆØ§Ø³Ø·Ø©" class="p-3 text-xs text-gray-500">${car.createdBy || ''}</td><td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3 no-print"><div class="flex justify-center items-center gap-4"><button onclick="showInvoice('purchase', ${car.id})" title="Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡" class="text-emerald-600">${ICONS.invoice}</button><button onclick="openCarDetailsModal(${car.id})" title="Ù…Ù„Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø©">${ICONS.details}</button><button onclick="openCarDocsModal(${car.id})" title="Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©" class="text-slate-700">${ICONS.attach}</button><button onclick="openEditPurchaseModal(${car.id})" title="ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡" class="text-blue-600">${ICONS.edit}</button><button onclick="cancelPurchaseTransaction(${car.id})" title="Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡" class="text-red-600">${ICONS.rollback}</button></div></td></tr>`; }); };
        const renderSales = (filter, year, month) => { const tbody = document.querySelector("#sales-table tbody"); tbody.innerHTML = ""; db.sales.filter(sale => { const car = db.cars.find(c => c.id === sale.carId); const customer = db.customers.find(c => c.id === sale.customerId); const searchMatch = (car && `${car.carType} ${car.carModel}`.toLowerCase().includes(filter)) || (customer && customer.name.toLowerCase().includes(filter)); const yearMatch = year === 'all' || sale.date.startsWith(year); const monthMatch = month === 'all' || new Date(sale.date).getMonth() + 1 == month; return searchMatch && yearMatch && monthMatch; }).sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(sale => { const car = db.cars.find(c => c.id === sale.carId); const customer = db.customers.find(c => c.id === sale.customerId); const maintenanceCost = car ? getMaintenanceCostForCar(car.id) : 0; const totalCost = car ? car.purchasePrice + maintenanceCost : 0; const totalSalePrice = sale.salePrice + (sale.additionalCharges || []).reduce((sum, charge) => sum + charge.amount, 0); const profit = totalSalePrice - totalCost; const carName = car ? `${car.carType} ${car.carModel} ${car.modelYear}` : 'Ù…Ø­Ø°ÙˆÙ'; tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®" class="p-3">${sale.date}</td><td data-label="Ø§Ù„Ø³ÙŠØ§Ø±Ø©" class="p-3">${carName}</td><td data-label="Ø§Ù„Ù…Ø´ØªØ±ÙŠ" class="p-3">${customer?.name || 'Ù…Ø­Ø°ÙˆÙ'}</td><td data-label="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹" class="p-3 font-bold">${formatCurrency(totalSalePrice)}</td><td data-label="Ø§Ù„Ø±Ø¨Ø­" class="p-3 font-bold ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(profit)}</td><td data-label="Ø£Ø¶ÙŠÙ Ø¨ÙˆØ§Ø³Ø·Ø©" class="p-3 text-xs text-gray-500">${sale.createdBy || ''}</td><td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3 no-print"><div class="flex justify-center items-center gap-3"><button onclick="showInvoice('sale', ${sale.id})" title="Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹" class="text-emerald-600">${ICONS.invoice}</button><button onclick="openContractModal(${sale.id})" title="Ø¹Ù‚Ø¯ Ø§Ù„Ø¨ÙŠØ¹" class="text-indigo-600">${ICONS.fileText || ICONS.invoice}</button><button onclick="openEditSaleModal(${sale.id})" title="ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹" class="text-blue-600">${ICONS.edit}</button><button onclick="deleteSale(${sale.id})" title="Ø§Ø±Ø¬Ø¹ / Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨ÙŠØ¹" class="text-orange-600">${ICONS.rollback}</button></div></td></tr>`; }); };
        const renderInstallments = (filter, customerFilterId) => { const tbody = document.querySelector("#installments-table tbody"); tbody.innerHTML = ""; const today = new Date(); today.setHours(0,0,0,0); const searchFilter = filter.toLowerCase(); db.installments.filter(inst => { const sale = db.sales.find(s => s.id === inst.saleId); if (!sale) return false; const customerMatch = (customerFilterId === 'all' || sale.customerId == customerFilterId); if (!customerMatch) return false; if (searchFilter) { const car = db.cars.find(c => c.id === sale.carId); const customer = db.customers.find(c => c.id === sale.customerId); const searchTermMatch = (car && `${car.carType} ${car.carModel}`.toLowerCase().includes(searchFilter)) || (customer && customer.name.toLowerCase().includes(searchFilter)); return searchTermMatch; } return true; }).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).forEach(inst => { const sale = db.sales.find(s => s.id === inst.saleId); const car = db.cars.find(c => c.id === sale.carId); const customer = db.customers.find(c => c.id === sale.customerId); const dueDate = new Date(inst.dueDate); const isOverdue = dueDate < today && !inst.paid; const carName = car ? `${car.carType} ${car.carModel}` : 'Ù…Ø­Ø°ÙˆÙ'; let actionButton = ''; if (inst.paid) { actionButton = `<button onclick="showInvoice('installment', ${inst.id})" title="Ø·Ø¨Ø§Ø¹Ø© Ø¥ÙŠØµØ§Ù„" class="text-indigo-600 flex items-center gap-1">${ICONS.receipt} Ø·Ø¨Ø§Ø¹Ø©</button>`; } else { const totalSalePrice = sale.salePrice + (sale.additionalCharges || []).reduce((sum, charge) => sum + charge.amount, 0); const totalLoanAmount = totalSalePrice - sale.downPayment; const allInstallmentsForSale = db.installments.filter(i => i.saleId === inst.saleId); const totalPaidForSale = allInstallmentsForSale.filter(i => i.paid).reduce((sum, i) => sum + i.amount, 0); const remainingBalanceForSale = totalLoanAmount - totalPaidForSale; const whatsappMessage = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${customer?.name}ØŒ\nÙ†ÙˆØ¯ ØªØ°ÙƒÙŠØ±ÙƒÙ… Ø¨Ù…ÙˆØ¹Ø¯ Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ù‚Ø³Ø· Ø³ÙŠØ§Ø±Ø© ${carName} Ø¨Ù‚ÙŠÙ…Ø© ${formatCurrency(inst.amount)} Ø¨ØªØ§Ø±ÙŠØ® ${inst.dueDate}.\n\nØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„ÙŠÙƒÙ… Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù‡Ùˆ ${formatCurrency(remainingBalanceForSale)}.\nØ´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§ÙˆÙ†ÙƒÙ….`; const whatsappLink = `https://wa.me/2${customer?.phone}?text=${encodeURIComponent(whatsappMessage)}`; actionButton = `<div class="flex items-center justify-center gap-2"><button onclick="payInstallment(${inst.id})" class="bg-emerald-500 text-white px-3 py-1 rounded text-sm hover:bg-emerald-600">ØªØ³Ø¯ÙŠØ¯</button><a href="${whatsappLink}" target="_blank" title="Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± ÙˆØ§ØªØ³Ø§Ø¨" class="text-green-500 hover:text-green-700">${ICONS.whatsapp}</a></div>`; } tbody.innerHTML += `<tr class="border-b hover:bg-gray-50 ${inst.paid ? 'bg-green-50 opacity-60' : ''} ${isOverdue ? 'overdue' : ''}"><td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„" class="p-3">${customer?.name || ''}</td><td data-label="Ø§Ù„Ø³ÙŠØ§Ø±Ø©" class="p-3">${carName}</td><td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚" class="p-3">${inst.dueDate}</td><td data-label="Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø³Ø·" class="p-3 font-bold">${formatCurrency(inst.amount)}</td><td data-label="Ø§Ù„Ø­Ø§Ù„Ø©" class="p-3 font-semibold ${inst.paid ? 'text-green-600' : isOverdue ? 'text-red-700' : 'text-orange-500'}">${inst.paid ? 'ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯' : (isOverdue ? 'Ù…ØªØ£Ø®Ø±' : 'Ù„Ù… ÙŠØ³Ø¯Ø¯')}</td><td data-label="Ø¥Ø¬Ø±Ø§Ø¡" class="p-3 no-print">${actionButton}</td></tr>`; }); const totalDue = db.installments.reduce((sum, i) => sum + i.amount, 0); const totalPaid = db.installments.filter(i => i.paid).reduce((sum, i) => sum + i.amount, 0); document.getElementById('inst-total-due').textContent = formatCurrency(totalDue); document.getElementById('inst-total-paid').textContent = formatCurrency(totalPaid); document.getElementById('inst-total-remaining').textContent = formatCurrency(totalDue - totalPaid); };
        const renderClients = (filter) => { const renderPersonTable = (type, tableId) => { const tbody = document.querySelector(`#${tableId} tbody`); tbody.innerHTML = ""; db[type].filter(p => p.name.toLowerCase().includes(filter) || (p.phone && p.phone.includes(filter))).forEach(p => { let actions; if (type === 'customers') { actions = `<div class="flex justify-center items-center gap-3"><button onclick="showPersonStatement(${p.id}, '${type}')" title="ÙƒØ´Ù Ø­Ø³Ø§Ø¨" class="text-indigo-600">${ICONS.invoice}</button><button onclick="openEditPersonModal(${p.id}, '${type}')" title="ØªØ¹Ø¯ÙŠÙ„" class="text-blue-600">${ICONS.edit}</button><button onclick="deletePerson(${p.id}, '${type}')" title="Ø­Ø°Ù" class="text-red-600">${ICONS.delete}</button></div>`; } else { actions = `<div class="flex justify-center items-center gap-2"><button onclick="openAddSupplierPaymentModal(${p.id})" title="Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©" class="text-green-600">${ICONS.addPayment}</button><button onclick="showPersonStatement(${p.id}, '${type}')" title="ÙƒØ´Ù Ø­Ø³Ø§Ø¨" class="text-indigo-600">${ICONS.invoice}</button><button onclick="openEditPersonModal(${p.id}, '${type}')" title="ØªØ¹Ø¯ÙŠÙ„" class="text-blue-600">${ICONS.edit}</button><button onclick="deletePerson(${p.id}, '${type}')" title="Ø­Ø°Ù" class="text-red-600">${ICONS.delete}</button></div>`; } const balanceInfo = (type === 'customers') ? getCustomerBalanceInfo(p.id) : getSupplierBalanceInfo(p.id);
                    tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td data-label="Ø§Ù„Ø§Ø³Ù…" class="p-3">${p.name}</td><td data-label="Ø§Ù„Ù‡Ø§ØªÙ" class="p-3">${p.phone || ''}</td><td data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" class="p-3">${p.address || ''}</td><td data-label="Ø§Ù„Ø±ØµÙŠØ¯" class="p-3 font-bold ${balanceInfo.className}">${balanceInfo.label}</td><td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3 no-print">${actions}</td></tr>`; }); }; renderPersonTable('customers', 'customers-table'); renderPersonTable('suppliers', 'suppliers-table'); };
        const renderExpenses = (filter) => { const tbody = document.querySelector("#expenses-table tbody"); tbody.innerHTML = ""; db.expenses.filter(e => e.description.toLowerCase().includes(filter)).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(exp => { const rowClass = exp.type === 'ØµÙŠØ§Ù†Ø©' ? 'maintenance-expense' : ''; tbody.innerHTML += `<tr class="border-b hover:bg-gray-50 ${rowClass}"><td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®" class="p-3">${exp.date}</td><td data-label="Ø§Ù„Ø¨ÙŠØ§Ù†" class="p-3">${exp.description}</td><td data-label="Ø§Ù„Ù…Ø¨Ù„Øº" class="p-3 text-red-600 font-semibold">${formatCurrency(exp.amount)}</td><td data-label="Ø£Ø¶ÙŠÙ Ø¨ÙˆØ§Ø³Ø·Ø©" class="p-3 text-xs text-gray-500">${exp.createdBy || ''}</td><td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3 no-print"><div class="flex justify-center items-center gap-3"><button onclick="printExpenseInvoice(${exp.id})" title="Ø·Ø¨Ø§Ø¹Ø© Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ" class="text-gray-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6v-8z"/></svg></button><button onclick="openEditExpenseModal(${exp.id})" title="ØªØ¹Ø¯ÙŠÙ„" class="text-blue-600">${ICONS.edit}</button><button onclick="deleteExpense(${exp.id})" title="Ø­Ø°Ù" class="text-red-600">${ICONS.delete}</button></div></td></tr>`; }); };
        const renderArchive = (filter, carFilterId) => { const tbody = document.querySelector("#archive-table tbody"); tbody.innerHTML = ""; const searchFilter = filter.toLowerCase(); db.archive.filter(item => { const carMatch = (carFilterId === 'all' || item.carId == carFilterId); if (!carMatch) return false; const searchMatch = item.title.toLowerCase().includes(searchFilter) || item.description.toLowerCase().includes(searchFilter); return searchMatch; }).sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(item => { let linkedCarName = 'Ù…Ø³ØªÙ†Ø¯ Ø¹Ø§Ù…'; if (item.carId) { const car = db.cars.find(c => c.id === item.carId); if (car) { linkedCarName = `${car.carType} ${car.carModel}`; } else { linkedCarName = 'Ø³ÙŠØ§Ø±Ø© Ù…Ø­Ø°ÙˆÙØ©'; } } tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®" class="p-3">${item.date}</td><td data-label="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯" class="p-3 font-semibold">${item.title}</td><td data-label="Ø§Ù„ÙˆØµÙ" class="p-3 text-gray-600">${item.description}</td><td data-label="Ù…Ø±ØªØ¨Ø· Ø¨Ù€" class="p-3 text-blue-700">${linkedCarName}</td><td data-label="Ø£Ø¶ÙŠÙ Ø¨ÙˆØ§Ø³Ø·Ø©" class="p-3 text-xs text-gray-500">${item.createdBy || ''}</td><td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3 no-print"><div class="flex justify-center items-center gap-4"><a href="${item.link}" target="_blank" onclick="logActivity('Ø¹Ø±Ø¶ Ù…Ø³ØªÙ†Ø¯ Ø£Ø±Ø´ÙŠÙ: ${item.title}')" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯" class="text-blue-600 hover:text-blue-800">${ICONS.view}</a><button onclick="deleteArchiveItem(${item.id})" title="Ø­Ø°Ù" class="text-red-600">${ICONS.delete}</button></div></td></tr>`; }); };
        const renderRecentActivities = () => { const container = document.getElementById('recent-activities'); container.innerHTML = ""; const activities = [...db.sales.map(s => ({ ...s, type: 'sale' })), ...db.cars.map(p => ({ ...p, type: 'purchase' }))].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 4); activities.forEach(act => { let html = ''; if (act.type === 'sale') { const car = db.cars.find(c => c.id === act.carId); const carName = car ? `${car.carType} ${car.carModel}` : ''; const totalSalePrice = act.salePrice + (act.additionalCharges || []).reduce((sum, charge) => sum + charge.amount, 0); html = `<div class="flex items-center gap-4"><div class="w-10 h-10 bg-emerald-100 text-emerald-600 flex items-center justify-center rounded-full font-bold">Ø¨ÙŠØ¹</div><div><p>Ø¨ÙŠØ¹ Ø³ÙŠØ§Ø±Ø© <strong>${carName}</strong> Ø¨Ø³Ø¹Ø± ${formatCurrency(totalSalePrice)}</p><p class="text-sm text-gray-500">${act.date}</p></div></div>`; } else { const carName = `${act.carType} ${act.carModel}`; html = `<div class="flex items-center gap-4"><div class="w-10 h-10 bg-blue-100 text-blue-600 flex items-center justify-center rounded-full font-bold">Ø´Ø±Ø§Ø¡</div><div><p>Ø´Ø±Ø§Ø¡ Ø³ÙŠØ§Ø±Ø© <strong>${carName}</strong> Ø¨Ø³Ø¹Ø± ${formatCurrency(act.purchasePrice)}</p><p class="text-sm text-gray-500">${act.date}</p></div></div>`; } container.innerHTML += html; }); };
        const updateSummary = () => { 
            const stockValue = db.cars.filter(c => c.status !== CAR_STATUSES.SOLD).reduce((sum, car) => sum + car.purchasePrice + getMaintenanceCostForCar(car.id), 0); 
            let totalProfits = 0; 
            db.sales.forEach(sale => { const car = db.cars.find(c => c.id === sale.carId); const maintenanceCost = car ? getMaintenanceCostForCar(car.id) : 0; const cost = car ? car.purchasePrice + maintenanceCost : 0; const totalSalePrice = sale.salePrice + (sale.additionalCharges || []).reduce((sum, charge) => sum + charge.amount, 0); totalProfits += totalSalePrice - cost; }); 
            const cashSalesInflow = db.sales.filter(s => s.saleType === 'Ù†Ù‚Ø¯ÙŠ').reduce((sum, s) => { const totalSalePrice = s.salePrice + (s.additionalCharges || []).reduce((chargeSum, charge) => chargeSum + charge.amount, 0); return sum + totalSalePrice; }, 0); 
            const installmentDownPaymentsInflow = db.sales.filter(s => (s.saleType === 'ØªÙ‚Ø³ÙŠØ·' || s.saleType === 'Ø¯ÙØ¹Ø§Øª')).reduce((sum, s) => sum + (s.downPayment || 0), 0); 
            const paidInstallmentsInflow = db.installments.filter(i => i.paid).reduce((sum, i) => sum + i.amount, 0); 
            const totalInflow = cashSalesInflow + installmentDownPaymentsInflow + paidInstallmentsInflow; 
            
            const maintenanceOutflow = (db.maintenanceLog||[]).filter(m => (typeof m.isPaid==='undefined') ? true : !!m.isPaid).reduce((sum, m) => sum + Number(m.cost||0), 0); 
            const generalExpensesOutflow = db.expenses.filter(e => e.type !== 'ØµÙŠØ§Ù†Ø©').reduce((sum, e) => sum + e.amount, 0); 
            const supplierPaymentsOutflow = db.supplierPayments.reduce((sum, p) => sum + p.amount, 0); 
            
            const custodyOutflow = (db.custody||[]).reduce((sum, r) => sum + Number(r.amount||0), 0);
            const totalOutflow = maintenanceOutflow + generalExpensesOutflow + supplierPaymentsOutflow + custodyOutflow; 
            
            const balance = totalInflow - totalOutflow; 
            const totalSupplierPurchases = db.cars.reduce((sum, car) => sum + car.purchasePrice, 0); 
            const totalSupplierPayments = db.supplierPayments.reduce((sum, p) => sum + p.amount, 0); 
            const supplierDues = totalSupplierPurchases - totalSupplierPayments; 
            
            document.getElementById('db-stock-value').textContent = formatCurrency(stockValue); 
            document.getElementById('db-total-profits').textContent = formatCurrency(totalProfits); 
            document.getElementById('db-balance').textContent = formatCurrency(balance); 
            document.getElementById('db-supplier-dues').textContent = formatCurrency(supplierDues); 
            document.getElementById('t-total-inflow').textContent = formatCurrency(totalInflow); 
            document.getElementById('t-total-outflow').textContent = formatCurrency(totalOutflow); 
            document.getElementById('t-balance').textContent = formatCurrency(balance); 
        };
        const renderUpcomingAlerts = () => {
            const container = document.getElementById('upcoming-alerts');
            container.innerHTML = '';
            let alerts = [];
            const today = new Date();
            const alertDays = 30;

            const sevenDaysFromNow = new Date();
            sevenDaysFromNow.setDate(today.getDate() + 7);
            const upcomingInstallments = db.installments.filter(inst => {
                const dueDate = new Date(inst.dueDate);
                return !inst.paid && dueDate >= today && dueDate <= sevenDaysFromNow;
            }).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
            upcomingInstallments.forEach(inst => {
                const sale = db.sales.find(s => s.id === inst.saleId);
                const car = db.cars.find(c => c.id === sale.carId);
                const customer = db.customers.find(c => c.id === sale.customerId);
                const carName = car ? `${car.carType} ${car.carModel}` : 'Ù…Ø­Ø°ÙˆÙ';
                alerts.push(`<div class="flex justify-between items-center border-b pb-2"><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div><div><p class="font-semibold">Ù‚Ø³Ø· Ù‚Ø§Ø¯Ù…: ${customer?.name || ''}</p><p class="text-sm text-gray-500">${carName} - ${inst.dueDate}</p></div></div><div class="font-bold text-red-600">${formatCurrency(inst.amount)}</div></div>`);
            });

            db.cars.filter(c => c.status !== CAR_STATUSES.SOLD).forEach(car => {
                ['licenseExpiryDate', 'insuranceExpiryDate'].forEach(docType => {
                    if (car[docType]) {
                        const expiryDate = new Date(car[docType]);
                        const timeDiff = expiryDate.getTime() - today.getTime();
                        const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        if (dayDiff > 0 && dayDiff <= alertDays) {
                             const docName = docType === 'licenseExpiryDate' ? 'Ø±Ø®ØµØ©' : 'ØªØ£Ù…ÙŠÙ†';
                             const carName = `${car.carType} ${car.carModel}`;
                             alerts.push(`<div class="flex justify-between items-center border-b pb-2"><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-yellow-500"></div><div><p class="font-semibold">Ø§Ù†ØªÙ‡Ø§Ø¡ ${docName}: ${carName}</p><p class="text-sm text-gray-500">ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ ${car[docType]} (Ø®Ù„Ø§Ù„ ${dayDiff} ÙŠÙˆÙ…)</p></div></div><div class="font-bold text-yellow-600">ØªÙ†Ø¨ÙŠÙ‡</div></div>`);
                        }
                    }
                });
            });

            if (alerts.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
            } else {
                container.innerHTML = alerts.join('');
            }
        }
        const populateFilterDropdowns = () => { const purchaseYears = new Set(db.cars.map(c => c.date.substring(0, 4))); const salesYears = new Set(db.sales.map(s => s.date.substring(0, 4))); const populate = (selectId, years) => { const select = document.getElementById(selectId); select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>'; [...years].sort().reverse().forEach(year => select.innerHTML += `<option value="${year}">${year}</option>`); }; populate('purchase-year-filter', purchaseYears); populate('sale-year-filter', salesYears); const monthSelects = ['purchase-month-filter', 'sale-month-filter']; monthSelects.forEach(id => { const select = document.getElementById(id); select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>'; for (let i = 1; i <= 12; i++) { select.innerHTML += `<option value="${i}">Ø´Ù‡Ø± ${i}</option>`; } }); };
        const populateInstallmentCustomerFilter = () => { const select = document.getElementById('inst-customer-filter'); if(!select) return; const currentValue = select.value; select.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>'; const customersWithInstallments = new Set(db.sales.filter(s => (s.saleType === 'ØªÙ‚Ø³ÙŠØ·' || s.saleType === 'Ø¯ÙØ¹Ø§Øª')).map(s => s.customerId)); db.customers.filter(c => customersWithInstallments.has(c.id)).forEach(c => { select.innerHTML += `<option value="${c.id}">${c.name}</option>`; }); select.value = currentValue; };
        const populateArchiveCarFilter = () => { const select = document.getElementById('archive-car-filter'); if (!select) return; const currentValue = select.value; select.innerHTML = '<option value="all">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</option>'; db.cars.forEach(car => { select.innerHTML += `<option value="${car.id}">${car.carType} ${car.carModel} (${car.vin})</option>`; }); select.value = currentValue; };
        const printInstallmentStatement = () => { const customerId = document.getElementById('inst-customer-filter').value; if (customerId === 'all') { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„ Ù„Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨.'); return; } const customer = db.customers.find(c => c.id == customerId); showPersonStatement(customer.id, 'customers');};
        function getNextId(arrayName) { const allIds = [0, ...db[arrayName].map(i => i.id)]; return Math.max(...allIds) + 1; }
        function getNextInvoiceNumber() { const nextNum = db.invoiceCounter++; saveData(); return nextNum; }
        
        function renderNotifications() {
            const list = document.getElementById('notification-list');
            const countBadge = document.getElementById('notification-count');
            list.innerHTML = '';
            let notifications = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const alertDays = 30;

            const overdueInstallments = db.installments.filter(inst => !inst.paid && new Date(inst.dueDate) < today);
            overdueInstallments.forEach(inst => {
                const sale = db.sales.find(s => s.id === inst.saleId);
                const customer = db.customers.find(c => c.id === sale.customerId);
                notifications.push(`<div class="p-3 hover:bg-gray-50"><p class="font-semibold text-red-600">Ù‚Ø³Ø· Ù…ØªØ£Ø®Ø±</p><p class="text-sm text-gray-700">Ù„Ù„Ø¹Ù…ÙŠÙ„: <strong>${customer?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong></p><p class="text-sm text-gray-500">Ù…Ø¨Ù„Øº ${formatCurrency(inst.amount)} | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚: ${inst.dueDate}</p></div>`);
            });

            const sevenDaysFromNow = new Date();
            sevenDaysFromNow.setDate(today.getDate() + 7);
            const upcomingInstallments = db.installments.filter(inst => !inst.paid && new Date(inst.dueDate) >= today && new Date(inst.dueDate) <= sevenDaysFromNow);
            upcomingInstallments.forEach(inst => {
                const sale = db.sales.find(s => s.id === inst.saleId);
                const customer = db.customers.find(c => c.id === sale.customerId);
                notifications.push(`<div class="p-3 hover:bg-gray-50"><p class="font-semibold text-blue-600">Ù‚Ø³Ø· Ù‚Ø§Ø¯Ù…</p><p class="text-sm text-gray-700">Ù„Ù„Ø¹Ù…ÙŠÙ„: <strong>${customer?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong></p><p class="text-sm text-gray-500">Ù…Ø¨Ù„Øº ${formatCurrency(inst.amount)} | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚: ${inst.dueDate}</p></div>`);
            });

            db.cars.filter(c => c.status !== CAR_STATUSES.SOLD).forEach(car => {
                 ['licenseExpiryDate', 'insuranceExpiryDate'].forEach(docType => {
                    if (car[docType]) {
                        const expiryDate = new Date(car[docType]);
                        const timeDiff = expiryDate.getTime() - today.getTime();
                        const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        if (dayDiff <= alertDays) {
                             const docName = docType === 'licenseExpiryDate' ? 'Ø±Ø®ØµØ©' : 'ØªØ£Ù…ÙŠÙ†';
                             const statusText = dayDiff <= 0 ? 'Ù…Ù†ØªÙ‡ÙŠØ©' : `Ø³ØªÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ ${dayDiff} ÙŠÙˆÙ…`;
                             notifications.push(`<div class="p-3 hover:bg-gray-50"><p class="font-semibold text-yellow-600">${docName} ${statusText}</p><p class="text-sm text-gray-700">Ø³ÙŠØ§Ø±Ø©: <strong>${car.carType} ${car.carModel}</strong></p><p class="text-sm text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ${car[docType]}</p></div>`);
                        }
                    }
                });
            });

            if (notifications.length > 0) {
                countBadge.textContent = notifications.length;
                countBadge.style.display = 'flex';
                list.innerHTML = notifications.join('');
            } else {
                countBadge.style.display = 'none';
                list.innerHTML = '<p class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</p>';
            }
        }
        function renderActivityLog() { const tbody = document.querySelector("#activity-log-table tbody"); tbody.innerHTML = ""; [...db.activityLog].reverse().slice(0, 200).forEach(log => { tbody.innerHTML += `<tr class="border-b hover:bg-gray-50"><td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª" class="p-3 text-sm text-gray-500">${log.timestamp}</td><td data-label="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="p-3 font-semibold">${log.user}</td><td data-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡" class="p-3 text-right">${log.description}</td></tr>`; }); }

        // --- Action Handlers ---
        
        /**
         * ## THIS FUNCTION HAS BEEN FIXED TO PREVENT DUPLICATE BUTTONS ##
         * The corrected function to open the car details modal.
         * It now removes old action buttons before adding new ones.
        */
        const openCarDetailsModal = (carId) => {
            const car = db.cars.find(c => c.id === carId);
            if (!car) return;

            // FIX: Remove any old action buttons container before proceeding
            const oldButtons = document.querySelector('#carDetailsModal .modal-actions-container');
            if (oldButtons) {
                oldButtons.remove();
            }

            const supplier = db.suppliers.find(s => s.id === car.supplierId);
            const maintenanceLog = db.maintenanceLog.filter(m => m.carId === carId).sort((a,b) => new Date(b.date) - new Date(a.date));
            const maintenanceCost = getMaintenanceCostForCar(carId);
            const sale = db.sales.find(s => s.carId === carId);
            const customer = sale ? db.customers.find(c => c.id === sale.customerId) : null;
            const totalCost = car.purchasePrice + maintenanceCost;
            let profit = 0;
            let totalSalePrice = 0;
            if(sale) {
                totalSalePrice = sale.salePrice + (sale.additionalCharges || []).reduce((sum, charge) => sum + charge.amount, 0);
                profit = totalSalePrice - totalCost;
            }

            let maintenanceHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ ØµÙŠØ§Ù†Ø© Ù…Ø³Ø¬Ù„Ø©.</p>';
            if(maintenanceLog.length > 0) {
                maintenanceHTML = `<div class="overflow-x-auto"><table class="w-full text-xs text-center">
                    <thead class="bg-gray-200"><tr>
                    <th class="p-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-2">Ø§Ù„Ø¨ÙŠØ§Ù†</th><th class="p-2">Ø§Ù„ÙˆØ±Ø´Ø©</th><th class="p-2">Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</th><th class="p-2">Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                    </tr></thead><tbody>
                    ${maintenanceLog.map(m => `
                    <tr class="border-b"><td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®" class="p-2">${m.date}</td><td data-label="Ø§Ù„Ø¨ÙŠØ§Ù†" class="p-2">${m.description}</td><td data-label="Ø§Ù„ÙˆØ±Ø´Ø©" class="p-2">${m.workshop || '-'}</td><td data-label="Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±" class="p-2">${m.parts || '-'}</td><td data-label="Ø§Ù„ØªÙƒÙ„ÙØ©" class="p-2 font-bold">${formatCurrency(m.cost)}</td></tr>`).join('')}
                    </tbody></table></div>
                    <div class="text-right font-bold mt-2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatCurrency(maintenanceCost)}</div>`
            }
            
            const carIsAvailable = car.status === CAR_STATUSES.AVAILABLE;
            
            // FIX: Buttons are wrapped in a new div with a specific class for easy removal.
            const buttonsHTML = `
                <div class="modal-actions-container text-center mt-6 no-print">
                    ${carIsAvailable ? `<button onclick="openAddQuoteModal(${car.id})" class="bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø³Ø¹Ø± +</button>` : ''}
                    <button id="addMaintenanceBtn" class="bg-orange-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-orange-600 ml-4">Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø© +</button>
                    <button onclick="printContent('carDetailsContent')" class="bg-blue-600 text-white font-bold py-2 px-8 rounded-lg hover:bg-blue-700 ml-4">Ø·Ø¨Ø§Ø¹Ø©</button>
                </div>`;

            let html = `<div id="carDetailsContent" class="print-area"><h3 class="text-2xl font-bold mb-4 border-b pb-2 text-blue-700">Ù…Ù„Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${car.carType} ${car.carModel} ${car.modelYear} (#${car.fileNumber})</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-sm mb-4">
                    <div><strong>Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡:</strong> ${car.vin}</div><div><strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ø§ØªÙˆØ±:</strong> ${car.engineNumber || '-'}</div><div><strong>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©:</strong> ${car.plateNumber || '-'}</div>
                    <div><strong>Ø§Ù„Ù„ÙˆÙ†:</strong> ${car.color}</div>
                    <div><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡:</strong> ${car.carCondition}</div>
                    <div class="font-bold text-lg"><strong>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</strong> ${formatCurrency(totalCost)}</div>
                    <div><strong>Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡:</strong> ${car.purchaseOdometer || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'} ÙƒÙ…</div>
                    <div><strong>Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¹:</strong> ${sale?.saleOdometer || 'ØºÙŠØ± Ù…Ø¨Ø§Ø¹Ø©'} ÙƒÙ…</div>
                    <div><strong>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø®ØµØ©:</strong> ${car.licenseExpiryDate || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</div>
                    <div><strong>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ£Ù…ÙŠÙ†:</strong> ${car.insuranceExpiryDate || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</h4>
                        <p><strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${supplier?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡:</strong> ${car.date}</p>
                        <p><strong>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</strong> ${formatCurrency(car.purchasePrice)}</p>
                    </div>
                    ${sale ? `<div class="bg-green-50 p-4 rounded-lg"><h4 class="font-bold text-lg mb-2 text-green-700">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙŠØ¹</h4><p><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customer?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p><p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹:</strong> ${sale.date}</p><p><strong>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${formatCurrency(totalSalePrice)}</p><p><strong>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¯Ø§Ø¯:</strong> ${sale.saleType} ${(sale.saleType === 'ØªÙ‚Ø³ÙŠØ·' || sale.saleType === 'Ø¯ÙØ¹Ø§Øª') ? `(Ù…Ù‚Ø¯Ù…: ${formatCurrency(sale.downPayment)})` : ''}</p><p class="font-bold mt-2"><strong>Ø§Ù„Ø±Ø¨Ø­:</strong> <span class="${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(profit)}</span></p></div>` : `<div class="bg-blue-50 p-4 rounded-lg text-center"><h4 class="font-bold text-lg">Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¨ÙŠØ¹</h4></div>`}
                </div>
                <div class="mt-6"><h4 class="font-bold text-lg mb-2">Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©</h4>${maintenanceHTML}</div>
                </div>`;
            
            const modalContentDiv = document.querySelector('#carDetailsModal .modal-content');
            modalContentDiv.innerHTML = `<span class="close-button" onclick="closeModal('carDetailsModal')">Ã—</span>`;
            modalContentDiv.insertAdjacentHTML('beforeend', html);
            modalContentDiv.insertAdjacentHTML('beforeend', buttonsHTML);
            
            document.getElementById('addMaintenanceBtn').onclick = () => openAddMaintenanceModal(carId);

            logActivity(`Ø¹Ø±Ø¶ Ù…Ù„Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${car.carType} ${car.carModel} (Ù…Ù„Ù #${car.fileNumber})`);
            openModal('carDetailsModal');
        };

        const deleteCar = (id) => { const car = db.cars.find(c => c.id === id); if (car.status === CAR_STATUSES.SOLD) { showToast("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø³ÙŠØ§Ø±Ø© Ù…Ø¨Ø§Ø¹Ø©. Ø§Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ Ø£ÙˆÙ„Ø§Ù‹."); return; } openConfirmModal(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø© "${car.carType} ${car.carModel}"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ù‡Ø§ Ø£ÙŠØ¶Ø§Ù‹.`, () => { logActivity(`Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${car.carType} ${car.carModel} (Ù…Ù„Ù #${car.fileNumber})`); const maintenanceIdsToDelete = db.maintenanceLog.filter(m => m.carId === id).map(m => m.id); db.cars = db.cars.filter(c => c.id !== id); db.maintenanceLog = db.maintenanceLog.filter(m => m.carId !== id); db.expenses = db.expenses.filter(exp => !exp.maintenanceLogId || !maintenanceIdsToDelete.includes(exp.maintenanceLogId)); if (db.carDocs && db.carDocs[String(id)]) delete db.carDocs[String(id)]; showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø©."); saveData(); renderAll(document.getElementById('globalSearch').value); }); };
        const deleteSale = (id) => { const sale = db.sales.find(s => s.id === id); const car = db.cars.find(c => c.id === sale.carId); const customer = db.customers.find(c => c.id === sale.customerId); const carName = car ? `${car.carType} ${car.carModel}` : 'Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©'; openConfirmModal(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¨ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© "${carName}"ØŸ Ø³ØªØ¹ÙˆØ¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ù‡Ø§.`, () => { if (car) car.status = CAR_STATUSES.AVAILABLE; logActivity(`Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© "${carName}" Ù„Ù„Ø¹Ù…ÙŠÙ„ "${customer?.name}"`); db.sales = db.sales.filter(s => s.id !== id); db.installments = db.installments.filter(i => i.saleId !== id); showToast("ØªÙ… Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹."); saveData(); renderAll(document.getElementById('globalSearch').value); }); };
        const deletePerson = (id, type) => { const person = db[type].find(p => p.id === id); const typeArabic = type === 'customers' ? 'Ø§Ù„Ø¹Ù…ÙŠÙ„' : 'Ø§Ù„Ù…ÙˆØ±Ø¯'; if (type === 'customers') { const hasSales = db.sales.some(sale => sale.customerId === id); if (hasSales) { showToast(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„ÙˆØ¬ÙˆØ¯ ÙÙˆØ§ØªÙŠØ± Ø¨ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡.`); return; } } if (type === 'suppliers') { const hasPurchases = db.cars.some(car => car.supplierId === id); if (hasPurchases) { showToast(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯ Ù„ÙˆØ¬ÙˆØ¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡.`); return; } const hasPayments = db.supplierPayments.some(p => p.supplierId === id); if(hasPayments) { showToast(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯ Ù„ÙˆØ¬ÙˆØ¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø§Ø³Ù…Ù‡.`); return; } } openConfirmModal(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${typeArabic} "${person.name}"ØŸ`, () => { logActivity(`Ø­Ø°Ù ${typeArabic}: ${person.name}`); db[type] = db[type].filter(p => p.id !== id); showToast(`ØªÙ… Ø­Ø°Ù ${typeArabic}.`); saveData(); renderAll(document.getElementById('globalSearch').value); }); };
        const deleteExpense = (id) => { const expense = db.expenses.find(e => e.id === id); openConfirmModal(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…ØµØ±ÙˆÙ "${expense.description}"ØŸ`, () => { logActivity(`Ø­Ø°Ù Ù…ØµØ±ÙˆÙ: "${expense.description}" Ø¨Ù‚ÙŠÙ…Ø© ${formatCurrency(expense.amount)}`); if (expense.type === 'ØµÙŠØ§Ù†Ø©' && expense.maintenanceLogId) { db.maintenanceLog = db.maintenanceLog.filter(m => m.id !== expense.maintenanceLogId); } db.expenses = db.expenses.filter(e => e.id !== id); showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ."); saveData(); renderAll(document.getElementById('globalSearch').value); }); };
        const deleteArchiveItem = (id) => { const item = db.archive.find(i => i.id === id); openConfirmModal(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ø³ØªÙ†Ø¯ "${item.title}" Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ`, () => { logActivity(`Ø­Ø°Ù Ù…Ø³ØªÙ†Ø¯ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ: ${item.title}`); db.archive = db.archive.filter(i => i.id !== id); showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ."); saveData(); renderAll(document.getElementById('globalSearch').value); }); };
        const openEditCarModal = (id) => { const car = db.cars.find(c => c.id === id); if (!car) return; document.getElementById('editCarId').value = car.id; document.getElementById('editCarType').value = car.carType; document.getElementById('editCarModel').value = car.carModel; document.getElementById('editModelYear').value = car.modelYear; document.getElementById('editColor').value = car.color; document.getElementById('editCarVin').value = car.vin;
            document.getElementById('editEngineNumber').value = car.engineNumber || '';
            document.getElementById('editPlateNumber').value = car.plateNumber || ''; document.getElementById('editCarPurchasePrice').value = car.purchasePrice; document.getElementById('editLicenseExpiry').value = car.licenseExpiryDate || ''; document.getElementById('editInsuranceExpiry').value = car.insuranceExpiryDate || ''; const statusSelect = document.getElementById('editCarStatus'); statusSelect.innerHTML = ''; Object.values(CAR_STATUSES).forEach(s => statusSelect.innerHTML += `<option value="${s}">${s}</option>`); statusSelect.value = car.status; openModal('editCarModal'); };
        const openEditPersonModal = (id, type) => { const person = db[type].find(p => p.id === id); if (!person) return; document.getElementById('editPersonTitle').textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ${type === 'customers' ? 'Ø¹Ù…ÙŠÙ„' : 'Ù…ÙˆØ±Ø¯'}`; document.getElementById('editPersonId').value = person.id; document.getElementById('editPersonType').value = type; document.getElementById('editPersonName').value = person.name; document.getElementById('editPersonPhone').value = person.phone; document.getElementById('editPersonAddress').value = person.address; openModal('editPersonModal'); };
        const openEditExpenseModal = (id) => { const expense = db.expenses.find(e => e.id === id); if (!expense) return; if (expense.type === 'ØµÙŠØ§Ù†Ø©') { showToast("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ù…Ù† Ù‡Ù†Ø§."); return; } document.getElementById('editExpenseId').value = expense.id; document.getElementById('editExpenseDescription').value = expense.description; document.getElementById('editExpenseAmount').value = expense.amount; openModal('editExpenseModal'); };
        const payInstallment = (installmentId) => { const installment = db.installments.find(i => i.id === installmentId); if (installment) { installment.paid = true; installment.paidDate = getTodayDate(); const sale = db.sales.find(s => s.id === installment.saleId); const customer = db.customers.find(c => c.id === sale.customerId); logActivity(`ØªØ³Ø¯ÙŠØ¯ Ù‚Ø³Ø· Ø¨Ù‚ÙŠÙ…Ø© ${formatCurrency(installment.amount)} Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ "${customer?.name}"`); showToast(`ØªÙ… ØªØ³Ø¯ÙŠØ¯ Ù‚Ø³Ø· Ø¨Ù‚ÙŠÙ…Ø© ${formatCurrency(installment.amount)}`); saveData(); renderAll(document.getElementById('globalSearch').value); } };
        
        function setupFormListeners() {
            // --- ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¯Ø§Ø¯ (Ù†Ù‚Ø¯ÙŠ/ØªÙ‚Ø³ÙŠØ·/Ø¯ÙØ¹Ø§Øª) ---
            const saleTypeEl = document.getElementById('saleType');
            const instFields = document.getElementById('installment-fields');
            const payFields = document.getElementById('payments-fields');
            const payPlanEl = document.getElementById('paymentsPlan');
            const manualBox = document.getElementById('manual-payments');
            const manualRows = document.getElementById('manual-payments-rows');

            function clearManualRows() {
                if (manualRows) manualRows.innerHTML = '';
            }

            function syncSaleTypeUI() {
                const v = saleTypeEl?.value || 'Ù†Ù‚Ø¯ÙŠ';

                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„ Ø£ÙˆÙ„Ø§Ù‹
                if (instFields) instFields.classList.add('hidden');
                if (payFields) payFields.classList.add('hidden');

                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
                if (v === 'ØªÙ‚Ø³ÙŠØ·') {
                    if (instFields) instFields.classList.remove('hidden');
                } else if (v === 'Ø¯ÙØ¹Ø§Øª') {
                    if (payFields) payFields.classList.remove('hidden');
                    syncPaymentsPlanUI();
                }
            }

            function syncPaymentsPlanUI() {
                if (!payPlanEl) return;
                const plan = payPlanEl.value;
                if (plan === 'manual') {
                    if (manualBox) manualBox.classList.remove('hidden');
                    // Ù„Ùˆ ÙØ§Ø¶ÙŠØŒ Ø¶ÙŠÙ ØµÙ Ø§ÙØªØ±Ø§Ø¶ÙŠ
                    if (manualRows && manualRows.children.length === 0) addManualPaymentRow();
                } else {
                    if (manualBox) manualBox.classList.add('hidden');
                    clearManualRows();
                }
            }

            if (saleTypeEl) saleTypeEl.addEventListener('change', syncSaleTypeUI);
            if (payPlanEl) payPlanEl.addEventListener('change', syncPaymentsPlanUI);

            // Ø¹Ù†Ø¯ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨ÙŠØ¹: Ø§Ø¶Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const addSaleModal = document.getElementById('addSaleModal');
            if (addSaleModal) {
                addSaleModal.addEventListener('click', () => { /* noop */ });
            }

            // ØªØ´ØºÙŠÙ„ Ù…Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            syncSaleTypeUI();

            
document.getElementById('addPurchaseForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const vin = document.getElementById('purchaseVin').value;
    const isDupVin = db.cars.some(c => c.vin === vin && vin.length > 0 && (__editingPurchaseId === null || c.id !== __editingPurchaseId));
    if (isDupVin) { showToast("Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡ Ù‡Ø°Ø§ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„!"); return; }

    const payload = {
        supplierId: parseInt(document.getElementById('purchaseSupplier').value),
        carCondition: document.getElementById('purchaseCarCondition').value,
        carType: document.getElementById('purchaseCarType').value,
        carModel: document.getElementById('purchaseCarModel').value,
        modelYear: parseInt(document.getElementById('purchaseModelYear').value),
        color: document.getElementById('purchaseColor').value,
        vin: vin,
        plateNumber: document.getElementById('purchasePlateNumber')?.value || '',
        licenseExpiry: document.getElementById('purchaseLicenseExpiry')?.value || '',
        insuranceExpiry: document.getElementById('purchaseInsuranceExpiry')?.value || '',
        engineNumber: document.getElementById('purchaseEngineNumber').value,
        mileage: (document.getElementById('purchaseOdometer')?.value || document.getElementById('purchaseMileage')?.value || ''),
        purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
        date: document.getElementById('purchaseDate').value || getTodayDate()
    };

    if (__editingPurchaseId) {
        const car = db.cars.find(c => c.id === __editingPurchaseId);
        if (!car) { showToast('Ø§Ù„Ø³ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error'); return; }
        Object.assign(car, payload);
        logActivity(`ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${car.carType} ${car.carModel} (Ù…Ù„Ù #${car.fileNumber || car.id})`);
        showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­.');
        __editingPurchaseId = null;
    } else {
        const newCar = { id: getNextId('cars'), fileNumber: db.carFileCounter++, createdBy: currentUser.name, status: CAR_STATUSES.AVAILABLE, ...payload };
        db.cars.push(newCar);
        logActivity(`Ø´Ø±Ø§Ø¡ Ø³ÙŠØ§Ø±Ø©: ${newCar.carType} ${newCar.carModel} (Ù…Ù„Ù #${newCar.fileNumber}) Ø¨Ø³Ø¹Ø± ${formatCurrency(newCar.purchasePrice)}`);
        showToast(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${newCar.carType} ${newCar.carModel}.`);
    }

    saveData();
    populateFilterDropdowns();
    renderAll();
    closeModal('addPurchaseModal');
    e.target.reset();

    const title = document.querySelector('#addPurchaseModal h3');
    if (title) title.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø³ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©';
});

            document.getElementById('addSaleForm').addEventListener('submit', function(e) { e.preventDefault();
                // ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹
                if (__editingSaleId) {
                    const sale = db.sales.find(s => s.id === __editingSaleId);
                    if (!sale) { showToast('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error'); __editingSaleId = null; return; }

                    const hasPaid = db.installments.some(i => i.saleId === __editingSaleId && i.paid);
                    if (hasPaid) { showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ø¹Ù„ÙŠÙ‡Ø§ Ø£Ù‚Ø³Ø§Ø· Ù…Ø³Ø¯Ø¯Ø©.', 'error'); return; }

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙÙˆØ±Ù… (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©/Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„ØªÙØ§Ø¯ÙŠ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙˆØ§ÙØ±)
                    sale.date = document.getElementById('saleDate')?.value || sale.date;
                    sale.saleType = document.getElementById('saleType')?.value || sale.saleType;
                    sale.salePrice = parseFloat(document.getElementById('salePrice')?.value || sale.salePrice || 0);
                    sale.downPayment = parseFloat((document.getElementById('saleDownPayment')?.value || document.getElementById('paymentsDownPayment')?.value || document.getElementById('downPayment')?.value || sale.downPayment || 0));
                    if (document.getElementById('saleNotes')) sale.notes = document.getElementById('saleNotes').value;

                    const additionalCharges = [];
                    document.querySelectorAll('.additional-charge-row').forEach(row => {
                        const desc = row.querySelector('.charge-desc')?.value || '';
                        const amt = parseFloat(row.querySelector('.charge-amount')?.value || 0);
                        if (desc && !isNaN(amt) && amt > 0) additionalCharges.push({ description: desc, amount: amt });
                    });
                    sale.additionalCharges = additionalCharges;

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ (Ø¥Ù† ÙˆØ¬Ø¯) Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¤Ù‡
                    ensureSaleContract(sale.id);

                    saveData();
                    showToast('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­.');
                    logActivity(`ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ (Ø±Ù‚Ù… #${sale.id})`);

                    __editingSaleId = null;
                    closeModal('addSaleModal');
                    document.getElementById('saleCarId').disabled = false;
                    document.getElementById('saleCustomerId').disabled = false;
                    e.target.reset();
                    renderAll();
                    return;
                } const carId = parseInt(document.getElementById('saleCarId').value); if (!carId) { showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø³ÙŠØ§Ø±Ø©"); return; } const car = db.cars.find(c => c.id === carId); if (!car || car.status !== CAR_STATUSES.AVAILABLE) { showToast("Ø®Ø·Ø£: Ø§Ù„Ø³ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¨ÙŠØ¹!"); return; } const saleId = getNextId('sales'); const customerId = parseInt(document.getElementById('saleCustomerId').value); const customer = db.customers.find(c => c.id === customerId); const additionalCharges = []; document.querySelectorAll('.additional-charge-item').forEach(item => { const desc = item.querySelector('.charge-desc').value; const amount = parseFloat(item.querySelector('.charge-amount').value); if (desc && amount > 0) { additionalCharges.push({ description: desc, amount: amount }); } }); const saleData = { id: saleId, createdBy: currentUser.name, carId: carId, customerId: customerId, salePrice: parseFloat(document.getElementById('salePrice').value), additionalCharges: additionalCharges, saleOdometer: document.getElementById('saleOdometer').value, saleType: document.getElementById('saleType').value, date: document.getElementById('saleDate').value, downPayment: 0 }; const totalSalePrice = saleData.salePrice + additionalCharges.reduce((sum, charge) => sum + charge.amount, 0); if (saleData.saleType === 'ØªÙ‚Ø³ÙŠØ·') {
                        saleData.downPayment = parseFloat(document.getElementById('saleDownPayment').value) || 0;
                        const installmentCount = parseInt(document.getElementById('saleInstallmentCount').value);
                        const remaining = totalSalePrice - saleData.downPayment;
                        if (remaining < 0 || installmentCount <= 0) { showToast('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø³ÙŠØ· ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'); return; }
                        const installmentAmount = remaining / installmentCount;
                        let installmentDate = new Date(saleData.date);
                        for (let i = 1; i <= installmentCount; i++) {
                            installmentDate.setMonth(installmentDate.getMonth() + 1);
                            db.installments.push({ id: getNextId('installments'), saleId: saleId, amount: installmentAmount, dueDate: installmentDate.toISOString().slice(0, 10), paid: false });
                        }
                    } else if (saleData.saleType === 'Ø¯ÙØ¹Ø§Øª') {
                        const down = parseFloat(document.getElementById('paymentsDownPayment').value) || 0;
                        const plan = document.getElementById('paymentsPlan').value;
                        const count = parseInt(document.getElementById('paymentsCount').value);
                        const remaining = totalSalePrice - down;
                        if (remaining < 0 || count <= 0) { showToast('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©.'); return; }
                        saleData.downPayment = down;
                        saleData.paymentsPlan = plan;
                        saleData.paymentsCount = count;

                        if (plan === 'manual') {
                            const dates = Array.from(document.querySelectorAll('.manual-pay-date')).map(i => i.value);
                            const amounts = Array.from(document.querySelectorAll('.manual-pay-amount')).map(i => parseFloat(i.value) || 0);
                            if (dates.some(d => !d) || amounts.some(a => a <= 0)) { showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® ÙˆÙ…Ø¨Ù„Øº Ù„ÙƒÙ„ Ø¯ÙØ¹Ø©.'); return; }
                            // ØªØ­Ù‚Ù‚ ØµØ§Ø±Ù…: (Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª + Ø§Ù„Ù…Ù‚Ø¯Ù…) ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹
                            const sum = amounts.reduce((s,a)=>s+a,0);
                            if (Math.abs(sum - remaining) > 0.01) {
                                showToast(`Ø®Ø·Ø£: Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª (${sum.toFixed(2)}) Ù„Ø§ ÙŠØ³Ø§ÙˆÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (${remaining.toFixed(2)}).`, 'error');
                                return;
                            }
                            for (let i = 0; i < dates.length; i++) {
                                db.installments.push({ id: getNextId('installments'), saleId: saleId, amount: amounts[i], dueDate: dates[i], paid: false });
                            }
                        } else {
                            const intervalMonths = parseInt(plan); // 3 Ø£Ùˆ 6
                            const installmentAmount = remaining / count;
                            let due = new Date(saleData.date);
                            for (let i = 1; i <= count; i++) {
                                due.setMonth(due.getMonth() + intervalMonths);
                                db.installments.push({ id: getNextId('installments'), saleId: saleId, amount: installmentAmount, dueDate: due.toISOString().slice(0, 10), paid: false });
                            }
                        }
                    } else {
                        saleData.downPayment = totalSalePrice;
                    } saleData.invoiceNumber = getNextInvoiceNumber(); db.sales.push(saleData);
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                ensureSaleContract(saleData.id); car.status = CAR_STATUSES.SOLD; logActivity(`ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ù„Ù„Ø³ÙŠØ§Ø±Ø© "${car.carType} ${car.carModel}" Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ "${customer?.name}"`); showToast(`ØªÙ… Ø¨ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${car.carType} ${car.carModel}.`); saveData(); populateFilterDropdowns(); renderAll(); closeModal('addSaleModal'); e.target.reset(); });
            document.getElementById('addExpenseForm').addEventListener('submit', function(e) { e.preventDefault(); const description = document.getElementById('expenseDescription').value; const amount = parseFloat(document.getElementById('expenseAmount').value); const newExpense = { id: getNextId('expenses'), createdBy: currentUser.name, description: description, type: document.getElementById('expenseType').value, amount: amount, date: document.getElementById('expenseDate').value }; db.expenses.push(newExpense); logActivity(`ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ: "${description}" Ø¨Ù‚ÙŠÙ…Ø© ${formatCurrency(amount)}`); showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ."); saveData(); renderAll(); closeModal('addExpenseModal'); e.target.reset(); });
            document.getElementById('addClientForm').addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('clientName').value; db.customers.push({ id: getNextId('customers'), name: name, phone: document.getElementById('clientPhone').value, address: document.getElementById('clientAddress').value }); logActivity(`Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯: ${name}`); showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ ${name}.`); saveData(); renderAll(); closeModal('addClientModal'); e.target.reset(); });
            document.getElementById('addSupplierForm').addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('supplierName').value; db.suppliers.push({ id: getNextId('suppliers'), name: name, phone: document.getElementById('supplierPhone').value, address: document.getElementById('supplierAddress').value }); logActivity(`Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯: ${name}`); showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ±Ø¯ ${name}.`); saveData(); renderAll(); closeModal('addSupplierModal'); e.target.reset(); });
            document.getElementById('editCarForm').addEventListener('submit', function(e) { e.preventDefault(); const id = parseInt(document.getElementById('editCarId').value); const car = db.cars.find(c => c.id === id); if (car) { logActivity(`ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${car.carType} ${car.carModel}`); car.carType = document.getElementById('editCarType').value; car.carModel = document.getElementById('editCarModel').value; car.modelYear = parseInt(document.getElementById('editModelYear').value); car.color = document.getElementById('editColor').value; car.vin = document.getElementById('editCarVin').value;
            car.engineNumber = document.getElementById('editEngineNumber').value.trim();
            car.plateNumber = document.getElementById('editPlateNumber').value.trim(); car.purchasePrice = parseFloat(document.getElementById('editCarPurchasePrice').value); car.status = document.getElementById('editCarStatus').value; car.licenseExpiryDate = document.getElementById('editLicenseExpiry').value; car.insuranceExpiryDate = document.getElementById('editInsuranceExpiry').value; showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©."); saveData(); renderAll(document.getElementById('globalSearch').value); closeModal('editCarModal'); } });
            document.getElementById('editPersonForm').addEventListener('submit', function(e) { e.preventDefault(); const id = parseInt(document.getElementById('editPersonId').value); const type = document.getElementById('editPersonType').value; const person = db[type].find(p => p.id === id); if (person) { logActivity(`ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ${type === 'customers' ? 'Ø§Ù„Ø¹Ù…ÙŠÙ„' : 'Ø§Ù„Ù…ÙˆØ±Ø¯'}: ${person.name}`); person.name = document.getElementById('editPersonName').value; person.phone = document.getElementById('editPersonPhone').value; person.address = document.getElementById('editPersonAddress').value; showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."); saveData(); renderAll(document.getElementById('globalSearch').value); closeModal('editPersonModal'); } });
            document.getElementById('editExpenseForm').addEventListener('submit', function(e) { e.preventDefault(); const id = parseInt(document.getElementById('editExpenseId').value); const expense = db.expenses.find(ex => ex.id === id); if (expense) { logActivity(`ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ: ${expense.description}`); expense.description = document.getElementById('editExpenseDescription').value; expense.amount = parseFloat(document.getElementById('editExpenseAmount').value); showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ."); saveData(); renderAll(document.getElementById('globalSearch').value); closeModal('editExpenseModal'); } });
            document.getElementById('addArchiveForm').addEventListener('submit', function(e) { e.preventDefault(); const title = document.getElementById('archiveTitle').value; const newArchiveItem = { id: getNextId('archive'), createdBy: currentUser.name, title: title, description: document.getElementById('archiveDescription').value, link: document.getElementById('archiveLink').value, date: document.getElementById('archiveDate').value, carId: document.getElementById('archiveCarId').value ? parseInt(document.getElementById('archiveCarId').value) : null }; db.archive.push(newArchiveItem); logActivity(`Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ù„Ù„Ø£Ø±Ø´ÙŠÙ: ${title}`); showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ."); saveData(); renderAll(); closeModal('addArchiveModal'); e.target.reset(); });
            document.getElementById('add-charge-btn').addEventListener('click', () => { const container = document.getElementById('additional-charges-container'); const chargeItem = document.createElement('div'); chargeItem.className = 'additional-charge-item flex items-center gap-2'; chargeItem.innerHTML = ` <input type="text" class="charge-desc w-2/3 p-1 border rounded" placeholder="Ø¨ÙŠØ§Ù† Ø§Ù„Ø±Ø³Ù… (Ù…Ø«Ø§Ù„: Ø¶Ø±ÙŠØ¨Ø©)"> <input type="number" class="charge-amount w-1/3 p-1 border rounded" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"> <button type="button" class="text-red-500" onclick="this.parentElement.remove()">X</button>`; container.appendChild(chargeItem); });
            
            document.getElementById('addQuoteForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const newQuote = {
                    id: getNextId('quotes'),
                    quoteNumber: db.quoteCounter++,
                    carId: parseInt(document.getElementById('quoteCarId').value),
                    customerId: parseInt(document.getElementById('quoteCustomerId').value),
                    price: parseFloat(document.getElementById('quotePrice').value),
                    expiryDate: document.getElementById('quoteExpiryDate').value,
                    notes: document.getElementById('quoteNotes').value,
                    status: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                    createdBy: currentUser.name
                };

                db.quotes.push(newQuote);
                logActivity(`Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø³Ø¹Ø± #${newQuote.quoteNumber} Ù„Ù„Ø³ÙŠØ§Ø±Ø© ID ${newQuote.carId}`);
                saveData();
                renderAll();
                closeModal('addQuoteModal');
                showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø¨Ù†Ø¬Ø§Ø­.');
                
                printQuote(newQuote.id);
            });
            
            setupUserFormListener();
            setupSupplierPaymentFormListener();
            setupMaintenanceFormListener();
            setupEditSupplierPaymentListener();
        }

        function generateStandardPrintLayout(title, content, barcodeData) {
            const header = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #1d4ed8; padding-bottom: 15px; margin-bottom: 20px;">
                    <div>
                        <h1 style="font-size: 28px; color: #1d4ed8; margin: 0;">Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØªÙˆÙƒÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</h1>
                        <p style="margin: 5px 0; font-size: 14px;">Ø¥Ø¯Ø§Ø±Ø©: Ø§Ù„Ø­Ø§Ø¬ Ø§Ù„Ø³ÙŠØ¯ Ø²ÙŠØ§Ù† Ø´Ø§Ù…ÙŠØ© ÙˆØ§Ø¨Ùˆ Ø²ÙŠØ§Ø¯</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #555;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ù…Ù†ÙˆÙÙŠØ© - Ù…Ø±ÙƒØ² ØªÙ„Ø§ - Ø·ÙˆØ® Ø¯Ù„ÙƒØ§</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #555;">Ù„Ù„ØªÙˆØ§ØµÙ„: Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ø³ÙŠØ¯ (01094075438) | Ø§Ø¨Ùˆ Ø¬Ù†ÙŠ (01027013001) | Ø§Ø¨Ùˆ Ø²ÙŠØ§Ø¯ (01003994391)</p>
                    </div>
                    <div style="text-align: left;">
                        <h2 style="font-size: 24px; margin:0; color: #333;">${title}</h2>
                        <p style="margin: 5px 0;"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</strong> ${getTodayDate()}</p>
                    </div>
                </div>`;

            const footer = `
                <div style="margin-top: 40px; text-align: center; border-top: 1px solid #ccc; padding-top: 10px;">
                    <svg id="barcode"></svg>
                    <p style="font-size: 12px; color: #777;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© Ù…/Ø±Ø§Ø¶ÙŠ Ù…Ù‡Ù†ÙŠ Ø¯ÙŠØ§Ø¨ 2025</p>
                </div>`;

            return `<div style="font-family: 'Cairo', sans-serif; background-color: white; color: #333;">${header}${content}${footer}</div>`;
        }
        
        function printExpenseInvoice(expenseId) {
            const expense = db.expenses.find(e => e.id === expenseId);
            if (!expense) return;

            const mainTitle = 'Ø¥ÙŠØµØ§Ù„ ØµØ±Ù Ù†Ù‚Ø¯ÙŠØ©';
            const invoiceNumber = `Ù…ØµØ±ÙˆÙ-${expense.id}`;
            const barcodeData = `EXP-${expense.id}`;

            const items = [{
                description: expense.description,
                subDescription: `ØªÙ… Ø§Ù„ØµØ±Ù Ø¨ÙˆØ§Ø³Ø·Ø©: ${expense.createdBy || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`,
                amount: expense.amount
            }];
            
            const totals = [{
                label: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØµØ±ÙˆÙ',
                value: expense.amount,
                isBold: true
            }];

            const itemsHTML = `<table style="width: 100%; margin-top: 30px; border-collapse: collapse; font-size: 14px;"><thead style="background-color: #f9fafb;"><tr><th style="border: 1px solid #ddd; padding: 12px; text-align: right; background-color: #e5e7eb;">Ø§Ù„Ø¨ÙŠØ§Ù†</th><th style="border: 1px solid #ddd; padding: 12px; text-align: center; width: 150px; background-color: #e5e7eb;">Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>${items.map(item => `<tr><td data-label="Ø§Ù„Ø¨ÙŠØ§Ù†" style="border: 1px solid #ddd; padding: 12px;">${item.description}${item.subDescription ? `<br><small style="color: #666;">${item.subDescription}</small>` : ''}</td><td data-label="Ø§Ù„Ù…Ø¨Ù„Øº" style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold;">${formatCurrency(item.amount)}</td></tr>`).join('')}</tbody></table>`;
            const totalsHTML = `<div style="margin-top: 30px; text-align: left; width: 100%; max-width: 400px; margin-left: auto;">${totals.map(total => `<div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 16px; ${total.isBold ? 'font-weight: bold; background-color: #f3f4f6;' : ''}"><strong>${total.label}:</strong><span style="font-weight: bold; color: ${total.color || '#1d4ed8'};">${formatCurrency(total.value)}</span></div>`).join('')}</div>`;

            const contentHTML = `
                <div style="padding-bottom: 30px; border-bottom: 1px solid #eee;">
                    <p style="margin: 5px 0 0 0;"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØµØ±Ù:</strong> ${expense.date}</p>
                </div>
                ${itemsHTML}
                ${totalsHTML}
            `;
            
            const fullInvoiceHTML = generateStandardPrintLayout(`${mainTitle} (#${invoiceNumber})`, contentHTML, barcodeData);
            document.getElementById('invoiceContent').innerHTML = fullInvoiceHTML;
            openModal('invoiceModal');
            setTimeout(() => JsBarcode("#barcode", barcodeData, { height: 40, displayValue: false }), 100);
            logActivity(`Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø© Ù…ØµØ±ÙˆÙ: ${expense.description}`);
        }

        function showInvoice(type, id) {
            let contentHTML = '', mainTitle = '', barcodeData = '', party, items, totals, date, invoiceNumber, data, partyType;
            
            switch(type) {
                case 'purchase':
                    data = db.cars.find(c => c.id === id); if (!data) return;
                    party = db.suppliers.find(s => s.id === data.supplierId) || { name: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' };
                    mainTitle = 'ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡';
                    invoiceNumber = `Ø´Ø±Ø§Ø¡-${data.invoiceNumber}`;
                    partyType = 'ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ù†';
                    items = [{ description: `Ø³ÙŠØ§Ø±Ø© ${data.carType} ${data.carModel} Ù…ÙˆØ¯ÙŠÙ„ ${data.modelYear}`, subDescription: `Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡: ${data.vin}` + (data.engineNumber ? ` | Ø±Ù‚Ù… Ø§Ù„Ù…Ø§ØªÙˆØ±: ${data.engineNumber}` : '') + (data.plateNumber ? ` | Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©: ${data.plateNumber}` : ''), amount: data.purchasePrice }];
                    totals = [{ label: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', value: data.purchasePrice, isBold: true }];
                    barcodeData = `PURCH-${data.id}-${data.invoiceNumber}`;
                    logActivity(`Ø·Ø¨Ø§Ø¹Ø©/Ø¹Ø±Ø¶ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ #${invoiceNumber} Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯: ${party.name}`);
                    break;
                case 'sale': 
                    data = db.sales.find(s => s.id === id); if (!data) return; 
                    const car = db.cars.find(c => c.id === data.carId); 
                    party = db.customers.find(c => c.id === data.customerId) || { name: 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }; 
                    mainTitle = 'ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹'; 
                    invoiceNumber = `Ø¨ÙŠØ¹-${data.invoiceNumber}`;
                    partyType = 'ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰';
                    items = [{ description: `Ø³ÙŠØ§Ø±Ø© ${car.carType} ${car.carModel} Ù…ÙˆØ¯ÙŠÙ„ ${car.modelYear}`, subDescription: `Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡: ${car.vin}`, amount: data.salePrice }];
                    if(data.additionalCharges && data.additionalCharges.length > 0) {
                        data.additionalCharges.forEach(charge => {
                            items.push({description: charge.description, subDescription: '', amount: charge.amount });
                        });
                    }
                    const totalSalePrice = data.salePrice + (data.additionalCharges || []).reduce((sum, charge) => sum + charge.amount, 0);
                    const remaining = totalSalePrice - data.downPayment; 
                    totals = [ { label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', value: totalSalePrice, isBold: true }, { label: 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ù…Ù‚Ø¯Ù…)', value: data.downPayment, color: '#15803d' }, { label: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ', value: remaining, color: '#b91c1c' } ]; 
                    barcodeData = `SALE-${data.id}-${data.invoiceNumber}`;
                    logActivity(`Ø·Ø¨Ø§Ø¹Ø©/Ø¹Ø±Ø¶ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹ #${invoiceNumber} Ù„Ù„Ø¹Ù…ÙŠÙ„: ${party.name}`);
                    break;
                case 'installment':
                    data = db.installments.find(i => i.id === id); if (!data) return;
                    const instSale = db.sales.find(s => s.id === data.saleId);
                    const instCar = db.cars.find(c => c.id === instSale.carId);
                    party = db.customers.find(c => c.id === instSale.customerId);
                    mainTitle = 'Ø¥ÙŠØµØ§Ù„ Ø³Ø¯Ø§Ø¯ Ù‚Ø³Ø·';
                    invoiceNumber = `Ø¥ÙŠØµØ§Ù„-${data.id}`;
                    partyType = 'Ø§Ù„Ø¹Ù…ÙŠÙ„';
                    items = [{ description: `Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø¨ØªØ§Ø±ÙŠØ® ${data.dueDate}`, subDescription: `Ø¹Ù† Ø³ÙŠØ§Ø±Ø© ${instCar.carType} ${instCar.carModel}`, amount: data.amount }];
                    totals = [{ label: `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØµØ§Ù„ (Ù…Ø³Ø¯Ø¯)`, value: data.amount, isBold: true, color: '#15803d' }];
                    barcodeData = `INSTL-${data.id}`;
                    logActivity(`Ø·Ø¨Ø§Ø¹Ø©/Ø¹Ø±Ø¶ Ø¥ÙŠØµØ§Ù„ Ù‚Ø³Ø· #${data.id} Ù„Ù„Ø¹Ù…ÙŠÙ„: ${party.name}`);
                    break;
            }
            
            const partyHTML = `<div style="margin-top: 30px; padding-bottom: 30px; border-bottom: 1px solid #eee;"><h3 style="margin: 0; font-size: 16px; color: #555;">${partyType}:</h3><p style="margin: 5px 0 0 0; font-weight: bold; font-size: 18px;">${party.name}</p>${party.phone ? `<p style="margin: 5px 0 0 0;">Ù‡Ø§ØªÙ: ${party.phone}</p>` : ''}${party.address ? `<p style="margin: 5px 0 0 0;">Ø¹Ù†ÙˆØ§Ù†: ${party.address}</p>` : ''}</div>`;
            const itemsHTML = `<table style="width: 100%; margin-top: 30px; border-collapse: collapse; font-size: 14px;"><thead style="background-color: #f9fafb;"><tr><th style="border: 1px solid #ddd; padding: 12px; text-align: right; background-color: #e5e7eb;">Ø§Ù„Ø¨ÙŠØ§Ù†</th><th style="border: 1px solid #ddd; padding: 12px; text-align: center; width: 150px; background-color: #e5e7eb;">Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>${items.map(item => `<tr><td data-label="Ø§Ù„Ø¨ÙŠØ§Ù†" style="border: 1px solid #ddd; padding: 12px;">${item.description}${item.subDescription ? `<br><small style="color: #666;">${item.subDescription}</small>` : ''}</td><td data-label="Ø§Ù„Ù…Ø¨Ù„Øº" style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold;">${formatCurrency(item.amount)}</td></tr>`).join('')}</tbody></table>`;
            const totalsHTML = `<div style="margin-top: 30px; text-align: left; width: 100%; max-width: 400px; margin-left: auto;">${totals.map(total => `<div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 16px; ${total.isBold ? 'font-weight: bold; background-color: #f3f4f6;' : ''}"><strong>${total.label}:</strong><span style="font-weight: bold; color: ${total.color || '#1d4ed8'};">${formatCurrency(total.value)}</span></div>`).join('')}</div>`;
            const signatureHTML = `<div style="margin-top: 60px; display: flex; justify-content: space-between; font-size: 14px; color: #777; border-top: 1px solid #eee; padding-top: 20px;"><p><strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…:</strong> ....................................</p><p><strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¨Ø§Ø¦Ø¹:</strong> ....................................</p></div>`;
            
            contentHTML = `${partyHTML}${itemsHTML}${totalsHTML}${signatureHTML}`;

            if (data) {
                const fullInvoiceHTML = generateStandardPrintLayout(`${mainTitle} (Ø±Ù‚Ù…: #${invoiceNumber})`, contentHTML, barcodeData);
                document.getElementById('invoiceContent').innerHTML = fullInvoiceHTML;
                openModal('invoiceModal');
                setTimeout(() => JsBarcode("#barcode", barcodeData, { height: 40, displayValue: false }), 100);
            }
        }

        function showPersonStatement(personId, type) {
            const person = db[type].find(p => p.id === personId);
            if (!person) return;
            let contentHTML = '', printContentHTML, barcodeData;

            if (type === 'customers') {
                const customerSales = db.sales.filter(s => s.customerId === personId);
                let totalBalance = 0;
                contentHTML = ``;
                if (customerSales.length === 0) {
                    contentHTML += '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨ÙŠØ¹ Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.</p>';
                } else {
                    customerSales.forEach(sale => {
                        const car = db.cars.find(c => c.id === sale.carId);
                        const paidInstallments = db.installments.filter(i => i.saleId === sale.id && i.paid).reduce((sum, i) => sum + i.amount, 0);
                        const totalSalePrice = sale.salePrice + (sale.additionalCharges || []).reduce((sum, charge) => sum + charge.amount, 0);
                        const totalPaid = sale.downPayment + paidInstallments;
                        const balance = totalSalePrice - totalPaid;
                        totalBalance += balance;
                        contentHTML += `<div class="mb-6 p-4 border rounded-lg bg-gray-50" style="page-break-inside: avoid;"><h3 class="font-bold text-lg border-b pb-2 mb-2">Ø³ÙŠØ§Ø±Ø©: ${car?.carType || 'Ù…Ø­Ø°ÙˆÙØ©'} ${car?.carModel || ''}</h3><div class="grid grid-cols-2 gap-x-4"><p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${formatCurrency(totalSalePrice)}</p><p><strong>Ø§Ù„Ù…Ù‚Ø¯Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${formatCurrency(sale.downPayment)}</p><p><strong>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©:</strong> ${formatCurrency(paidInstallments)}</p><p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¯Ø¯:</strong> ${formatCurrency(totalPaid)}</p><p class="col-span-2 mt-2 pt-2 border-t font-bold"><strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> <span class="text-red-600">${formatCurrency(balance)}</span></p></div></div>`;
                    });
                    contentHTML += `<div class="mt-8 p-4 bg-blue-100 rounded-lg text-center"><h3 class="text-xl font-bold text-blue-800">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${formatCurrency(totalBalance)}</h3></div>`;
                }
                barcodeData = `CUST-STMT-${person.id}`;
                printContentHTML = generateStandardPrintLayout(`ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${person.name}`, contentHTML, barcodeData);
                logActivity(`Ø¹Ø±Ø¶ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${person.name}`);

            } else if (type === 'suppliers') {
                const supplierPurchases = db.cars.filter(c => c.supplierId === personId);
                const supplierPayments = db.supplierPayments.filter(p => p.supplierId === personId);
                let totalPurchases = supplierPurchases.reduce((sum, car) => sum + car.purchasePrice, 0);
                let totalPayments = supplierPayments.reduce((sum, p) => sum + p.amount, 0);
                let balance = totalPurchases - totalPayments;
                const transactions = [...supplierPurchases.map(c => ({ id: c.id, date: c.date, type: 'purchase', description: `Ø´Ø±Ø§Ø¡ Ø³ÙŠØ§Ø±Ø©: ${c.carType} ${c.carModel}`, amount: c.purchasePrice })), ...supplierPayments.map(p => ({ id: p.id, date: p.date, type: 'payment', description: `Ø¯ÙØ¹Ø© Ù…Ø³Ø¯Ø¯Ø© (${p.notes || 'Ø¨Ø¯ÙˆÙ† Ù…Ù„Ø§Ø­Ø¸Ø§Øª'})`, amount: p.amount }))].sort((a, b) => new Date(a.date) - new Date(b.date));
                
                contentHTML = `<table style="width: 100%; border-collapse: collapse; text-align: center;">
                                <thead style="background-color: #f2f2f2;">
                                    <tr>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Ù…Ø¯ÙŠÙ† (Ù…Ø´ØªØ±ÙŠØ§Øª)</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">Ø¯Ø§Ø¦Ù† (Ù…Ø¯ÙÙˆØ¹Ø§Øª)</th>
                                    </tr>
                                </thead><tbody>`;
                if (transactions.length > 0) {
                    transactions.forEach(t => {
                        let actions = '';
                        if (t.type === 'payment' && (currentUser.username === 'developer' || currentUser.username === 'admin')) {
                            actions = ` <button data-payment-id="${t.id}" class="edit-payment-btn" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©" style="all: unset; cursor: pointer; color: blue; font-size: 12px; margin-right: 10px;">[ØªØ¹Ø¯ÙŠÙ„]</button>`;
                        }
                        contentHTML += `<tr>
                                    <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®" style="padding: 8px; border: 1px solid #ddd;">${t.date}</td>
                                    <td data-label="Ø§Ù„Ø¨ÙŠØ§Ù†" style="padding: 8px; border: 1px solid #ddd; text-align: right;">${t.description}${actions}</td>
                                    <td data-label="Ù…Ø¯ÙŠÙ† (Ù…Ø´ØªØ±ÙŠØ§Øª)" style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #b91c1c;">${t.type === 'purchase' ? formatCurrency(t.amount) : '-'}</td>
                                    <td data-label="Ø¯Ø§Ø¦Ù† (Ù…Ø¯ÙÙˆØ¹Ø§Øª)" style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: #15803d;">${t.type === 'payment' ? formatCurrency(t.amount) : '-'}</td>
                                 </tr>`;
                    });
                } else {
                    contentHTML += `<tr><td colspan="4" style="padding: 8px; border: 1px solid #ddd;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø©.</td></tr>`;
                }
                contentHTML += `</tbody></table>
                             <div style="margin-top: 2rem; padding: 1rem; background-color: #f9fafb; border-radius: 0.5rem; font-size: 1.125rem;">
                                <div style="display: flex; justify-content: space-between;"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:</strong> <span style="font-weight: bold;">${formatCurrency(totalPurchases)}</span></div>
                                <div style="display: flex; justify-content: space-between;"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª:</strong> <span style="font-weight: bold; color: #15803d;">${formatCurrency(totalPayments)}</span></div>
                                <hr style="margin: 0.5rem 0;">
                                <div style="display: flex; justify-content: space-between; font-size: 1.25rem;"><strong>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ù„Ù„Ù…ÙˆØ±Ø¯:</strong> <span style="font-weight: bold; color: #b91c1c;">${formatCurrency(balance)}</span></div>
                             </div>`;
                barcodeData = `SUP-STMT-${person.id}`;
                printContentHTML = generateStandardPrintLayout(`ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯: ${person.name}`, contentHTML, barcodeData);
                logActivity(`Ø¹Ø±Ø¶ ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯: ${person.name}`);
            }

            document.getElementById('statementContent').innerHTML = printContentHTML;
            openModal('statementModal');
            document.querySelectorAll('.edit-payment-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const paymentId = parseInt(e.currentTarget.getAttribute('data-payment-id'));
                    openEditSupplierPaymentModal(paymentId);
                });
            });
            setTimeout(() => JsBarcode("#barcode", barcodeData, { height: 40, displayValue: false }), 100);
        }
        
        function updateLiveClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            const dateString = now.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const fullString = `${dateString} | ${timeString}`;
            
            document.getElementById('live-clock').textContent = fullString;
            document.getElementById('live-clock-mobile').textContent = fullString;
        }

        
        // =====================[ ØªØ­Ø³ÙŠÙ†Ø§Øª: Ø¨Ø­Ø«/ÙÙ„Ø§ØªØ± + ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ¹/Ø´Ø±Ø§Ø¡ + Ø£Ø±ØµØ¯Ø© + Ø¹Ù‚ÙˆØ¯ ]=====================

        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø´Ø±Ø§Ø¡/Ø¨ÙŠØ¹)
        let __editingPurchaseId = null;
        let __editingSaleId = null;
        let __currentContractSaleId = null;

        

        // ===== Clock (prevent console errors) =====
        function updateClock(){
            try{
                const now = new Date();
                const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateStr = now.toLocaleDateString('ar-EG');
                const el1 = document.getElementById('live-clock');
                const el2 = document.getElementById('live-clock-mobile');
                if (el1) el1.textContent = `${dateStr} - ${timeStr}`;
                if (el2) el2.textContent = `${dateStr} - ${timeStr}`;
            }catch(e){
                // no-op
            }
        }

        // ===== Contract edit toggle (prevent console errors) =====
        function toggleContractEdit(show){
            const panel = document.getElementById('contractEditPanel');
            if(!panel) return;
            panel.style.display = show ? 'block' : 'none';

            if(show){
                // Populate employee select (seller)
                ensureShowroomsDefaults();
                const empSel = document.getElementById('contractEmployeeSelect');
                if(empSel){
                    empSel.innerHTML = '';
                    (db.companyProfile?.employees || []).forEach(e=>{
                        const opt = document.createElement('option');
                        opt.value = e.id;
                        opt.textContent = e.name || ('Ù…ÙˆØ¸Ù #' + e.id);
                        empSel.appendChild(opt);
                    });
                }

                const contract = ensureSaleContract(__currentContractSaleId);
                if(contract){
                    // Fill buyer fields
                    const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = (val ?? ''); };
                    setVal('contractBuyerName', contract.customerName || '');
                    setVal('contractBuyerPhone', contract.customerPhone || '');
                    setVal('contractBuyerNID', contract.customerNationalId || '');
                    setVal('contractBuyerJob', contract.customerJob || '');
                    setVal('contractBuyerAddress', contract.customerAddress || '');
                    setVal('contractNotes', contract.notes || '');
                    // Fill car fields (editable) â€” Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ù‚Ø¯Ù… ØºÙŠØ± Ù‚Ø§Ø¨Ù„ÙŠÙ† Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
                    setVal('contractPlateNumber', contract.plateNumber || '');
                    setVal('contractCarBrand', contract.carBrand || contract.carType || '');
                    setVal('contractModelYear', contract.modelYear || '');
                    setVal('contractCarColor', contract.carColor || contract.color || '');
                    setVal('contractVin', contract.vin || '');
                    setVal('contractEngineNumber', contract.engineNumber || '');


                    // Select employee if present
                    const empSel2 = document.getElementById('contractEmployeeSelect');
                    if(empSel2){
                        const currentId = contract.sellerEmployeeId || 1;
                        empSel2.value = String(currentId);
                        // Ù„Ùˆ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ø§Ø®ØªØ± Ø£ÙˆÙ„ Ù…ÙˆØ¸Ù
                        if(!empSel2.value) empSel2.value = empSel2.options?.[0]?.value || '1';
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹/Ø§Ù„Ù…Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                    safeUpdateContractFromPanel(false);
                }
            }
        }

        function safeUpdateContractFromPanel(save=true){
            const contract = ensureSaleContract(__currentContractSaleId);
            if(!contract) return;

            const getVal = (id) => document.getElementById(id)?.value ?? '';
            contract.customerName = getVal('contractBuyerName').trim();
            contract.customerPhone = getVal('contractBuyerPhone').trim();
            contract.customerNationalId = getVal('contractBuyerNID').trim();
            contract.customerJob = getVal('contractBuyerJob').trim();
            contract.customerAddress = getVal('contractBuyerAddress').trim();
            contract.notes = getVal('contractNotes').trim();

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© (ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³Ù…ÙˆØ­) â€” Ù„Ø§ Ù†ØºÙŠÙ‘Ø± Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ù‚Ø¯Ù…
            contract.plateNumber = getVal('contractPlateNumber').trim();
            contract.carBrand = getVal('contractCarBrand').trim();
            contract.modelYear = getVal('contractModelYear').trim();
            contract.carColor = getVal('contractCarColor').trim();
            contract.vin = getVal('contractVin').trim();
            contract.engineNumber = getVal('contractEngineNumber').trim();


            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø«Ø§Ø¨ØªØ© Ù…Ù† Company Profile
            ensureShowroomsDefaults();
            contract.showroomName = (db.companyProfile?.name || contract.showroomName || '').trim();
            contract.showroomAddress = (db.companyProfile?.address || contract.showroomAddress || '').trim();
            contract.showroomPhone = (db.companyProfile?.phones || []).filter(Boolean).join(' - ') || contract.showroomPhone || '';

            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ù† Ù…ÙˆØ¸ÙÙŠ Ø§Ù„Ù…Ø¹Ø±Ø¶ (3 Ù…ÙˆØ¸ÙÙŠÙ†)
            const empSel = document.getElementById('contractEmployeeSelect');
            const empId = empSel ? Number(empSel.value||1) : Number(contract.sellerEmployeeId||1);
            contract.sellerEmployeeId = empId || 1;
            const emp = (db.companyProfile?.employees || []).find(e=> Number(e.id)===Number(contract.sellerEmployeeId)) || (db.companyProfile?.employees || [])[0];
            if(emp){
                contract.sellerName = (emp.name||'').trim();
                contract.sellerPhone = (emp.phone||'').trim();
                contract.sellerNationalId = (emp.nationalId||'').trim();
                contract.sellerJob = (emp.job||'').trim();
                contract.sellerAddress = (emp.address||'').trim();
            }

            // refresh preview
            const content = document.getElementById('contractContent');
            if(content) content.innerHTML = buildContractHTML(contract);

            if(save){
                saveData();
                renderVisibleTab('contracts');
            }
        }

        function saveContractEdits(){
            safeUpdateContractFromPanel(true);
            showToast('ØªÙ… Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯');
        }

        let __contractEditListenersBound = false;
        function setupContractEditListeners(){
            if(__contractEditListenersBound) return;
            __contractEditListenersBound = true;

            const ids = ['contractBuyerName','contractBuyerPhone','contractBuyerNID','contractBuyerJob','contractBuyerAddress','contractPlateNumber','contractCarBrand','contractModelYear','contractCarColor','contractVin','contractEngineNumber','contractNotes'];
            ids.forEach(id=>{
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', ()=> safeUpdateContractFromPanel(false));
            });
            const sel = document.getElementById('contractEmployeeSelect');
            if(sel) sel.addEventListener('change', ()=> safeUpdateContractFromPanel(false));
        }
function getCustomerBalanceInfo(customerId){
            const customerSales = db.sales.filter(s => s.customerId === customerId);
            let balance = 0;
            customerSales.forEach(sale => {
                const paidInstallments = db.installments.filter(i => i.saleId === sale.id && i.paid).reduce((sum, i) => sum + Number(i.amount||0), 0);
                const totalSalePrice = Number(sale.salePrice||0) + (sale.additionalCharges || []).reduce((sum, c) => sum + Number(c.amount||0), 0);
                const totalPaid = Number(sale.downPayment||0) + paidInstallments;
                balance += (totalSalePrice - totalPaid);
            });
            if (Math.abs(balance) < 0.01) return {label:'Ù…Ø³ÙˆÙ‰', className:'text-emerald-700'};
            return {label: (balance>0 ? `Ø¹Ù„ÙŠÙ‡ ${formatCurrency(balance)}` : `Ù„Ù‡ ${formatCurrency(Math.abs(balance))}`),
                    className: balance>0 ? 'text-red-600' : 'text-emerald-700'};
        }

        function getSupplierBalanceInfo(supplierId){
            const purchases = db.cars.filter(c => c.supplierId === supplierId).reduce((sum, c) => sum + Number(c.purchasePrice||0), 0);
            const payments = db.supplierPayments.filter(p => p.supplierId === supplierId).reduce((sum, p) => sum + Number(p.amount||0), 0);
            const balance = purchases - payments; // Ù„Ùˆ Ù…ÙˆØ¬Ø¨: Ø¹Ù„ÙŠÙ‡ (Ù…Ø³ØªØ­Ù‚ Ù„Ù„Ù…ÙˆØ±Ø¯)
            if (Math.abs(balance) < 0.01) return {label:'Ù…Ø³ÙˆÙ‰', className:'text-emerald-700'};
            return {label: (balance>0 ? `Ø¹Ù„ÙŠÙ‡ ${formatCurrency(balance)}` : `Ù„Ù‡ ${formatCurrency(Math.abs(balance))}`),
                    className: balance>0 ? 'text-red-600' : 'text-emerald-700'};
        }

        function setupFilterListeners(){
            const globalSearch = document.getElementById('globalSearch');
            if (globalSearch){
                globalSearch.addEventListener('input', () => renderVisibleTab(getActiveTabName()));
            }

            const ids = [
                'purchase-year-filter','purchase-month-filter',
                'sale-year-filter','sale-month-filter',
                'inst-customer-filter','archive-car-filter'
            ];
            ids.forEach(id=>{
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('change', () => renderVisibleTab(getActiveTabName()));
                el.addEventListener('input', () => renderVisibleTab(getActiveTabName()));
            });

            const contractsSearch = document.getElementById('contractsSearch');
            if (contractsSearch){
                contractsSearch.addEventListener('input', () => renderVisibleTab('contracts'));
            }

            // Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
            const printBtn = document.getElementById('printInstallmentStatementBtn') || document.getElementById('print-statement-btn');
            if (printBtn){
                printBtn.onclick = printInstallmentStatement;
            }
        }

        function getActiveTabName(){
            const active = document.querySelector('.tab-link.active');
            return active?.getAttribute('data-tab') || 'dashboard';
        }

        function openEditPurchaseModal(carId){
            const car = db.cars.find(c => c.id === carId);
            if (!car) return showToast('Ø§Ù„Ø³ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
            __editingPurchaseId = carId;

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙÙˆØ±Ù…
            document.getElementById('purchaseSupplier').value = car.supplierId || '';
            document.getElementById('purchaseCarCondition').value = car.carCondition || 'Ù…Ø³ØªØ¹Ù…Ù„Ø©';
            document.getElementById('purchaseCarType').value = car.carType || '';
            document.getElementById('purchaseCarModel').value = car.carModel || '';
            document.getElementById('purchaseModelYear').value = car.modelYear || '';
            document.getElementById('purchaseColor').value = car.color || '';
            document.getElementById('purchaseVin').value = car.vin || '';
            document.getElementById('purchaseEngineNumber').value = car.engineNumber || '';
            (document.getElementById('purchaseOdometer')||document.getElementById('purchaseMileage')).value = car.mileage || car.odometer || '';
            if (document.getElementById('purchasePlateNumber')) document.getElementById('purchasePlateNumber').value = car.plateNumber || '';
            if (document.getElementById('purchaseLicenseExpiry')) document.getElementById('purchaseLicenseExpiry').value = car.licenseExpiry || '';
            if (document.getElementById('purchaseInsuranceExpiry')) document.getElementById('purchaseInsuranceExpiry').value = car.insuranceExpiry || '';
            document.getElementById('purchasePrice').value = car.purchasePrice || '';
            document.getElementById('purchaseDate').value = car.date || getTodayDate();

            const title = document.querySelector('#addPurchaseModal h3');
            if (title) title.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡';
            openModal('addPurchaseModal');
        }

        function openEditSaleModal(saleId){
            const sale = db.sales.find(s => s.id === saleId);
            if (!sale) return showToast('Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');

            const hasPaid = db.installments.some(i => i.saleId === saleId && i.paid);
            if (hasPaid){
                showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ø¹Ù„ÙŠÙ‡Ø§ Ø£Ù‚Ø³Ø§Ø· Ù…Ø³Ø¯Ø¯Ø©.', 'error');
                return;
            }

            __editingSaleId = saleId;

            // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø«Ù… ØªØ¹Ø¨Ø¦Ø©
            openModal('addSaleModal');

            document.getElementById('saleCarId').value = sale.carId || '';
            document.getElementById('saleCarId').disabled = true;
            document.getElementById('saleCustomerId').value = sale.customerId || '';
            document.getElementById('saleCustomerId').disabled = true;
            document.getElementById('saleDate').value = sale.date || getTodayDate();
            document.getElementById('salePrice').value = sale.salePrice || '';
            (document.getElementById('saleDownPayment')||document.getElementById('paymentsDownPayment')||document.getElementById('downPayment')).value = sale.downPayment || 0;
            document.getElementById('saleType').value = sale.saleType || 'Ù†Ù‚Ø¯ÙŠ';

            // Ù…Ù„Ø§Ø­Ø¸Ø§Øª/ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª
            if (document.getElementById('saleNotes')) document.getElementById('saleNotes').value = sale.notes || '';

            // Ø´Ø­Ù† Ø±Ø³ÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ©
            const chargesContainer = document.getElementById('additional-charges-container');
            if (chargesContainer){
                chargesContainer.innerHTML = '';
                (sale.additionalCharges || []).forEach(ch => addAdditionalChargeRow(ch.description, ch.amount));
            }

            // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†ÙˆØ¹
            if (typeof syncSaleTypeUI === 'function') syncSaleTypeUI();

            const title = document.querySelector('#addSaleModal h3');
            if (title) title.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹';
        }

        // =============== Ø§Ù„Ø¹Ù‚ÙˆØ¯ ===============
        function ensureSaleContract(saleId){
            if (!db.contracts) db.contracts = [];
            let contract = db.contracts.find(c => c.saleId === saleId);
            if (contract) return contract;

            const sale = db.sales.find(s => s.id === saleId);
            if (!sale) return null;

            const car = db.cars.find(c => c.id === sale.carId);
            const customer = db.customers.find(c => c.id === sale.customerId);

            ensureShowroomsDefaults();
const showroomDefault = db.showrooms?.[0] || { id: 1, name: 'Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØªÙˆÙƒÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª', owner: 'â€”', phone: '', address: '' };

contract = {
    id: db.contractCounter ? (db.contractCounter++) : (db.contractCounter = 2, 1),
    saleId,
    date: sale.date || getTodayDate(),

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹/Ø§Ù„Ù…Ø¹Ø±Ø¶ (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù‚Ø³Ù… Ø§Ù„Ø¹Ù‚ÙˆØ¯)
    showroomId: showroomDefault.id,
    showroomName: showroomDefault.name || 'Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØªÙˆÙƒÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª',
    showroomOwner: showroomDefault.owner || 'â€”',
    showroomPhone: showroomDefault.phone || '',
    showroomAddress: showroomDefault.address || '',

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠ
    customerName: customer?.name || '',
    customerPhone: customer?.phone || '',
    customerNationalId: customer?.nationalId || customer?.nid || '',
    customerJob: customer?.job || customer?.occupation || '',
    customerAddress: customer?.address || '',

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©
    plateNumber: car?.plateNumber || car?.plate || car?.carPlate || '',
    carBrand: ((car?.carType || '') + ' ' + (car?.carModel || '')).trim(),
    carModel: car?.carModel || '',
    carColor: car?.color || car?.carColor || '',
    modelYear: car?.modelYear || '',
    carDesc: car ? `${car.carType} ${car.carModel} ${car.modelYear}` : '',
    vin: car?.vin || '',
    engineNumber: car?.engineNumber || '',

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙŠØ¹
    saleType: sale.saleType || '',
    salePrice: Number(sale.salePrice||0) + (sale.additionalCharges||[]).reduce((sum,c)=>sum+Number(c.amount||0),0),
    downPayment: Number(sale.downPayment||0),
    notes: sale.notes || ''
};


            db.contracts.push(contract);
            saveData();
            return contract;
        }

        function renderContracts(filter=''){
            const tbody = document.querySelector('#contracts-table tbody');
            if (!tbody) return;
            const f = (filter||'').toLowerCase();
            tbody.innerHTML = '';
            (db.contracts||[])
                .filter(c => (`${c.id}`.includes(f) || (c.customerName||'').toLowerCase().includes(f) || (c.carDesc||'').toLowerCase().includes(f)))
                .sort((a,b)=> new Date(b.date||'1970-01-01') - new Date(a.date||'1970-01-01'))
                .forEach(c=>{
                    tbody.innerHTML += `<tr class="border-b hover:bg-gray-50">
                        <td data-label="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯" class="p-3 font-bold">#${c.id}</td>
                        <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®" class="p-3">${c.date || ''}</td>
                        <td data-label="Ø§Ù„Ø³ÙŠØ§Ø±Ø©" class="p-3">${c.carDesc || ''}</td>
                        <td data-label="Ø§Ù„Ù…Ø´ØªØ±ÙŠ" class="p-3">${c.customerName || ''}</td>
                        <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3 no-print">
                            <div class="flex justify-center items-center gap-3">
                                <button onclick="openContractModal(${c.saleId})" title="ÙØªØ­ Ø§Ù„Ø¹Ù‚Ø¯" class="text-indigo-600">${ICONS.invoice}</button>
                                <button onclick="deleteContract(${c.id})" title="Ø­Ø°Ù" class="text-red-600">${ICONS.delete}</button>
                            </div>
                        </td>
                    </tr>`;
                });
        }

        function deleteContract(contractId){
            openConfirmModal('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø¯ØŸ', ()=>{
                db.contracts = (db.contracts||[]).filter(c=>c.id !== contractId);
                saveData();
                renderVisibleTab('contracts');
            });
        }

        
function buildContractHTML(contract){
    // ØµÙŠØºØ© Ø¹Ù‚Ø¯ Ø·Ø¨Ù‚Ø§Ù‹ Ù„Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø© (Ù…Ø¹ Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
    ensureShowroomsDefaults();
    const cp = db.companyProfile || {};
    const cpPhone = (cp.phones || []).filter(Boolean).join(' - ');

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ø¶
    const showroomName = escapeHtml((contract.showroomName || cp.name || 'Ù…Ø¹Ø±Ø¶ Ø³ÙŠØ§Ø±Ø§Øª'));
    const showroomPhone = escapeHtml((contract.showroomPhone || cpPhone || ''));
    const showroomAddress = escapeHtml((contract.showroomAddress || cp.address || ''));

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ø¦Ø¹ (Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶)
    const empId = Number(contract.sellerEmployeeId || 1);
    const emp = (cp.employees || []).find(e=>Number(e.id)===empId) || (cp.employees || [])[0] || {};
    const sellerName = escapeHtml((contract.sellerName || emp.name || contract.showroomOwner || ''));
    const sellerPhone = escapeHtml((contract.sellerPhone || emp.phone || ''));
    const sellerNID = escapeHtml((contract.sellerNationalId || emp.nationalId || ''));
    const sellerJob = escapeHtml((contract.sellerJob || emp.job || ''));
    const sellerAddress = escapeHtml((contract.sellerAddress || emp.address || ''));

    // Ø§Ù„Ù…Ø´ØªØ±ÙŠ
    const buyerName = escapeHtml(contract.customerName || '');
    const buyerPhone = escapeHtml(contract.customerPhone || '');
    const buyerNID = escapeHtml(contract.customerNationalId || '');
    const buyerJob = escapeHtml(contract.customerJob || '');
    const buyerAddress = escapeHtml(contract.customerAddress || '');

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© â€” Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ø§Ø±ÙƒØ© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø§Ù„Ù†ÙˆØ¹ + Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„)ØŒ ÙˆØ§Ù„Ù…ÙˆØ¯ÙŠÙ„ = Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹
    const carObj = (contract.carId != null) ? (db.cars || []).find(c=> String(c.id)===String(contract.carId)) : null;
    const carNo = escapeHtml(contract.plateNumber || contract.carPlate || (carObj?.plateNumber || carObj?.plate || ''));
    const vin = escapeHtml(contract.vin || carObj?.vin || '');
    const engine = escapeHtml(contract.engineNumber || carObj?.engineNumber || carObj?.engine || '');
    const derivedBrand = ((carObj?.type || '') + ' ' + (carObj?.model || '')).trim();
    const brand = escapeHtml(((contract.carBrand || contract.carType || derivedBrand || '') + '').trim());
    const derivedYear = (carObj?.year ?? carObj?.manufactureYear ?? carObj?.modelYear ?? '');
    const model = escapeHtml(String(contract.modelYear || contract.carYear || contract.carModelYear || derivedYear || ''));
    const color = escapeHtml(contract.carColor || contract.color || carObj?.color || '');
    const salePrice = contract.salePrice != null ? escapeHtml(String(contract.salePrice)) : '';
    const paidNow = contract.downPayment != null ? escapeHtml(String(contract.downPayment)) : '';
    const remaining = (Number(contract.salePrice||0) - Number(contract.downPayment||0));
    const remainingStr = isFinite(remaining) ? escapeHtml(String(remaining)) : '';
    const notes = escapeHtml(contract.notes || '');

    const d = (contract.date || '').toString();
    const todayLine = d ? `<strong>${escapeHtml(d)}</strong>` : '____/____/______';

    const line = (label, value='', w='240px') => `
        <div style="display:flex; gap:10px; align-items:flex-end; margin: 4px 0;">
            <div style="min-width:140px; font-weight:700;">${label}</div>
            <div style="flex:1; border-bottom:1px dotted #000; min-height:18px; padding:0 6px; max-width:${w};">${value || '&nbsp;'}</div>
        </div>
    `;

    const twoCols = (a,b) => `
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:18px;">
            <div>${a}</div>
            <div>${b}</div>
        </div>
    `;

    const html = `
    <div style="max-width: 900px; margin: 0 auto; font-family: Cairo, sans-serif; direction: rtl; line-height: 1.55; color:#000;">
        <div style="border:2px solid #111; padding:14px 14px 10px 14px; border-radius:10px;">
            

            <div style="text-align:center; font-size:16px; font-weight:800; margin:10px 0 14px 0;">
                Ø¹Ù‚Ø¯ Ø¨ÙŠØ¹ Ø³ÙŠØ§Ø±Ø© ØªØ­Øª Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
            </div>
            <div style="text-align:center; font-weight:700; margin-top:-8px; margin-bottom:10px;">${showroomName} ${showroomPhone ? ('- ' + showroomPhone) : ''}</div>

            ${twoCols(
                line('Ø¥Ù†Ù‡ ÙÙŠ ÙŠÙˆÙ…:', todayLine, '300px') + line('Ø§Ù„Ø³Ø§Ø¹Ø©:', '........', '300px'),
                line('Ø§Ù„Ù…ÙˆØ§ÙÙ‚:', '........', '300px') + line('Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:', `<strong>#${escapeHtml(String(contract.id||''))}</strong>`, '300px')
            )}

            <div style="margin-top:10px;">
                ${twoCols(
                    line('Ù‚Ø¯ Ø¨Ø§Ø¹ Ø§Ù„Ø³ÙŠØ¯:', sellerName || showroomName, '360px') +
                    line('Ø§Ù„Ù…Ù‚ÙŠÙ…:', sellerAddress || showroomAddress || '........', '360px') +
                    line('Ø¨Ø·Ø§Ù‚Ø©:', sellerNID || '........', '360px') +
                    line('Ø§Ù„Ù…Ù‡Ù†Ø©:', sellerJob || '........', '360px'),
                    line('Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ¯:', buyerName, '360px') +
                    line('Ø§Ù„Ù…Ù‚ÙŠÙ…:', buyerAddress || '........', '360px') +
                    line('Ø¨Ø·Ø§Ù‚Ø©:', buyerNID || '........', '360px') +
                    line('Ø§Ù„Ù…Ù‡Ù†Ø©:', buyerJob || '........', '360px')
                )}
            </div>

            <div style="margin-top:6px;">
                ${twoCols(
                    line('Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø±Ù‚Ù…:', carNo || '........', '360px') +
                    line('Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡:', vin || '........', '360px'),
                    line('Ù…Ø§Ø±ÙƒØ©:', brand || '........', '360px') +
                    line('Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØªÙˆØ±:', engine || '........', '360px')
                )}
                ${twoCols(
                    line('Ù…ÙˆØ¯ÙŠÙ„:', model || '........', '360px'),
                    line('Ø§Ù„Ù„ÙˆÙ†:', color || '........', '360px')
                )}
            </div>

            <div style="margin-top:10px;">
                ${line('ÙˆØ°Ù„Ùƒ Ù†Ø¸ÙŠØ± Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡:', salePrice || '........', '520px')}
                ${line('Ø¯ÙØ¹ Ø¹Ù†Ø¯ ÙƒØªØ§Ø¨Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯:', paidNow || '........', '520px')}
                ${line('ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ÙˆÙ‚Ø¯Ø±Ù‡:', remainingStr || '........', '520px')}
            </div>

            ${notes ? `<div style="margin-top:8px; font-size:12px;"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${notes}</div>` : ''}

            <div style="margin-top:12px; font-size:12px;">
                <div style="font-weight:800; margin-bottom:6px;">Ø´Ø±ÙˆØ· ÙˆØªØ¹Ù‡Ø¯Ø§Øª:</div>
                <ol style="margin:0; padding-right:18px;">
                    <li>Ù‡Ø°Ø§ ÙˆÙ‚Ø¯ Ø£Ù‚Ø± Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø£Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© Ø®Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ø· ÙˆÙ„ÙŠØ³ Ø¹Ù„ÙŠÙ‡Ø§ Ù…Ø´Ø§ÙƒÙ„ Ù„Ø£ÙŠ Ø¬Ù‡Ø©.</li>
                    <li>Ø£Ù‚Ø± Ø§Ù„Ù…Ø´ØªØ±ÙŠ Ø£Ù†Ù‡ Ø¹Ø§ÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ§Ù…Ø© Ø§Ù„Ù†Ø§ÙÙŠØ© Ù„Ù„Ø¬Ù‡Ø§Ù„Ø©.</li>
                    <li>ÙˆÙ‚Ø¯ Ø£Ù‚Ø± Ø·Ø±ÙÙŠ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø¥ØªÙ…Ø§Ù…Ù‡Ù…Ø§ Ø§Ù„ØªØ§Ù…Ø© Ù„Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡ØŒ ÙˆØ¥Ø°Ø§ ØªØ±Ø§Ø¬Ø¹ Ø£Ø­Ø¯ Ø§Ù„Ø·Ø±ÙÙŠÙ† ÙŠÙ„Ø²Ù… Ø¨Ø¯ÙØ¹ Ù…Ø¨Ù„Øº <strong>4000</strong> Ø¬Ù†ÙŠÙ‡ ÙƒØ´Ø±Ø· Ø¬Ø²Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±Ø§Ø¬Ø¹.</li>
                    <li>ÙŠÙ‚Ø± Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø§Ù„Ù…Ø´ØªØ±ÙŠ) Ø¨Ø¯ÙØ¹ ØºØ±Ø§Ù…Ø© ØªØ£Ø®ÙŠØ± Ø¨Ù†Ø³Ø¨Ø© <strong>5%</strong> ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ£Ø®ÙŠØ± ÙÙŠ Ø§Ù„Ø³Ø¯Ø§Ø¯.</li>
                </ol>
            </div>

            <div style="margin-top:18px; display:flex; justify-content:space-between; font-size:14px; font-weight:700;">
                <div style="width:45%; text-align:center;">
                    <div style="margin-bottom:28px;">Ø§Ù„Ù…Ø´ØªØ±ÙŠ</div>
                    <div style="border-top:1px solid #000; padding-top:6px;">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
                </div>
                <div style="width:45%; text-align:center;">
                    <div style="margin-bottom:28px;">Ø§Ù„Ø¨Ø§Ø¦Ø¹</div>
                    <div style="border-top:1px solid #000; padding-top:6px;">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
                </div>
            </div>

            
            <div style="margin-top:14px; border-top:2px dashed #000; padding-top:8px; font-size:11px; page-break-inside: avoid;">
                <div style="text-align:center; font-weight:800; margin-bottom:6px;">Ø¥Ù‚Ø±Ø§Ø± Ø§Ø³ØªÙ„Ø§Ù… Ø³ÙŠØ§Ø±Ø©</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
                    <div>
                        ${line('Ø§Ø³ØªÙ„Ù…Øª Ø£Ù†Ø§ Ø§Ù„Ø³ÙŠØ¯:', buyerName || '........', '360px')}
                        ${line('Ø§Ù„Ù…Ù‚ÙŠÙ…:', buyerAddress || '........', '360px')}
                    </div>
                    <div>
                        ${line('Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø±Ù‚Ù…:', carNo || '........', '360px')}
                        ${line('Ø´Ø§Ø³ÙŠØ©:', vin || '........', '360px')}
                        ${line('Ù…Ø§ØªÙˆØ±:', engine || '........', '360px')}
                    </div>
                </div>
                <div style="margin-top:6px; line-height:1.6;">
                    ÙˆØ£ØµØ¨Ø­Øª Ù…Ø³Ø¤ÙˆÙ„Ø§Ù‹ Ø¹Ù†Ù‡Ø§ Ù…Ø¯Ù†ÙŠØ§Ù‹ ÙˆØ¬Ù†Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø©:
                    <span style="display:inline-block; min-width:90px; border-bottom:1px dotted #000;">&nbsp;</span>
                    ÙŠÙˆÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚:
                    <span style="display:inline-block; min-width:120px; border-bottom:1px dotted #000;">&nbsp;</span>
                </div>
                <div style="margin-top:10px; display:flex; justify-content:flex-start;">
                    <div style="width:45%; text-align:center;">
                        <div style="margin-bottom:28px; font-weight:700;">Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
                        <div style="border-top:1px solid #000; padding-top:6px;">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</div>
                    </div>
                </div>
            </div>
</div>
    </div>
    `;
    return html;
}


        function openContractModal(saleId){
            const contract = ensureSaleContract(saleId);
            if (!contract) return showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯', 'error');
            __currentContractSaleId = saleId;

            // Preview
            const content = document.getElementById('contractContent');
            if (content) content.innerHTML = buildContractHTML(contract);

            // Reset edit panel (it will be filled Ø¹Ù†Ø¯Ù…Ø§ ØªØ¶ØºØ· "ØªØ¹Ø¯ÙŠÙ„")
            const panel = document.getElementById('contractEditPanel');
            if (panel) panel.style.display = 'none';
            setupContractEditListeners();

            openModal('contractModal');
        }

        function printCurrentContract(){
            const contract = ensureSaleContract(__currentContractSaleId);
            if (!contract) return;

            const body = buildContractHTML(contract);

            // Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Letterhead ÙˆØ¨Ø¯ÙˆÙ† Header Ø¥Ø¶Ø§ÙÙŠ (ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©)
            const html = `
                <style>
                    @page{ size: A4; margin: 6mm; }
                    body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size:12px; }
                    .print-wrap{ padding:0 !important; }
                </style>
                ${body}
            `;
            openPrintWindow('Ø¹Ù‚Ø¯ Ø¨ÙŠØ¹ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', html, {letterhead:false});
        }


        function printContractsList(){
            const table = document.getElementById('contracts-table')?.outerHTML || '';
            const body = `<div style="direction:rtl; font-family:Cairo,sans-serif;">${table}</div>`;
            const html = generateStandardPrintLayout('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯', body, 'CONTRACTS-LIST');
            openPrintWindow('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯', html, {letterhead:false});
        }

document.addEventListener('DOMContentLoaded', () => {
            loadData();
            if (typeof ensureCustodyDefaults==='function') ensureCustodyDefaults();
            if (typeof ensureMaintenanceDefaults==='function') ensureMaintenanceDefaults();

            // Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø± (Ø¨Ø¯ÙˆÙ† ØµÙØ­Ø© Ù…Ø³ØªØ®Ø¯Ù…/ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±)
            currentUser = db.users?.find(u => u.username === 'admin') || db.users?.[0] || { name: 'Ù…Ø³ØªØ®Ø¯Ù…', role: 'admin' };

            const appContainer = document.getElementById('app-container');
            if (appContainer) appContainer.style.display = 'block';
            const overlay = document.getElementById('password-overlay');
            if (overlay) overlay.style.display = 'none';

            // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¥Ù† ÙˆÙØ¬Ø¯
            const userNameEl = document.getElementById('current-user-name');
            if (userNameEl) userNameEl.textContent = currentUser?.name || 'Ù…Ø³ØªØ®Ø¯Ù…';

            applyPermissions();
            setupFormListeners();
            setupFilterListeners();
            populateFilterDropdowns();
            renderAll();

            // ÙØªØ­ Ø£ÙˆÙ„ ØªØ¨ÙˆÙŠØ¨ Ø¸Ø§Ù‡Ø±
            const firstVisibleTab = document.querySelector('.tab-link:not(.hidden)');
            if (firstVisibleTab) firstVisibleTab.click();
            else openTab(null, 'dashboard');

            updateClock();
            setInterval(updateClock, 1000);
        
            // ERP modules init
            const cDate = document.getElementById('custodyDate');
            if (cDate && !cDate.value) cDate.value = getTodayDate();

            const custodyForm = document.getElementById('custodyForm');
            if (custodyForm) {
                custodyForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    addCustody({
                        date: document.getElementById('custodyDate').value,
                        employee: document.getElementById('custodyEmployee').value.trim(),
                        statement: document.getElementById('custodyStatement').value.trim(),
                        amount: document.getElementById('custodyAmount').value,
                        status: document.getElementById('custodyStatus').value,
                        notes: document.getElementById('custodyNotes').value.trim()
                    });
                    closeModal('custodyModal');
                    custodyForm.reset();
                    const cDate2 = document.getElementById('custodyDate');
                    if (cDate2) cDate2.value = getTodayDate();
                });
            }
});

        function openAddMaintenanceModal(carId) {
            const car = db.cars.find(c => c.id === carId);
            if (!car) return;
            document.getElementById('addMaintenanceForm').reset();
            document.getElementById('maintenanceCarId').value = carId;
            document.getElementById('maintenanceCarName').textContent = `${car.carType} ${car.carModel}`;
            document.getElementById('maintenanceDate').value = getTodayDate();
            openModal('addMaintenanceModal');
        }

        function openAddQuoteModal(carId = null) {
            openModal('addQuoteModal');
            if (carId) {
                document.getElementById('quoteCarId').value = carId;
            }
        }
        
        const renderQuotes = (filter) => {
            const tbody = document.querySelector("#quotes-table tbody");
            tbody.innerHTML = "";
            const today = new Date().toISOString().slice(0, 10);

            db.quotes.forEach(quote => {
                const car = db.cars.find(c => c.id === quote.carId);
                const customer = db.customers.find(c => c.id === quote.customerId);

                if (!car || !customer) return;

                if (quote.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' && quote.expiryDate < today) {
                    quote.status = 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©';
                    saveData();
                }

                let statusClass = '';
                switch(quote.status) {
                    case 'Ù…Ù‚Ø¨ÙˆÙ„': statusClass = 'bg-green-200 text-green-800'; break;
                    case 'Ù…Ø±ÙÙˆØ¶': statusClass = 'bg-red-200 text-red-800'; break;
                    case 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©': statusClass = 'bg-gray-200 text-gray-800'; break;
                    default: statusClass = 'bg-yellow-200 text-yellow-800';
                }
                
                const actions = `
                    <div class="flex justify-center items-center gap-3">
                        <button onclick="printQuote(${quote.id})" title="Ø·Ø¨Ø§Ø¹Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±" class="text-blue-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6v-8z"/></svg></button>
                        ${quote.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' ? `<button onclick="acceptQuote(${quote.id})" title="Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹" class="text-green-600 font-bold">âœ“ Ù‚Ø¨ÙˆÙ„</button>` : ''}
                        <button onclick="deleteQuote(${quote.id})" title="Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶" class="text-red-600">${ICONS.delete}</button>
                    </div>
                `;

                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td data-label="Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶" class="p-3 font-semibold">#${quote.quoteNumber}</td>
                        <td data-label="Ø§Ù„Ø¹Ù…ÙŠÙ„" class="p-3">${customer.name}</td>
                        <td data-label="Ø§Ù„Ø³ÙŠØ§Ø±Ø©" class="p-3">${car.carType} ${car.carModel}</td>
                        <td data-label="Ø§Ù„Ø³Ø¹Ø±" class="p-3 font-bold">${formatCurrency(quote.price)}</td>
                        <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" class="p-3">${quote.expiryDate}</td>
                        <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©" class="p-3"><span class="px-2 py-1 rounded-full text-xs font-semibold ${statusClass}">${quote.status}</span></td>
                        <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3 no-print">${actions}</td>
                    </tr>`;
            });
        };

        function printQuote(quoteId) {
            const quote = db.quotes.find(q => q.id === quoteId);
            const car = db.cars.find(c => c.id === quote.carId);
            const customer = db.customers.find(c => c.id === quote.customerId);
            if (!quote || !car || !customer) return;

            const mainTitle = 'Ø¹Ø±Ø¶ Ø³Ø¹Ø±';
            const contentHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 20px;">
                     <div><p><strong>Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ¯/Ø©:</strong> ${customer.name}</p><p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${customer.phone || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</p></div>
                     <div><p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¶:</strong> #${quote.quoteNumber}</p><p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¶:</strong> ${new Date().toISOString().slice(0,10)}</p></div>
                </div>
                <p style="margin-top: 20px;">Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ÙƒÙ…ØŒ ÙŠØ´Ø±ÙÙ†Ø§ Ø£Ù† Ù†Ù‚Ø¯Ù… Ù„ÙƒÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ø³ÙŠØ§Ø±Ø©:</p>
                <table style="width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 14px;">
                    <thead style="background-color: #f9fafb;">
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                            <th style="border: 1px solid #ddd; padding: 12px; text-align: center; width: 150px;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 12px;">Ø³ÙŠØ§Ø±Ø© ${car.carType} ${car.carModel} Ù…ÙˆØ¯ÙŠÙ„ ${car.modelYear}<br><small style="color: #666;">Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡: ${car.vin}</small></td>
                            <td style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold;">${formatCurrency(quote.price)}</td>
                        </tr>
                    </tbody>
                </table>
                <div style="margin-top: 20px; padding: 10px; background-color:#f3f4f6; border: 1px solid #eee; border-radius: 5px;">
                     <p><strong>Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${quote.notes || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                     <p><strong>Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ Ø³Ø§Ø±Ù Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ®:</strong> <span style="font-weight: bold; color: #b91c1c;">${quote.expiryDate}</span></p>
                </div>
                <div style="margin-top: 60px; text-align: center;">
                    <p>Ù…Ø¹ Ø®Ø§Ù„Øµ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±</p>
                    <p><strong>Ø¥Ø¯Ø§Ø±Ø©: Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØªÙˆÙƒÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ù‡ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</strong></p>
                </div>
            `;

            const fullQuoteHTML = generateStandardPrintLayout(mainTitle, contentHTML, `QUOTE-${quote.id}`);
            document.getElementById('invoiceContent').innerHTML = fullQuoteHTML;
            openModal('invoiceModal');
            setTimeout(() => JsBarcode("#barcode", `QUOTE-${quote.id}`, { height: 40, displayValue: false }), 100);
        }

        function acceptQuote(quoteId) {
            const quote = db.quotes.find(q => q.id === quoteId);
            if (!quote) return;
            
            openConfirmModal(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­ÙˆÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± #${quote.quoteNumber} Ø¥Ù„Ù‰ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ØŸ`, () => {
                quote.status = 'Ù…Ù‚Ø¨ÙˆÙ„';
                
                openModal('addSaleModal');
                document.getElementById('saleCarId').value = quote.carId;
                document.getElementById('saleCustomerId').value = quote.customerId;
                document.getElementById('salePrice').value = quote.price;
                
                logActivity(`ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± #${quote.quoteNumber} ÙˆØ¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹.`);
                saveData();
                renderAll();
                showToast(`ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙŠØ¹.`);
            });
        }

        function deleteQuote(quoteId) {
            openConfirmModal('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ù‡Ø°Ø§ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŸ', () => {
                db.quotes = db.quotes.filter(q => q.id !== quoteId);
                logActivity(`ØªÙ… Ø­Ø°Ù Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± ID ${quoteId}`);
                saveData();
                renderAll();
                showToast('ØªÙ… Ø­Ø°Ù Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø±.');
            });
        }

        function setupMaintenanceFormListener() {
            document.getElementById('addMaintenanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const carId = parseInt(document.getElementById('maintenanceCarId').value);
                const car = db.cars.find(c => c.id === carId);
                const newLog = {
                    id: getNextId('maintenanceLog'),
                    carId: carId,
                    description: document.getElementById('maintenanceDescription').value,
                    workshop: document.getElementById('maintenanceWorkshop').value,
                    parts: document.getElementById('maintenanceParts').value,
                    cost: parseFloat(document.getElementById('maintenanceCost').value),
                    odometer: document.getElementById('maintenanceOdometer').value,
                    date: document.getElementById('maintenanceDate').value,
                    createdBy: currentUser.name
                };
                db.maintenanceLog.push(newLog);
                logActivity(`Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØµÙŠØ§Ù†Ø© Ù„Ø³ÙŠØ§Ø±Ø© ${car.carType} ${car.carModel} Ø¨Ù‚ÙŠÙ…Ø© ${formatCurrency(newLog.cost)}`);

                const expenseDescription = `ØµÙŠØ§Ù†Ø© Ù„Ø³ÙŠØ§Ø±Ø©: ${car.carType} ${car.carModel} (Ø´Ø§Ø³ÙŠÙ‡: ${car.vin})`;
                const newExpense = {
                    id: getNextId('expenses'),
                    createdBy: currentUser.name,
                    description: expenseDescription,
                    type: 'ØµÙŠØ§Ù†Ø©',
                    amount: newLog.cost,
                    date: newLog.date,
                    maintenanceLogId: newLog.id
                };
                db.expenses.push(newExpense);
                logActivity(`ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ ØµÙŠØ§Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù‚ÙŠÙ…Ø© ${formatCurrency(newLog.cost)}`);

                saveData();
                showToast("ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…ØµØ±ÙˆÙØ§Øª.");
                closeModal('addMaintenanceModal');
                openCarDetailsModal(carId); 
                updateSummary();
                renderExpenses('');
            });
        }
        
        function renderInventoryAgingReport() {
            const tbody = document.querySelector('#aging-report-table tbody');
            tbody.innerHTML = "";
            const today = new Date();
            const availableCars = db.cars
                .filter(c => c.status === CAR_STATUSES.AVAILABLE)
                .map(car => {
                    const purchaseDate = new Date(car.date);
                    const diffTime = Math.abs(today - purchaseDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 3600 * 24));
                    return { ...car, daysInStock: diffDays };
                })
                .sort((a,b) => b.daysInStock - a.daysInStock);

            if (availableCars.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>`;
                return;
            }

            availableCars.forEach(car => {
                let rowClass = '';
                if(car.daysInStock > 90) rowClass = 'aging-danger';
                else if (car.daysInStock > 30) rowClass = 'aging-warning';

                tbody.innerHTML += `
                    <tr class="${rowClass} border-b">
                        <td data-label="Ø§Ù„Ø³ÙŠØ§Ø±Ø©" class="p-3">${car.carType} ${car.carModel} ${car.modelYear}</td>
                        <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡" class="p-3">${car.date}</td>
                        <td data-label="Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†" class="p-3 font-bold">${car.daysInStock} ÙŠÙˆÙ…</td>
                        <td data-label="ØªÙƒÙ„ÙØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©" class="p-3">${formatCurrency(car.purchasePrice + getMaintenanceCostForCar(car.id))}</td>
                    </tr>
                `;
            });
        }


        // ===================== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© =====================
        function _parseDateSafe(d){
            if(!d) return null;
            const dt = new Date(d);
            return isNaN(dt.getTime()) ? null : dt;
        }
        function _fmtMoney(n){ return formatCurrency(Number(n||0)); }
        function _fmtPct(n){ return (Number(n||0)).toFixed(1) + '%'; }

        function _getSaleTotal(sale){
            const base = Number(sale.salePrice || sale.totalPrice || sale.price || 0);
            const add = (sale.additionalCharges || []).reduce((sum,c)=> sum + Number(c.amount||0), 0);
            return base + add;
        }

        function _getPaidForSale(sale){
            const down = Number(sale.downPayment||0);
            const paidInst = db.installments
                .filter(i => i.saleId === sale.id && i.paid)
                .reduce((sum,i)=> sum + Number(i.amount||0), 0);
            // ÙÙŠ Ø§Ù„ÙƒØ§Ø´: Ø§Ø¹ØªØ¨Ø± Ø§Ù„Ø¨ÙŠØ¹ ÙƒÙ„Ù‡ Ù…Ø¯ÙÙˆØ¹
            const isInstallments = (sale.paymentType === 'installment' || sale.paymentMethod === 'installment' || sale.isInstallments);
            if(!isInstallments) return _getSaleTotal(sale);
            return down + paidInst;
        }

        function _getRemainingForSale(sale){
            const total = _getSaleTotal(sale);
            const isInstallments = (sale.paymentType === 'installment' || sale.paymentMethod === 'installment' || sale.isInstallments);
            if(!isInstallments) return 0;
            const loan = total - Number(sale.downPayment||0);
            const paidInst = db.installments
                .filter(i => i.saleId === sale.id && i.paid)
                .reduce((sum,i)=> sum + Number(i.amount||0), 0);
            return Math.max(0, loan - paidInst);
        }

        function _getPeriodKey(dateStr, group){
            const d = _parseDateSafe(dateStr);
            if(!d) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            return group === 'year' ? String(y) : `${y}-${m}`;
        }

        function renderFinancialAnalytics(){
            // ØªØ£ÙƒØ¯ Ø¥Ù†Ù†Ø§ Ø¯Ø§Ø®Ù„ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
            if(!document.getElementById('financial-analytics-container')) return;

            const fromInput = document.getElementById('fin-from');
            const toInput = document.getElementById('fin-to');
            const group = document.getElementById('fin-group')?.value || 'month';

            // Ø§ÙØªØ±Ø§Ø¶Ø§Øª Ø°ÙƒÙŠØ© Ù„Ù„ÙØªØ±Ø©
            const today = new Date();
            const yearStart = new Date(today.getFullYear(), 0, 1);

            if(fromInput && !fromInput.value) fromInput.value = yearStart.toISOString().slice(0,10);
            if(toInput && !toInput.value) toInput.value = today.toISOString().slice(0,10);

            const fromDate = _parseDateSafe(fromInput?.value) || yearStart;
            const toDate = _parseDateSafe(toInput?.value) || today;
            // Ø§Ø¬Ø¹Ù„ toDate Ø´Ø§Ù…Ù„ Ø§Ù„ÙŠÙˆÙ…
            toDate.setHours(23,59,59,999);

            const salesInRange = db.sales.filter(s => {
                const d = _parseDateSafe(s.date);
                if(!d) return false;
                return d >= fromDate && d <= toDate;
            });

            // ===== KPI + Car Profit Table =====
            const carProfitTbody = document.querySelector('#car-profit-table tbody');
            if(carProfitTbody) carProfitTbody.innerHTML = '';

            let totalProfit = 0;
            let totalSalesAmount = 0;
            let totalMargins = [];
            let best = null;
            let worst = null;

            const carProfitRows = [];

            salesInRange.forEach(sale => {
                const car = db.cars.find(c => c.id === sale.carId);
                const customer = db.customers.find(cu => cu.id === sale.customerId);
                const saleTotal = _getSaleTotal(sale);
                const purchase = Number(car?.purchasePrice || 0);
                const maint = Number(getMaintenanceCostForCar(car?.id) || 0);
                const profit = saleTotal - purchase - maint;
                const margin = saleTotal > 0 ? (profit / saleTotal) * 100 : 0;

                totalProfit += profit;
                totalSalesAmount += saleTotal;
                totalMargins.push(margin);

                const rowObj = { sale, car, customer, saleTotal, purchase, maint, profit, margin };
                carProfitRows.push(rowObj);

                if(!best || profit > best.profit) best = rowObj;
                if(!worst || profit < worst.profit) worst = rowObj;
            });

            // Ø±ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø±Ø¨Ø­
            carProfitRows.sort((a,b)=> b.profit - a.profit);

            if(carProfitTbody){
                if(carProfitRows.length === 0){
                    carProfitTbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</td></tr>`;
                } else {
                    carProfitRows.forEach(r => {
                        const carName = r.car ? `${r.car.carType} ${r.car.carModel} ${r.car.modelYear||''}` : 'Ù…Ø­Ø°ÙˆÙ';
                        const custName = r.customer?.name || '';
                        const profitClass = r.profit >= 0 ? 'text-green-700 font-bold' : 'text-red-700 font-bold';
                        carProfitTbody.innerHTML += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="p-3">${carName}</td>
                                <td class="p-3">${custName}</td>
                                <td class="p-3">${_fmtMoney(r.saleTotal)}</td>
                                <td class="p-3">${_fmtMoney(r.purchase)}</td>
                                <td class="p-3">${_fmtMoney(r.maint)}</td>
                                <td class="p-3 ${profitClass}">${_fmtMoney(r.profit)}</td>
                                <td class="p-3">${_fmtPct(r.margin)}</td>
                            </tr>
                        `;
                    });
                }
            }

            const avgMargin = totalMargins.length ? (totalMargins.reduce((a,b)=>a+b,0) / totalMargins.length) : 0;

            // ===== AR / AP =====
            // AR: Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„
            const arMap = new Map();
            db.sales.forEach(sale => {
                const remaining = _getRemainingForSale(sale);
                if(remaining <= 0) return;
                // Ø§Ø¹ØªØ¨Ø± ÙÙ‚Ø· Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØªØ±Ø© (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„)
                const d = _parseDateSafe(sale.date);
                if(!d || d < fromDate || d > toDate) return;
                arMap.set(sale.customerId, (arMap.get(sale.customerId)||0) + remaining);
            });

            // totals for each customer (for table): total sale, paid, remaining
            const arDetails = [];
            db.customers.forEach(c => {
                let total = 0, paid = 0, rem = 0;
                db.sales.filter(s => s.customerId === c.id).forEach(sale => {
                    const d = _parseDateSafe(sale.date);
                    if(!d || d < fromDate || d > toDate) return;
                    total += _getSaleTotal(sale);
                    paid += _getPaidForSale(sale);
                    rem  += _getRemainingForSale(sale);
                });
                if(total > 0 || rem > 0) arDetails.push({ name: c.name, total, paid, rem });
            });
            arDetails.sort((a,b)=> b.rem - a.rem);

            const arTbody = document.querySelector('#ar-table tbody');
            if(arTbody){
                arTbody.innerHTML = '';
                if(arDetails.length===0){
                    arTbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…Ù„Ø§Ø¡ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØªØ±Ø©.</td></tr>`;
                } else {
                    arDetails.slice(0, 25).forEach(r => {
                        const remClass = r.rem > 0 ? 'text-amber-700 font-bold' : 'text-gray-600';
                        arTbody.innerHTML += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="p-3">${r.name}</td>
                                <td class="p-3">${_fmtMoney(r.total)}</td>
                                <td class="p-3">${_fmtMoney(r.paid)}</td>
                                <td class="p-3 ${remClass}">${_fmtMoney(r.rem)}</td>
                            </tr>
                        `;
                    });
                }
            }

            // AP: Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ±Ø¯ - Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯
            const apDetails = [];
            db.suppliers.forEach(sup => {
                const purchases = db.cars.filter(c => c.supplierId === sup.id).reduce((sum,c)=> sum + Number(c.purchasePrice||0), 0);
                const pays = db.supplierPayments.filter(p => p.supplierId === sup.id).reduce((sum,p)=> sum + Number(p.amount||0), 0);
                const rem = Math.max(0, purchases - pays);
                // Ù†Ø¹Ø±Ø¶ ÙƒÙ„Ù‡Ù… Ù„ÙƒÙ† Ù†ÙÙ„ØªØ± ÙÙŠ KPI Ø¨Ø§Ù„Ù„ÙŠ Ù„Ù‡Ù… Ø¨Ø§Ù‚ÙŠ
                if(purchases > 0 || rem > 0) apDetails.push({ name: sup.name, purchases, pays, rem });
            });
            apDetails.sort((a,b)=> b.rem - a.rem);

            const apTbody = document.querySelector('#ap-table tbody');
            if(apTbody){
                apTbody.innerHTML = '';
                if(apDetails.length===0){
                    apTbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ±Ø¯ÙŠÙ†.</td></tr>`;
                } else {
                    apDetails.slice(0, 25).forEach(r => {
                        const remClass = r.rem > 0 ? 'text-rose-700 font-bold' : 'text-gray-600';
                        apTbody.innerHTML += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="p-3">${r.name}</td>
                                <td class="p-3">${_fmtMoney(r.purchases)}</td>
                                <td class="p-3">${_fmtMoney(r.pays)}</td>
                                <td class="p-3 ${remClass}">${_fmtMoney(r.rem)}</td>
                            </tr>
                        `;
                    });
                }
            }

            const totalAR = arDetails.reduce((s,r)=> s + r.rem, 0);
            const totalAP = apDetails.reduce((s,r)=> s + r.rem, 0);

            // ===== Profits by period =====
            const periodMap = new Map();
            salesInRange.forEach(sale => {
                const key = _getPeriodKey(sale.date, group);
                const car = db.cars.find(c => c.id === sale.carId);
                const saleTotal = _getSaleTotal(sale);
                const purchase = Number(car?.purchasePrice || 0);
                const maint = Number(getMaintenanceCostForCar(car?.id) || 0);
                if(!periodMap.has(key)) periodMap.set(key, { count:0, sale:0, purchase:0, maint:0 });
                const agg = periodMap.get(key);
                agg.count += 1;
                agg.sale += saleTotal;
                agg.purchase += purchase;
                agg.maint += maint;
            });

            const periodRows = [...periodMap.entries()]
                .map(([period, agg]) => ({ period, ...agg, profit: agg.sale - agg.purchase - agg.maint }))
                .sort((a,b)=> a.period.localeCompare(b.period));

            const periodTbody = document.querySelector('#profits-by-period-table tbody');
            if(periodTbody){
                periodTbody.innerHTML = '';
                if(periodRows.length===0){
                    periodTbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</td></tr>`;
                } else {
                    periodRows.forEach(r => {
                        const profitClass = r.profit >= 0 ? 'text-green-700 font-bold' : 'text-red-700 font-bold';
                        periodTbody.innerHTML += `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="p-3 font-bold">${r.period}</td>
                                <td class="p-3">${r.count}</td>
                                <td class="p-3">${_fmtMoney(r.sale)}</td>
                                <td class="p-3">${_fmtMoney(r.purchase)}</td>
                                <td class="p-3">${_fmtMoney(r.maint)}</td>
                                <td class="p-3 ${profitClass}">${_fmtMoney(r.profit)}</td>
                            </tr>
                        `;
                    });
                }
            }

            // ===== Fill KPI =====
            const elProfit = document.getElementById('kpi-total-profit');
            const elMargin = document.getElementById('kpi-avg-margin');
            const elAR = document.getElementById('kpi-ar');
            const elAP = document.getElementById('kpi-ap');
            if(elProfit) elProfit.textContent = _fmtMoney(totalProfit);
            if(elMargin) elMargin.textContent = _fmtPct(avgMargin);
            if(elAR) elAR.textContent = _fmtMoney(totalAR);
            if(elAP) elAP.textContent = _fmtMoney(totalAP);

            // ===== Story =====
            const story = document.getElementById('financial-story');
            if(story){
                const topCustomer = arDetails.find(r=> r.rem>0);
                const topSupplier = apDetails.find(r=> r.rem>0);
                const bestTxt = best ? `Ø£ÙØ¶Ù„ ØµÙÙ‚Ø© ÙƒØ§Ù†Øª Ø³ÙŠØ§Ø±Ø© <b>${best.car ? `${best.car.carType} ${best.car.carModel}` : 'Ù…Ø­Ø°ÙˆÙ'}</b> Ø¨Ø±Ø¨Ø­ <b>${_fmtMoney(best.profit)}</b>.` : `Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØªØ±Ø©.`;
                const worstTxt = worst ? `Ø£Ø¶Ø¹Ù ØµÙÙ‚Ø© ÙƒØ§Ù†Øª <b>${worst.car ? `${worst.car.carType} ${worst.car.carModel}` : 'Ù…Ø­Ø°ÙˆÙ'}</b> Ø¨Ø±Ø¨Ø­/Ø®Ø³Ø§Ø±Ø© <b>${_fmtMoney(worst.profit)}</b>.` : '';
                const arTxt = topCustomer ? `Ø£ÙƒØ¨Ø± Ø¹Ù…ÙŠÙ„ Ù…Ø¯ÙŠÙˆÙ†: <b>${topCustomer.name}</b> Ø¹Ù„ÙŠÙ‡ <b>${_fmtMoney(topCustomer.rem)}</b>.` : `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø¹Ù…Ù„Ø§Ø¡ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØªØ±Ø©.`;
                const apTxt = topSupplier ? `Ø£ÙƒØ¨Ø± Ù…ÙˆØ±Ø¯ Ù…Ø³ØªØ­Ù‚: <b>${topSupplier.name}</b> Ù„Ù‡ <b>${_fmtMoney(topSupplier.rem)}</b>.` : `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù…ÙˆØ±Ø¯ÙŠÙ†.`;
                const headline = totalProfit >= 0
                    ? `Ø§Ù„ÙØªØ±Ø© Ø¯ÙŠ "Ù…ÙØ±Ø¨Ø­Ø©" âœ… â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­ <b>${_fmtMoney(totalProfit)}</b> Ø¨Ù‡Ø§Ù…Ø´ Ù…ØªÙˆØ³Ø· <b>${_fmtPct(avgMargin)}</b>.`
                    : `Ø§Ù„ÙØªØ±Ø© Ø¯ÙŠ ÙÙŠÙ‡Ø§ Ø®Ø³Ø§Ø±Ø© âš ï¸ â€” Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© <b>${_fmtMoney(totalProfit)}</b>.`;

                story.innerHTML = `
                    <div class="space-y-3">
                        <div>${headline}</div>
                        <div>${bestTxt}</div>
                        <div>${worstTxt}</div>
                        <div>${arTxt}</div>
                        <div>${apTxt}</div>
                        <div class="text-xs text-gray-500 mt-2">
                            Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø±Ø¨Ø­ Ù…Ø­Ø³ÙˆØ¨ = (Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ + Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª) âˆ’ (Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡) âˆ’ (Ù…ØµØ§Ø±ÙŠÙ ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©).
                        </div>
                    </div>
                `;
            }
        }

        function printFinancialAnalytics(){
            // Ø§Ø·Ø¨Ø¹ Ù†ÙØ³ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„
            if(typeof printContent === 'function') {
                printContent('financial-analytics-print');
            } else {
                window.print();
            }
        }
        // ===================== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© =====================


        function openSettingsModal() {
            resetUserForm();
            renderUsersTable();
            openModal('settingsModal');
        }

        function renderUsersTable() {
            const tbody = document.querySelector("#users-table tbody");
            tbody.innerHTML = "";
            db.users.forEach(user => {
                const actions = user.isDeveloper 
                    ? `<button onclick="editUser(${user.id})" title="ØªØ¹Ø¯ÙŠÙ„" class="text-blue-600">${ICONS.edit}</button>`
                    : `<div class="flex justify-center items-center gap-3">
                           <button onclick="editUser(${user.id})" title="ØªØ¹Ø¯ÙŠÙ„" class="text-blue-600">${ICONS.edit}</button>
                           <button onclick="deleteUser(${user.id})" title="Ø­Ø°Ù" class="text-red-600">${ICONS.delete}</button>
                       </div>`;
                
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td data-label="Ø§Ù„Ø§Ø³Ù…" class="p-3">${user.name}</td>
                        <td data-label="Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„" class="p-3">${user.username}</td>
                        <td data-label="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="p-3">${user.password}</td>
                        <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="p-3 no-print">${actions}</td>
                    </tr>`;
            });
        }

        function editUser(id) {
            const user = db.users.find(u => u.id === id);
            if (!user) return;
            
            document.getElementById('user-form-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-fullname').value = user.name;
            document.getElementById('user-username').value = user.username;
            document.getElementById('user-password').value = user.password;
            document.getElementById('user-permissions').value = Array.isArray(user.permissions) ? user.permissions.join(',') : 'all';
        }

        function deleteUser(id) {
            const user = db.users.find(u => u.id === id);
            if (!user) return;

            openConfirmModal(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${user.name}"ØŸ`, () => {
                db.users = db.users.filter(u => u.id !== id);
                saveData();
                renderUsersTable();
                showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.");
            });
        }

        function resetUserForm() {
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.getElementById('user-form-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯';
        }

        function setupUserFormListener() {
            document.getElementById('user-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const userId = document.getElementById('user-id').value;
                const permissions = document.getElementById('user-permissions').value.split(',').map(p => p.trim()).filter(Boolean);
                
                const userData = {
                    name: document.getElementById('user-fullname').value,
                    username: document.getElementById('user-username').value,
                    password: document.getElementById('user-password').value,
                    permissions: permissions.includes('all') ? ['all'] : permissions,
                    isDeveloper: false
                };

                if (userId) {
                    const userIndex = db.users.findIndex(u => u.id == userId);
                    if (userIndex > -1) {
                        userData.isDeveloper = db.users[userIndex].isDeveloper; 
                        userData.id = parseInt(userId);
                        db.users[userIndex] = userData;
                        showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.");
                    }
                } else {
                    const maxId = Math.max(0, ...db.users.map(u => u.id));
                    userData.id = maxId + 1;
                    db.users.push(userData);
                    showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.");
                }
                
                saveData();
                renderUsersTable();
                resetUserForm();
            });
        }
        
        function openAddSupplierPaymentModal(supplierId) {
            const supplier = db.suppliers.find(s => s.id === supplierId);
            if (!supplier) return;
            
            document.getElementById('addSupplierPaymentForm').reset();
            document.getElementById('paymentSupplierId').value = supplier.id;
            document.getElementById('paymentSupplierName').textContent = supplier.name;
            document.getElementById('paymentDate').value = getTodayDate();
            openModal('addSupplierPaymentModal');
        }

        function setupSupplierPaymentFormListener() {
            document.getElementById('addSupplierPaymentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const supplierId = parseInt(document.getElementById('paymentSupplierId').value);
                const amount = parseFloat(document.getElementById('paymentAmount').value);
                const supplier = db.suppliers.find(s => s.id === supplierId);

                const newPayment = {
                    id: getNextId('supplierPayments'),
                    supplierId: supplierId,
                    amount: amount,
                    date: document.getElementById('paymentDate').value,
                    notes: document.getElementById('paymentNotes').value,
                    createdBy: currentUser.name
                };

                db.supplierPayments.push(newPayment);
                logActivity(`ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ù„Ù„Ù…ÙˆØ±Ø¯ "${supplier.name}" Ø¨Ù‚ÙŠÙ…Ø© ${formatCurrency(amount)}`);
                saveData();
                showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­.");
                closeModal('addSupplierPaymentModal');
                renderAll(); 
            });
        }
        
        function openEditSupplierPaymentModal(paymentId) {
            const payment = db.supplierPayments.find(p => p.id === paymentId);
            if (!payment) return;

            document.getElementById('editPaymentId').value = payment.id;
            document.getElementById('editPaymentAmount').value = payment.amount;
            document.getElementById('editPaymentDate').value = payment.date;
            document.getElementById('editPaymentNotes').value = payment.notes;

            openModal('editSupplierPaymentModal');
        }

        function setupEditSupplierPaymentListener() {
            document.getElementById('editSupplierPaymentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const paymentId = parseInt(document.getElementById('editPaymentId').value);
                const payment = db.supplierPayments.find(p => p.id === paymentId);
                const supplier = db.suppliers.find(s => s.id === payment.supplierId);

                if(payment) {
                    const oldAmount = payment.amount;
                    payment.amount = parseFloat(document.getElementById('editPaymentAmount').value);
                    payment.date = document.getElementById('editPaymentDate').value;
                    payment.notes = document.getElementById('editPaymentNotes').value;

                    logActivity(`ØªØ­Ø°ÙŠØ±: Ù‚Ø§Ù… Ø§Ù„Ù…Ø¯ÙŠØ± (${currentUser.name}) Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹Ø© Ù„Ù„Ù…ÙˆØ±Ø¯ "${supplier.name}". Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¯ÙŠÙ…: ${formatCurrency(oldAmount)}, Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${formatCurrency(payment.amount)}`);
                    saveData();
                    showToast("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­.");
                    closeModal('editSupplierPaymentModal');
                    closeModal('statementModal');
                    renderAll();
                }
            });
        }
    
        // ====== Ø¥Ù„ØºØ§Ø¡/Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ù…Ø¹ ØªØ­Ø°ÙŠØ±) ======
        function cancelPurchase() {
            if (confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆÙ„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                document.getElementById('addPurchaseForm')?.reset();
                closeModal('addPurchaseModal');
            }
        }

        // Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (ÙŠØ­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆÙƒÙ„ ØªÙØ§ØµÙŠÙ„Ù‡Ø§ + Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª) Ù…Ø¹ ØªØ­Ø°ÙŠØ± ÙˆØ§Ø¶Ø­
        function cancelPurchaseTransaction(carId) {
            const car = db.cars.find(c => c.id === carId);
            if (!car) return showToast('Ø§Ù„Ø³ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');

            if (car.status === CAR_STATUSES.SOLD) {
                showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù„ØºØ§Ø¡ Ø´Ø±Ø§Ø¡ Ø³ÙŠØ§Ø±Ø© ØªÙ… Ø¨ÙŠØ¹Ù‡Ø§. Ù‚Ù… Ø¨Ø¥Ø±Ø¬Ø§Ø¹/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨ÙŠØ¹ Ø£ÙˆÙ„Ø§Ù‹.', 'error');
                return;
            }

            openConfirmModal(
                `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ Ø§Ù„Ø³ÙŠØ§Ø±Ø© "${car.carType} ${car.carModel}"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆÙƒÙ„ ØªÙØ§ØµÙŠÙ„Ù‡Ø§ ÙˆØ³Ø¬Ù„Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`,
                () => {
                    const maintenanceIdsToDelete = db.maintenanceLog.filter(m => m.carId === carId).map(m => m.id);

                    // Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø© + Ø§Ù„ØµÙŠØ§Ù†Ø© + Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
                    db.cars = db.cars.filter(c => c.id !== carId);
                    db.maintenanceLog = db.maintenanceLog.filter(m => m.carId !== carId);
                    db.expenses = db.expenses.filter(exp => !exp.maintenanceLogId || !maintenanceIdsToDelete.includes(exp.maintenanceLogId));

                    // Ø­Ø°Ù Ø£ÙŠ Ø¹Ø±ÙˆØ¶ Ø£Ø³Ø¹Ø§Ø± Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)
                    if (db.quotes) db.quotes = db.quotes.filter(q => q.carId !== carId);

                    // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª
                    if (db.carDocs && db.carDocs[String(carId)]) delete db.carDocs[String(carId)];

                    saveData();
                    renderAll(document.getElementById('globalSearch')?.value || '');
                    showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©.');
                    logActivity(`Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${car.carType} ${car.carModel} (Ù…Ù„Ù #${car.fileNumber || car.id})`);
                }
            );
        }

        function cancelSale() {
            if (confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹ ÙˆÙ„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                document.getElementById('addSaleForm')?.reset();
                closeModal('addSaleModal');
            }
        }

        // ====== Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© ======
        const CAR_DOC_TYPES = [
            { key: 'license', title: 'ØµÙˆØ±Ø© Ø§Ù„Ø±Ø®ØµØ©', required: true },
            { key: 'carPhoto', title: 'ØµÙˆØ±Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©', required: true },
            { key: 'preContract', title: 'Ø¹Ù‚Ø¯ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', required: false },
            { key: 'buyerId', title: 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠ', required: true },
            { key: 'sellerId', title: 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹', required: true },
            { key: 'registeredContract', title: 'Ø¹Ù‚Ø¯ Ù…Ø³Ø¬Ù„', required: false },
            { key: 'violations', title: 'Ù…Ø®Ø§Ù„ÙØ§Øª', required: false },
            { key: 'orgTax', title: 'Ù…Ø¤Ø³Ø³Ø© + Ø¶Ø±ÙŠØ¨ÙŠØ©', required: false },
            { key: 'other', title: 'Ø£Ø®Ø±Ù‰', required: false },
        ];

        function ensureCarDocsBucket(carId) {
            if (!db.carDocs) db.carDocs = {};
            if (!db.carDocs[carId]) {
                db.carDocs[carId] = {};
            }
            CAR_DOC_TYPES.forEach(d => {
                if (!db.carDocs[carId][d.key]) db.carDocs[carId][d.key] = [];
            });
        }

        function openCarDocsModal(carId) {
            const car = db.cars.find(c => c.id === carId);
            if (!car) return showToast('Ø§Ù„Ø³ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
            ensureCarDocsBucket(String(carId));

            document.getElementById('carDocsCarTitle').textContent = `${car.carType} ${car.carModel} - Ù…Ù„Ù #${car.fileNumber || car.id}`;
            const list = document.getElementById('carDocsList');
            list.innerHTML = '';

            CAR_DOC_TYPES.forEach(doc => {
                const files = db.carDocs[String(carId)][doc.key] || [];
                const uploaded = files.length > 0;

                const card = document.createElement('div');
                card.className = 'p-4 border rounded-lg bg-white flex flex-col md:flex-row md:items-center md:justify-between gap-3';

                const right = document.createElement('div');
                right.className = 'flex-1';
                right.innerHTML = `
                    <div class="font-semibold">
                        ${doc.title}
                        ${doc.required
                            ? '<span class="text-red-600 text-sm">(Ù…Ø·Ù„ÙˆØ¨)</span>'
                            : '<span class="text-gray-500 text-sm">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>'}
                    </div>
                    <div class="text-sm ${
                        uploaded ? 'text-emerald-600' : (doc.required ? 'text-red-600' : 'text-gray-500')
                    }">${
                        uploaded ? 'âœ“ ØªÙ… Ø§Ù„Ø±ÙØ¹' : (doc.required ? 'Ù…Ø·Ù„ÙˆØ¨' : 'Ø§Ø®ØªÙŠØ§Ø±ÙŠ')
                    }</div>
                `;

                const left = document.createElement('div');
                left.className = 'flex items-center gap-2';

                const uploadBtn = document.createElement('button');
                uploadBtn.className = 'px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700';
                uploadBtn.textContent = 'Ø±ÙØ¹ Ù…Ù„Ù';
                uploadBtn.onclick = () => {
                    const inp = document.createElement('input');
                    inp.type = 'file';
                    inp.accept = 'image/*,.pdf,.doc,.docx,.xls,.xlsx';
                    inp.onchange = (e) => handleCarDocUpload(carId, doc.key, e.target.files?.[0]);
                    inp.click();
                };

                left.appendChild(uploadBtn);

                if (uploaded) {
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300';
                    viewBtn.textContent = 'Ù…Ø¹Ø§ÙŠÙ†Ø©';
                    viewBtn.onclick = () => openCarDocViewer(files[files.length - 1]);

                    const delBtn = document.createElement('button');
                    delBtn.className = 'px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700';
                    delBtn.textContent = 'Ø­Ø°Ù';
                    delBtn.onclick = () => {
                        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¢Ø®Ø± Ù…Ù„Ù Ù…Ø±ÙÙˆØ¹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ØŸ')) return;
                        files.pop();
                        db.carDocs[String(carId)][doc.key] = files;
                        saveData();
                        openCarDocsModal(carId);
                    };

                    left.appendChild(viewBtn);
                    left.appendChild(delBtn);
                }

                card.appendChild(right);
                card.appendChild(left);
                list.appendChild(card);
            });

            openModal('carDocsModal');
        }

        function handleCarDocUpload(carId, docKey, file) {
            if (!file) return;
            ensureCarDocsBucket(String(carId));

            const reader = new FileReader();
            reader.onload = () => {
                const entry = {
                    name: file.name,
                    type: file.type || 'application/octet-stream',
                    dataUrl: reader.result,
                    uploadedAt: new Date().toISOString(),
                    uploadedBy: currentUser?.name || 'system'
                };
                db.carDocs[String(carId)][docKey].push(entry);
                saveData();
                showToast('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­');
                openCarDocsModal(carId);
            };
            reader.onerror = () => showToast('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù', 'error');
            reader.readAsDataURL(file);
        }

        function openCarDocViewer(fileEntry) {
            if (!fileEntry?.dataUrl) return;
            const w = window.open();
            if (!w) return showToast('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©', 'error');
            const safeName = (fileEntry.name || 'file').replace(/[<>]/g, '');
            w.document.write(`<title>${safeName}</title>`);
            if ((fileEntry.type || '').startsWith('image/')) {
                w.document.write(`<img src="${fileEntry.dataUrl}" style="max-width:100%;height:auto"/>`);
            } else {
                w.document.write(`<iframe src="${fileEntry.dataUrl}" style="width:100%;height:100vh;border:0"></iframe>`);
            }
            w.document.close();
        }

        // ====== Ø¯ÙØ¹Ø§Øª (ØªØ­Ø¯ÙŠØ¯ ÙŠØ¯ÙˆÙŠ) ======
        function addManualPaymentRow(dateVal = '', amountVal = '') {
            const container = document.getElementById('manual-payments-rows');
            if (!container) return;
            const row = document.createElement('div');
            row.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 items-center';
            row.innerHTML = `
                <input type="date" class="manual-pay-date w-full p-2 border rounded" value="${dateVal}">
                <input type="number" step="any" class="manual-pay-amount w-full p-2 border rounded" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" value="${amountVal}">
                <button type="button" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Ø­Ø°Ù</button>
            `;
            row.querySelector('button').onclick = () => row.remove();
            container.appendChild(row);
        }

</script>

        <!-- ============ Custody Modal ============ -->
        <div id="custodyModal" class="modal">
            <div class="modal-content max-w-2xl">
                <span class="close-button" onclick="closeModal('custodyModal')">Ã—</span>
                <h3 class="text-xl font-bold mb-4">ØµØ±Ù Ø¹ÙÙ‡Ø¯Ø©</h3>
                <form id="custodyForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="custodyDate" class="input" required>
                        </div>
                        <div>
                            <label class="label">Ø§Ù„Ù…Ø³ØªÙ„Ù… (Ø§Ù„Ù…ÙˆØ¸Ù)</label>
                            <input type="text" id="custodyEmployee" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="label">Ø§Ù„Ø¨ÙŠØ§Ù†</label>
                            <input type="text" id="custodyStatement" class="input" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù‡Ø¯Ø© ØµÙŠØ§Ù†Ø© / Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø¹Ø±Ø¶ ..." required>
                        </div>
                        <div>
                            <label class="label">Ø§Ù„Ù‚ÙŠÙ…Ø©</label>
                            <input type="number" id="custodyAmount" class="input" min="0" step="0.001" required>
                        </div>
                        <div>
                            <label class="label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                            <select id="custodyStatus" class="input">
                                <option value="open">ÙÙŠ Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…ÙˆØ¸Ù</option>
                                <option value="settled">ØªÙ… ØªØ³ÙˆÙŠØªÙ‡Ø§ (Ø£Ø±Ø´ÙŠÙ)</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                            <textarea id="custodyNotes" class="input" rows="3" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="w-full btn-primary">Ø­ÙØ¸</button>
                </form>
            </div>
        </div>

<!-- Showroom & Employees Modal (Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ø¶ ÙˆÙ…ÙˆØ¸ÙÙŠ Ø§Ù„Ø¨ÙŠØ¹) -->
<div id="showroomEmployeesModal" class="modal">
  <div class="modal-content max-w-3xl">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-bold">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ø¶ ÙˆÙ…ÙˆØ¸ÙÙŠ Ø§Ù„Ø¨ÙŠØ¹ (3 Ù…ÙˆØ¸ÙÙŠÙ†)</h2>
      <button class="text-2xl font-bold" onclick="closeModal('showroomEmployeesModal')">&times;</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-bold mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±Ø¶</label>
        <input id="cpName" class="w-full p-2 border rounded" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±Ø¶">
      </div>
      <div>
        <label class="block text-sm font-bold mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
        <input id="cpAddress" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
      </div>
      <div>
        <label class="block text-sm font-bold mb-1">Ù‡Ø§ØªÙ 1</label>
        <input id="cpPhone1" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø£ÙˆÙ„">
      </div>
      <div>
        <label class="block text-sm font-bold mb-1">Ù‡Ø§ØªÙ 2</label>
        <input id="cpPhone2" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø«Ø§Ù†ÙŠ">
      </div>
    </div>

    <div class="mt-4 font-bold">Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</div>
    <div class="grid grid-cols-1 gap-4 mt-2">
      <div class="border rounded p-3">
        <div class="font-bold mb-2">Ù…ÙˆØ¸Ù 1</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div><label class="block text-xs font-bold mb-1">Ø§Ù„Ø§Ø³Ù…</label><input id="emp1Name" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø§Ø³Ù…"></div>
          <div><label class="block text-xs font-bold mb-1">Ø§Ù„Ù‡Ø§ØªÙ</label><input id="emp1Phone" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ù‡Ø§ØªÙ"></div>
          <div><label class="block text-xs font-bold mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label><input id="emp1NID" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ"></div>
          <div><label class="block text-xs font-bold mb-1">Ø§Ù„Ù…Ù‡Ù†Ø©</label><input id="emp1Job" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ù…Ù‡Ù†Ø©"></div>
          <div class="md:col-span-2"><label class="block text-xs font-bold mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="emp1Address" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"></div>
        </div>
      </div>

      <div class="border rounded p-3">
        <div class="font-bold mb-2">Ù…ÙˆØ¸Ù 2</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div><label class="block text-xs font-bold mb-1">Ø§Ù„Ø§Ø³Ù…</label><input id="emp2Name" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø§Ø³Ù…"></div>
          <div><label class="block text-xs font-bold mb-1">Ø§Ù„Ù‡Ø§ØªÙ</label><input id="emp2Phone" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ù‡Ø§ØªÙ"></div>
          <div><label class="block text-xs font-bold mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label><input id="emp2NID" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ"></div>
          <div><label class="block text-xs font-bold mb-1">Ø§Ù„Ù…Ù‡Ù†Ø©</label><input id="emp2Job" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ù…Ù‡Ù†Ø©"></div>
          <div class="md:col-span-2"><label class="block text-xs font-bold mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="emp2Address" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"></div>
        </div>
      </div>

      <div class="border rounded p-3">
        <div class="font-bold mb-2">Ù…ÙˆØ¸Ù 3</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div><label class="block text-xs font-bold mb-1">Ø§Ù„Ø§Ø³Ù…</label><input id="emp3Name" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø§Ø³Ù…"></div>
          <div><label class="block text-xs font-bold mb-1">Ø§Ù„Ù‡Ø§ØªÙ</label><input id="emp3Phone" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ù‡Ø§ØªÙ"></div>
          <div><label class="block text-xs font-bold mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label><input id="emp3NID" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ"></div>
          <div><label class="block text-xs font-bold mb-1">Ø§Ù„Ù…Ù‡Ù†Ø©</label><input id="emp3Job" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ù…Ù‡Ù†Ø©"></div>
          <div class="md:col-span-2"><label class="block text-xs font-bold mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="emp3Address" class="w-full p-2 border rounded" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"></div>
        </div>
      </div>
    </div>

    <div class="flex gap-2 justify-end mt-4">
      <button class="bg-gray-100 hover:bg-gray-200 text-gray-900 font-bold py-2 px-4 rounded" onclick="closeModal('showroomEmployeesModal')">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="saveShowroomEmployees()">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

</body>
</html>
